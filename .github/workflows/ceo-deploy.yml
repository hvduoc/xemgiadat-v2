name: ðŸš€ Chá»‘t ÄÆ¡n (CEO Mode)

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'TÃªn nhÃ¡nh muá»‘n chá»‘t (Ä‘á»ƒ trá»‘ng = tá»± Ä‘á»™ng tÃ¬m copilot/... má»›i nháº¥t)'
        required: false
        type: string
      cleanup:
        description: 'XÃ³a nhÃ¡nh phá»¥ sau khi chá»‘t xong?'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to Main
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ðŸ” Detect Target Branch
        id: detect-branch
        run: |
          if [ -n "${{ inputs.branch_name }}" ]; then
            # User provided a branch name
            BRANCH_NAME="${{ inputs.branch_name }}"
            echo "Using user-provided branch: $BRANCH_NAME"
          else
            # Auto-detect the latest copilot branch
            echo "Auto-detecting latest copilot branch..."
            git fetch origin
            BRANCH_NAME=$(git branch -r --sort=-committerdate | grep 'origin/copilot/' | head -n 1 | sed 's/^[[:space:]]*origin\///' | tr -d ' ')
            
            if [ -z "$BRANCH_NAME" ]; then
              echo "âŒ Error: No copilot branch found!"
              exit 1
            fi
            
            echo "Found latest copilot branch: $BRANCH_NAME"
          fi
          
          # Save branch name for next steps
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Target branch: $BRANCH_NAME"
      
      - name: ðŸš€ Deploy to Main
        run: |
          BRANCH_NAME="${{ steps.detect-branch.outputs.branch_name }}"
          
          echo "ðŸ”„ Fetching branch: $BRANCH_NAME"
          git fetch origin "$BRANCH_NAME"
          
          echo "ðŸ“ Checking out main branch"
          git checkout main
          
          echo "ðŸŽ¯ Resetting main to $BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"
          
          echo "â¬†ï¸ Force pushing to main"
          git push origin main --force
          
          echo "âœ… Deployment completed successfully!"
      
      - name: ðŸ§¹ Cleanup Branch
        if: inputs.cleanup
        run: |
          BRANCH_NAME="${{ steps.detect-branch.outputs.branch_name }}"
          
          echo "ðŸ—‘ï¸ Deleting remote branch: $BRANCH_NAME"
          git push origin --delete "$BRANCH_NAME" || echo "âš ï¸ Branch already deleted or doesn't exist"
          
          echo "âœ… Cleanup completed!"
      
      - name: ðŸ“¢ Summary
        if: always()
        run: |
          BRANCH_NAME="${{ steps.detect-branch.outputs.branch_name }}"
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$BRANCH_NAME" ]; then
            echo "- **Target Branch:** $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Target Branch:** (detection failed)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Cleanup:** ${{ inputs.cleanup }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if git rev-parse --verify main >/dev/null 2>&1; then
            echo "### ðŸ“¦ Latest Commits on Main" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git log --oneline -5 main >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
