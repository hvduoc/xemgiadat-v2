(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();var X=Uint8Array,Te=Uint16Array,Pr=Int32Array,At=new X([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Et=new X([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ar=new X([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),It=function(r,e){for(var t=new Te(31),s=0;s<31;++s)t[s]=e+=1<<r[s-1];for(var a=new Pr(t[30]),s=1;s<30;++s)for(var i=t[s];i<t[s+1];++i)a[i]=i-t[s]<<5|s;return{b:t,r:a}},Mt=It(At,2),$t=Mt.b,Er=Mt.r;$t[28]=258,Er[258]=28;var Ir=It(Et,0),Mr=Ir.b,Je=new Te(32768);for(var N=0;N<32768;++N){var ge=(N&43690)>>1|(N&21845)<<1;ge=(ge&52428)>>2|(ge&13107)<<2,ge=(ge&61680)>>4|(ge&3855)<<4,Je[N]=((ge&65280)>>8|(ge&255)<<8)>>1}var Le=(function(r,e,t){for(var s=r.length,a=0,i=new Te(e);a<s;++a)r[a]&&++i[r[a]-1];var o=new Te(e);for(a=1;a<e;++a)o[a]=o[a-1]+i[a-1]<<1;var l;if(t){l=new Te(1<<e);var d=15-e;for(a=0;a<s;++a)if(r[a])for(var h=a<<4|r[a],u=e-r[a],c=o[r[a]-1]++<<u,g=c|(1<<u)-1;c<=g;++c)l[Je[c]>>d]=h}else for(l=new Te(s),a=0;a<s;++a)r[a]&&(l[a]=Je[o[r[a]-1]++]>>15-r[a]);return l}),Ee=new X(288);for(var N=0;N<144;++N)Ee[N]=8;for(var N=144;N<256;++N)Ee[N]=9;for(var N=256;N<280;++N)Ee[N]=7;for(var N=280;N<288;++N)Ee[N]=8;var Dt=new X(32);for(var N=0;N<32;++N)Dt[N]=5;var $r=Le(Ee,9,1),Dr=Le(Dt,5,1),Re=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},ae=function(r,e,t){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(e&7)&t},He=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},Br=function(r){return(r+7)/8|0},Ur=function(r,e,t){return(t==null||t>r.length)&&(t=r.length),new X(r.subarray(e,t))},zr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],J=function(r,e,t){var s=new Error(e||zr[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,J),!t)throw s;return s},tt=function(r,e,t,s){var a=r.length,i=0;if(!a||e.f&&!e.l)return t||new X(0);var o=!t,l=o||e.i!=2,d=e.i;o&&(t=new X(a*3));var h=function(me){var Z=t.length;if(me>Z){var ve=new X(Math.max(Z*2,me));ve.set(t),t=ve}},u=e.f||0,c=e.p||0,g=e.b||0,x=e.l,j=e.d,S=e.m,R=e.n,de=a*8;do{if(!x){u=ae(r,c,1);var b=ae(r,c+1,3);if(c+=3,b)if(b==1)x=$r,j=Dr,S=9,R=5;else if(b==2){var U=ae(r,c,31)+257,D=ae(r,c+10,15)+4,A=U+ae(r,c+5,31)+1;c+=14;for(var z=new X(A),H=new X(19),$=0;$<D;++$)H[Ar[$]]=ae(r,c+$*3,7);c+=D*3;for(var je=Re(H),V=(1<<je)-1,ne=Le(H,je,1),$=0;$<A;){var ee=ne[ae(r,c,V)];c+=ee&15;var T=ee>>4;if(T<16)z[$++]=T;else{var re=0,E=0;for(T==16?(E=3+ae(r,c,3),c+=2,re=z[$-1]):T==17?(E=3+ae(r,c,7),c+=3):T==18&&(E=11+ae(r,c,127),c+=7);E--;)z[$++]=re}}var he=z.subarray(0,U),O=z.subarray(U);S=Re(he),R=Re(O),x=Le(he,S,1),j=Le(O,R,1)}else J(1);else{var T=Br(c)+4,f=r[T-4]|r[T-3]<<8,Q=T+f;if(Q>a){d&&J(0);break}l&&h(g+f),t.set(r.subarray(T,Q),g),e.b=g+=f,e.p=c=Q*8,e.f=u;continue}if(c>de){d&&J(0);break}}l&&h(g+131072);for(var pe=(1<<S)-1,xe=(1<<R)-1,G=c;;G=c){var re=x[He(r,c)&pe],_=re>>4;if(c+=re&15,c>de){d&&J(0);break}if(re||J(2),_<256)t[g++]=_;else if(_==256){G=c,x=null;break}else{var ue=_-254;if(_>264){var $=_-257,P=At[$];ue=ae(r,c,(1<<P)-1)+$t[$],c+=P}var oe=j[He(r,c)&xe],se=oe>>4;oe||J(3),c+=oe&15;var O=Mr[se];if(se>3){var P=Et[se];O+=He(r,c)&(1<<P)-1,c+=P}if(c>de){d&&J(0);break}l&&h(g+131072);var C=g+ue;if(g<O){var te=i-O,be=Math.min(O,C);for(te+g<0&&J(3);g<be;++g)t[g]=s[te+g]}for(;g<C;++g)t[g]=t[g-O]}}e.l=x,e.p=G,e.b=g,e.f=u,x&&(u=1,e.m=S,e.d=j,e.n=R)}while(!u);return g!=t.length&&o?Ur(t,0,g):t.subarray(0,g)},Or=new X(0),Fr=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&J(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var s=(e>>3&1)+(e>>4&1);s>0;s-=!r[t++]);return t+(e&2)},Rr=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},Hr=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&J(6,"invalid zlib data"),(r[1]>>5&1)==1&&J(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function Vr(r,e){return tt(r,{i:2},e,e)}function Gr(r,e){var t=Fr(r);return t+8>r.length&&J(6,"invalid gzip data"),tt(r.subarray(t,-8),{i:2},new X(Rr(r)),e)}function Zr(r,e){return tt(r.subarray(Hr(r),-4),{i:2},e,e)}function Kr(r,e){return r[0]==31&&r[1]==139&&r[2]==8?Gr(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?Vr(r,e):Zr(r,e)}var Wr=typeof TextDecoder<"u"&&new TextDecoder,Jr=0;try{Wr.decode(Or,{stream:!0}),Jr=1}catch{}var qr=Object.defineProperty,Se=Math.pow,y=(r,e)=>qr(r,"name",{value:e,configurable:!0}),I=(r,e,t)=>new Promise((s,a)=>{var i=d=>{try{l(t.next(d))}catch(h){a(h)}},o=d=>{try{l(t.throw(d))}catch(h){a(h)}},l=d=>d.done?s(d.value):Promise.resolve(d.value).then(i,o);l((t=t.apply(r,e)).next())}),Xr=y((r,e)=>{let t=!1,s="",a=L.GridLayer.extend({createTile:y((i,o)=>{let l=document.createElement("img"),d=new AbortController,h=d.signal;return l.cancel=()=>{d.abort()},t||(r.getHeader().then(u=>{u.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):u.tileType===2?s="image/png":u.tileType===3?s="image/jpeg":u.tileType===4?s="image/webp":u.tileType===5&&(s="image/avif")}),t=!0),r.getZxy(i.z,i.x,i.y,h).then(u=>{if(u){let c=new Blob([u.data],{type:s}),g=window.URL.createObjectURL(c);l.src=g,l.cancel=void 0,o(void 0,l)}}).catch(u=>{if(u.name!=="AbortError")throw u}),l},"createTile"),_removeTile:y(function(i){let o=this._tiles[i];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[i],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(i)}))},"_removeTile")});return new a(e)},"leafletRasterLayer"),Yr=y(r=>(e,t)=>{if(t instanceof AbortController)return r(e,t);let s=new AbortController;return r(e,s).then(a=>t(void 0,a.data,a.cacheControl||"",a.expires||""),a=>t(a)).catch(a=>t(a)),{cancel:y(()=>s.abort(),"cancel")}},"v3compat"),Bt=class{constructor(e){this.tilev4=y((t,s)=>I(this,null,function*(){if(t.type==="json"){let x=t.url.substr(10),j=this.tiles.get(x);if(j||(j=new Xe(x),this.tiles.set(x,j)),this.metadata)return{data:yield j.getTileJson(t.url)};let S=yield j.getHeader();return{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:S.minZoom,maxzoom:S.maxZoom,bounds:[S.minLon,S.minLat,S.maxLon,S.maxLat]}}}let a=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),i=t.url.match(a);if(!i)throw new Error("Invalid PMTiles protocol URL");let o=i[1],l=this.tiles.get(o);l||(l=new Xe(o),this.tiles.set(o,l));let d=i[2],h=i[3],u=i[4],c=yield l.getHeader(),g=yield l==null?void 0:l.getZxy(+d,+h,+u,s.signal);return g?{data:new Uint8Array(g.data),cacheControl:g.cacheControl,expires:g.expires}:c.tileType===1?{data:new Uint8Array}:{data:null}}),"tilev4"),this.tile=Yr(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};y(Bt,"Protocol");var qe=Bt;function Ut(r,e){return(e>>>0)*4294967296+(r>>>0)}y(Ut,"toNum");function zt(r,e){let t=e.buf,s=t[e.pos++],a=(s&112)>>4;if(s<128||(s=t[e.pos++],a|=(s&127)<<3,s<128)||(s=t[e.pos++],a|=(s&127)<<10,s<128)||(s=t[e.pos++],a|=(s&127)<<17,s<128)||(s=t[e.pos++],a|=(s&127)<<24,s<128)||(s=t[e.pos++],a|=(s&1)<<31,s<128))return Ut(r,a);throw new Error("Expected varint not more than 10 bytes")}y(zt,"readVarintRemainder");function ye(r){let e=r.buf,t=e[r.pos++],s=t&127;return t<128||(t=e[r.pos++],s|=(t&127)<<7,t<128)||(t=e[r.pos++],s|=(t&127)<<14,t<128)||(t=e[r.pos++],s|=(t&127)<<21,t<128)?s:(t=e[r.pos],s|=(t&15)<<28,zt(s,r))}y(ye,"readVarint");function rt(r,e,t,s){if(s===0){t===1&&(e[0]=r-1-e[0],e[1]=r-1-e[1]);let a=e[0];e[0]=e[1],e[1]=a}}y(rt,"rotate");function Ot(r,e){let t=Se(2,r),s=e,a=e,i=e,o=[0,0],l=1;for(;l<t;)s=1&i/2,a=1&(i^s),rt(l,o,s,a),o[0]+=l*s,o[1]+=l*a,i=i/4,l*=2;return[r,o[0],o[1]]}y(Ot,"idOnLevel");var Qr=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function st(r,e,t){if(r>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Se(2,r)-1||t>Se(2,r)-1)throw Error("tile x/y outside zoom level bounds");let s=Qr[r],a=Se(2,r),i=0,o=0,l=0,d=[e,t],h=a/2;for(;h>0;)i=(d[0]&h)>0?1:0,o=(d[1]&h)>0?1:0,l+=h*h*(3*i^o),rt(h,d,i,o),h=h/2;return s+l}y(st,"zxyToTileId");function Ft(r){let e=0;for(let t=0;t<27;t++){let s=(1<<t)*(1<<t);if(e+s>r)return Ot(t,r-e);e+=s}throw Error("Tile zoom level exceeds max safe number limit (26)")}y(Ft,"tileIdToZxy");var Rt=(r=>(r[r.Unknown=0]="Unknown",r[r.None=1]="None",r[r.Gzip=2]="Gzip",r[r.Brotli=3]="Brotli",r[r.Zstd=4]="Zstd",r))(Rt||{});function ze(r,e){return I(this,null,function*(){if(e===1||e===0)return r;if(e===2){if(typeof globalThis.DecompressionStream>"u")return Kr(new Uint8Array(r));let t=new Response(r).body;if(!t)throw Error("Failed to read response stream");let s=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(s).arrayBuffer()}throw Error("Compression method not supported")})}y(ze,"defaultDecompress");var Ht=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(Ht||{});function at(r){return r===1?".mvt":r===2?".png":r===3?".jpg":r===4?".webp":r===5?".avif":""}y(at,"tileTypeExt");var es=127;function it(r,e){let t=0,s=r.length-1;for(;t<=s;){let a=s+t>>1,i=e-r[a].tileId;if(i>0)t=a+1;else if(i<0)s=a-1;else return r[a]}return s>=0&&(r[s].runLength===0||e-r[s].tileId<r[s].runLength)?r[s]:null}y(it,"findTile");var Vt=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return I(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};y(Vt,"FileSource");var ts=Vt,Gt=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let s="";"navigator"in globalThis&&(s=globalThis.navigator.userAgent||"");let a=s.indexOf("Windows")>-1,i=/Chrome|Chromium|Edg|OPR|Brave/.test(s);this.chromeWindowsNoCache=!1,a&&i&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,s,a){return I(this,null,function*(){let i,o;s?o=s:(i=new AbortController,o=i.signal);let l=new Headers(this.customHeaders);l.set("range",`bytes=${e}-${e+t-1}`);let d;this.mustReload?d="reload":this.chromeWindowsNoCache&&(d="no-store");let h=yield fetch(this.url,{signal:o,cache:d,headers:l});if(e===0&&h.status===416){let g=h.headers.get("Content-Range");if(!g||!g.startsWith("bytes */"))throw Error("Missing content-length on 416 response");let x=+g.substr(8);h=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${x-1}`}})}let u=h.headers.get("Etag");if(u!=null&&u.startsWith("W/")&&(u=null),h.status===416||a&&u&&u!==a)throw this.mustReload=!0,new Be(`Server returned non-matching ETag ${a} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(h.status>=300)throw Error(`Bad response code: ${h.status}`);let c=h.headers.get("Content-Length");if(h.status===200&&(!c||+c>t))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield h.arrayBuffer(),etag:u||void 0,cacheControl:h.headers.get("Cache-Control")||void 0,expires:h.headers.get("Expires")||void 0}})}};y(Gt,"FetchSource");var Zt=Gt;function K(r,e){let t=r.getUint32(e+4,!0),s=r.getUint32(e+0,!0);return t*Se(2,32)+s}y(K,"getUint64");function nt(r,e){let t=new DataView(r),s=t.getUint8(7);if(s>3)throw Error(`Archive is spec version ${s} but this library supports up to spec version 3`);return{specVersion:s,rootDirectoryOffset:K(t,8),rootDirectoryLength:K(t,16),jsonMetadataOffset:K(t,24),jsonMetadataLength:K(t,32),leafDirectoryOffset:K(t,40),leafDirectoryLength:K(t,48),tileDataOffset:K(t,56),tileDataLength:K(t,64),numAddressedTiles:K(t,72),numTileEntries:K(t,80),numTileContents:K(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}y(nt,"bytesToHeader");function ot(r){let e={buf:new Uint8Array(r),pos:0},t=ye(e),s=[],a=0;for(let i=0;i<t;i++){let o=ye(e);s.push({tileId:a+o,offset:0,length:0,runLength:1}),a+=o}for(let i=0;i<t;i++)s[i].runLength=ye(e);for(let i=0;i<t;i++)s[i].length=ye(e);for(let i=0;i<t;i++){let o=ye(e);o===0&&i>0?s[i].offset=s[i-1].offset+s[i-1].length:s[i].offset=o-1}return s}y(ot,"deserializeIndex");var Kt=class extends Error{};y(Kt,"EtagMismatch");var Be=Kt;function lt(r,e){return I(this,null,function*(){let t=yield r.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let s=t.data.slice(0,es),a=nt(s,t.etag),i=t.data.slice(a.rootDirectoryOffset,a.rootDirectoryOffset+a.rootDirectoryLength),o=`${r.getKey()}|${a.etag||""}|${a.rootDirectoryOffset}|${a.rootDirectoryLength}`,l=ot(yield e(i,a.internalCompression));return[a,[o,l.length,l]]})}y(lt,"getHeaderAndRoot");function ct(r,e,t,s,a){return I(this,null,function*(){let i=yield r.getBytes(t,s,void 0,a.etag),o=yield e(i.data,a.internalCompression),l=ot(o);if(l.length===0)throw new Error("Empty directory is invalid");return l})}y(ct,"getDirectory");var Wt=class{constructor(e=100,t=!0,s=ze){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=s}getHeader(e){return I(this,null,function*(){let t=e.getKey(),s=this.cache.get(t);if(s)return s.lastUsed=this.counter++,s.data;let a=yield lt(e,this.decompress);return a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:a[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:a[0]}),this.prune(),a[0]})}getDirectory(e,t,s,a){return I(this,null,function*(){let i=`${e.getKey()}|${a.etag||""}|${t}|${s}`,o=this.cache.get(i);if(o)return o.lastUsed=this.counter++,o.data;let l=yield ct(e,this.decompress,t,s,a);return this.cache.set(i,{lastUsed:this.counter++,data:l}),this.prune(),l})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((s,a)=>{s.lastUsed<e&&(e=s.lastUsed,t=a)}),t&&this.cache.delete(t)}}invalidate(e){return I(this,null,function*(){this.cache.delete(e.getKey())})}};y(Wt,"ResolvedValueCache");var rs=Wt,Jt=class{constructor(e=100,t=!0,s=ze){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=s}getHeader(e){return I(this,null,function*(){let t=e.getKey(),s=this.cache.get(t);if(s)return s.lastUsed=this.counter++,yield s.data;let a=new Promise((i,o)=>{lt(e,this.decompress).then(l=>{l[1]&&this.cache.set(l[1][0],{lastUsed:this.counter++,data:Promise.resolve(l[1][2])}),i(l[0]),this.prune()}).catch(l=>{o(l)})});return this.cache.set(t,{lastUsed:this.counter++,data:a}),a})}getDirectory(e,t,s,a){return I(this,null,function*(){let i=`${e.getKey()}|${a.etag||""}|${t}|${s}`,o=this.cache.get(i);if(o)return o.lastUsed=this.counter++,yield o.data;let l=new Promise((d,h)=>{ct(e,this.decompress,t,s,a).then(u=>{d(u),this.prune()}).catch(u=>{h(u)})});return this.cache.set(i,{lastUsed:this.counter++,data:l}),l})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((s,a)=>{s.lastUsed<e&&(e=s.lastUsed,t=a)}),t&&this.cache.delete(t)}}invalidate(e){return I(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let s=new Promise((a,i)=>{this.getHeader(e).then(o=>{a(),this.invalidations.delete(t)}).catch(o=>{i(o)})});this.invalidations.set(t,s)})}};y(Jt,"SharedPromiseCache");var qt=Jt,Xt=class{constructor(e,t,s){typeof e=="string"?this.source=new Zt(e):this.source=e,s?this.decompress=s:this.decompress=ze,t?this.cache=t:this.cache=new qt}getHeader(){return I(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,s,a){return I(this,null,function*(){let i=st(e,t,s),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let l=o.rootDirectoryOffset,d=o.rootDirectoryLength;for(let h=0;h<=3;h++){let u=yield this.cache.getDirectory(this.source,l,d,o),c=it(u,i);if(c){if(c.runLength>0){let g=yield this.source.getBytes(o.tileDataOffset+c.offset,c.length,a,o.etag);return{data:yield this.decompress(g.data,o.tileCompression),cacheControl:g.cacheControl,expires:g.expires}}l=o.leafDirectoryOffset+c.offset,d=c.length}else return}throw Error("Maximum directory depth exceeded")})}getZxy(e,t,s,a){return I(this,null,function*(){try{return yield this.getZxyAttempt(e,t,s,a)}catch(i){if(i instanceof Be)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,s,a);throw i}})}getMetadataAttempt(){return I(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),s=yield this.decompress(t.data,e.internalCompression),a=new TextDecoder("utf-8");return JSON.parse(a.decode(s))})}getMetadata(){return I(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof Be)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return I(this,null,function*(){let t=yield this.getHeader(),s=yield this.getMetadata(),a=at(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${a}`],vector_layers:s.vector_layers,attribution:s.attribution,description:s.description,name:s.name,version:s.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};y(Xt,"PMTiles");var Xe=Xt;const Yt=Object.freeze(Object.defineProperty({__proto__:null,Compression:Rt,EtagMismatch:Be,FetchSource:Zt,FileSource:ts,PMTiles:Xe,Protocol:qe,ResolvedValueCache:rs,SharedPromiseCache:qt,TileType:Ht,bytesToHeader:nt,findTile:it,getUint64:K,leafletRasterLayer:Xr,readVarint:ye,tileIdToZxy:Ft,tileTypeExt:at,zxyToTileId:st},Symbol.toStringTag,{value:"Module"}));window.pmtiles=Yt;window.__trackCDN("pmtiles",!0);console.log("[PMTiles] ✓ Loaded via ES module:",Yt);if(window.maplibregl){const r=new qe;window.maplibregl.addProtocol("pmtiles",r.tile),window.__pmtiles_registered=!0,console.log("[PMTiles] ✓ Protocol registered")}else{const r=setInterval(()=>{if(window.maplibregl){clearInterval(r);const e=new qe;window.maplibregl.addProtocol("pmtiles",e.tile),window.__pmtiles_registered=!0,console.log("[PMTiles] ✓ Protocol registered (delayed)")}},100)}(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();var Y=Uint8Array,_e=Uint16Array,ss=Int32Array,Qt=new Y([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),er=new Y([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),as=new Y([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tr=function(r,e){for(var t=new _e(31),s=0;s<31;++s)t[s]=e+=1<<r[s-1];for(var a=new ss(t[30]),s=1;s<30;++s)for(var i=t[s];i<t[s+1];++i)a[i]=i-t[s]<<5|s;return{b:t,r:a}},rr=tr(Qt,2),sr=rr.b,is=rr.r;sr[28]=258,is[258]=28;var ns=tr(er,0),os=ns.b,ar=new _e(32768);for(var k=0;k<32768;++k){var fe=(k&43690)>>1|(k&21845)<<1;fe=(fe&52428)>>2|(fe&13107)<<2,fe=(fe&61680)>>4|(fe&3855)<<4,ar[k]=((fe&65280)>>8|(fe&255)<<8)>>1}var Pe=(function(r,e,t){for(var s=r.length,a=0,i=new _e(e);a<s;++a)r[a]&&++i[r[a]-1];var o=new _e(e);for(a=1;a<e;++a)o[a]=o[a-1]+i[a-1]<<1;var l;{l=new _e(1<<e);var d=15-e;for(a=0;a<s;++a)if(r[a])for(var h=a<<4|r[a],u=e-r[a],c=o[r[a]-1]++<<u,g=c|(1<<u)-1;c<=g;++c)l[ar[c]>>d]=h}return l}),Ie=new Y(288);for(var k=0;k<144;++k)Ie[k]=8;for(var k=144;k<256;++k)Ie[k]=9;for(var k=256;k<280;++k)Ie[k]=7;for(var k=280;k<288;++k)Ie[k]=8;var ir=new Y(32);for(var k=0;k<32;++k)ir[k]=5;var ls=Pe(Ie,9),cs=Pe(ir,5),Ve=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},ie=function(r,e,t){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(e&7)&t},Ge=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},ds=function(r){return(r+7)/8|0},hs=function(r,e,t){return(t==null||t>r.length)&&(t=r.length),new Y(r.subarray(e,t))},us=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],q=function(r,e,t){var s=new Error(e||us[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,q),!t)throw s;return s},dt=function(r,e,t,s){var a=r.length,i=0;if(!a||e.f&&!e.l)return t||new Y(0);var o=!t,l=o||e.i!=2,d=e.i;o&&(t=new Y(a*3));var h=function(me){var Z=t.length;if(me>Z){var ve=new Y(Math.max(Z*2,me));ve.set(t),t=ve}},u=e.f||0,c=e.p||0,g=e.b||0,x=e.l,j=e.d,S=e.m,R=e.n,de=a*8;do{if(!x){u=ie(r,c,1);var b=ie(r,c+1,3);if(c+=3,b)if(b==1)x=ls,j=cs,S=9,R=5;else if(b==2){var T=ie(r,c,31)+257,f=ie(r,c+10,15)+4,Q=T+ie(r,c+5,31)+1;c+=14;for(var U=new Y(Q),D=new Y(19),A=0;A<f;++A)D[as[A]]=ie(r,c+A*3,7);c+=f*3;for(var z=Ve(D),H=(1<<z)-1,$=Pe(D,z),A=0;A<Q;){var je=$[ie(r,c,H)];c+=je&15;var V=je>>4;if(V<16)U[A++]=V;else{var ne=0,ee=0;for(V==16?(ee=3+ie(r,c,3),c+=2,ne=U[A-1]):V==17?(ee=3+ie(r,c,7),c+=3):V==18&&(ee=11+ie(r,c,127),c+=7);ee--;)U[A++]=ne}}var re=U.subarray(0,T),E=U.subarray(T);S=Ve(re),R=Ve(E),x=Pe(re,S),j=Pe(E,R)}else q(1);else{var V=ds(c)+4,he=r[V-4]|r[V-3]<<8,O=V+he;if(O>a){d&&q(0);break}l&&h(g+he),t.set(r.subarray(V,O),g),e.b=g+=he,e.p=c=O*8,e.f=u;continue}if(c>de){d&&q(0);break}}l&&h(g+131072);for(var pe=(1<<S)-1,xe=(1<<R)-1,G=c;;G=c){var ne=x[Ge(r,c)&pe],_=ne>>4;if(c+=ne&15,c>de){d&&q(0);break}if(ne||q(2),_<256)t[g++]=_;else if(_==256){G=c,x=null;break}else{var ue=_-254;if(_>264){var A=_-257,P=Qt[A];ue=ie(r,c,(1<<P)-1)+sr[A],c+=P}var oe=j[Ge(r,c)&xe],se=oe>>4;oe||q(3),c+=oe&15;var E=os[se];if(se>3){var P=er[se];E+=Ge(r,c)&(1<<P)-1,c+=P}if(c>de){d&&q(0);break}l&&h(g+131072);var C=g+ue;if(g<E){var te=i-E,be=Math.min(E,C);for(te+g<0&&q(3);g<be;++g)t[g]=s[te+g]}for(;g<C;++g)t[g]=t[g-E]}}e.l=x,e.p=G,e.b=g,e.f=u,x&&(u=1,e.m=S,e.d=j,e.n=R)}while(!u);return g!=t.length&&o?hs(t,0,g):t.subarray(0,g)},ms=new Y(0),gs=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&q(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var s=(e>>3&1)+(e>>4&1);s>0;s-=!r[t++]);return t+(e&2)},fs=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},ps=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&q(6,"invalid zlib data"),(r[1]>>5&1)==1&&q(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function xs(r,e){return dt(r,{i:2},e,e)}function bs(r,e){var t=gs(r);return t+8>r.length&&q(6,"invalid gzip data"),dt(r.subarray(t,-8),{i:2},new Y(fs(r)),e)}function vs(r,e){return dt(r.subarray(ps(r),-4),{i:2},e,e)}function ys(r,e){return r[0]==31&&r[1]==139&&r[2]==8?bs(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?xs(r,e):vs(r,e)}var ws=typeof TextDecoder<"u"&&new TextDecoder,js=0;try{ws.decode(ms,{stream:!0}),js=1}catch{}var Ns=Object.defineProperty,Ae=Math.pow,w=(r,e)=>Ns(r,"name",{value:e,configurable:!0}),M=(r,e,t)=>new Promise((s,a)=>{var i=d=>{try{l(t.next(d))}catch(h){a(h)}},o=d=>{try{l(t.throw(d))}catch(h){a(h)}},l=d=>d.done?s(d.value):Promise.resolve(d.value).then(i,o);l((t=t.apply(r,e)).next())}),ks=w((r,e)=>{let t=!1,s="",a=L.GridLayer.extend({createTile:w((i,o)=>{let l=document.createElement("img"),d=new AbortController,h=d.signal;return l.cancel=()=>{d.abort()},t||(r.getHeader().then(u=>{u.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):u.tileType===2?s="image/png":u.tileType===3?s="image/jpeg":u.tileType===4?s="image/webp":u.tileType===5&&(s="image/avif")}),t=!0),r.getZxy(i.z,i.x,i.y,h).then(u=>{if(u){let c=new Blob([u.data],{type:s}),g=window.URL.createObjectURL(c);l.src=g,l.cancel=void 0,o(void 0,l)}}).catch(u=>{if(u.name!=="AbortError")throw u}),l},"createTile"),_removeTile:w(function(i){let o=this._tiles[i];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[i],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(i)}))},"_removeTile")});return new a(e)},"leafletRasterLayer"),Ts=w(r=>(e,t)=>{if(t instanceof AbortController)return r(e,t);let s=new AbortController;return r(e,s).then(a=>t(void 0,a.data,a.cacheControl||"",a.expires||""),a=>t(a)).catch(a=>t(a)),{cancel:w(()=>s.abort(),"cancel")}},"v3compat"),nr=class{constructor(r){this.tilev4=w((e,t)=>M(this,null,function*(){if(e.type==="json"){let g=e.url.substr(10),x=this.tiles.get(g);if(x||(x=new Qe(g),this.tiles.set(g,x)),this.metadata)return{data:yield x.getTileJson(e.url)};let j=yield x.getHeader();return{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:j.minZoom,maxzoom:j.maxZoom,bounds:[j.minLon,j.minLat,j.maxLon,j.maxLat]}}}let s=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),a=e.url.match(s);if(!a)throw new Error("Invalid PMTiles protocol URL");let i=a[1],o=this.tiles.get(i);o||(o=new Qe(i),this.tiles.set(i,o));let l=a[2],d=a[3],h=a[4],u=yield o.getHeader(),c=yield o==null?void 0:o.getZxy(+l,+d,+h,t.signal);return c?{data:new Uint8Array(c.data),cacheControl:c.cacheControl,expires:c.expires}:u.tileType===1?{data:new Uint8Array}:{data:null}}),"tilev4"),this.tile=Ts(this.tilev4),this.tiles=new Map,this.metadata=(r==null?void 0:r.metadata)||!1}add(r){this.tiles.set(r.source.getKey(),r)}get(r){return this.tiles.get(r)}};w(nr,"Protocol");var Ye=nr;function or(r,e){return(e>>>0)*4294967296+(r>>>0)}w(or,"toNum");function lr(r,e){let t=e.buf,s=t[e.pos++],a=(s&112)>>4;if(s<128||(s=t[e.pos++],a|=(s&127)<<3,s<128)||(s=t[e.pos++],a|=(s&127)<<10,s<128)||(s=t[e.pos++],a|=(s&127)<<17,s<128)||(s=t[e.pos++],a|=(s&127)<<24,s<128)||(s=t[e.pos++],a|=(s&1)<<31,s<128))return or(r,a);throw new Error("Expected varint not more than 10 bytes")}w(lr,"readVarintRemainder");function we(r){let e=r.buf,t=e[r.pos++],s=t&127;return t<128||(t=e[r.pos++],s|=(t&127)<<7,t<128)||(t=e[r.pos++],s|=(t&127)<<14,t<128)||(t=e[r.pos++],s|=(t&127)<<21,t<128)?s:(t=e[r.pos],s|=(t&15)<<28,lr(s,r))}w(we,"readVarint");function ht(r,e,t,s){if(s===0){t===1&&(e[0]=r-1-e[0],e[1]=r-1-e[1]);let a=e[0];e[0]=e[1],e[1]=a}}w(ht,"rotate");function cr(r,e){let t=Ae(2,r),s=e,a=e,i=e,o=[0,0],l=1;for(;l<t;)s=1&i/2,a=1&(i^s),ht(l,o,s,a),o[0]+=l*s,o[1]+=l*a,i=i/4,l*=2;return[r,o[0],o[1]]}w(cr,"idOnLevel");var Cs=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function ut(r,e,t){if(r>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Ae(2,r)-1||t>Ae(2,r)-1)throw Error("tile x/y outside zoom level bounds");let s=Cs[r],a=Ae(2,r),i=0,o=0,l=0,d=[e,t],h=a/2;for(;h>0;)i=(d[0]&h)>0?1:0,o=(d[1]&h)>0?1:0,l+=h*h*(3*i^o),ht(h,d,i,o),h=h/2;return s+l}w(ut,"zxyToTileId");function dr(r){let e=0;for(let t=0;t<27;t++){let s=(1<<t)*(1<<t);if(e+s>r)return cr(t,r-e);e+=s}throw Error("Tile zoom level exceeds max safe number limit (26)")}w(dr,"tileIdToZxy");var hr=(r=>(r[r.Unknown=0]="Unknown",r[r.None=1]="None",r[r.Gzip=2]="Gzip",r[r.Brotli=3]="Brotli",r[r.Zstd=4]="Zstd",r))(hr||{});function Oe(r,e){return M(this,null,function*(){if(e===1||e===0)return r;if(e===2){if(typeof globalThis.DecompressionStream>"u")return ys(new Uint8Array(r));let t=new Response(r).body;if(!t)throw Error("Failed to read response stream");let s=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(s).arrayBuffer()}throw Error("Compression method not supported")})}w(Oe,"defaultDecompress");var ur=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(ur||{});function mt(r){return r===1?".mvt":r===2?".png":r===3?".jpg":r===4?".webp":r===5?".avif":""}w(mt,"tileTypeExt");var Ls=127;function gt(r,e){let t=0,s=r.length-1;for(;t<=s;){let a=s+t>>1,i=e-r[a].tileId;if(i>0)t=a+1;else if(i<0)s=a-1;else return r[a]}return s>=0&&(r[s].runLength===0||e-r[s].tileId<r[s].runLength)?r[s]:null}w(gt,"findTile");var mr=class{constructor(r){this.file=r}getKey(){return this.file.name}getBytes(r,e){return M(this,null,function*(){return{data:yield this.file.slice(r,r+e).arrayBuffer()}})}};w(mr,"FileSource");var Ss=mr,gr=class{constructor(r,e=new Headers){this.url=r,this.customHeaders=e,this.mustReload=!1;let t="";"navigator"in globalThis&&(t=globalThis.navigator.userAgent||"");let s=t.indexOf("Windows")>-1,a=/Chrome|Chromium|Edg|OPR|Brave/.test(t);this.chromeWindowsNoCache=!1,s&&a&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(r){this.customHeaders=r}getBytes(r,e,t,s){return M(this,null,function*(){let a,i;t?i=t:(a=new AbortController,i=a.signal);let o=new Headers(this.customHeaders);o.set("range",`bytes=${r}-${r+e-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let d=yield fetch(this.url,{signal:i,cache:l,headers:o});if(r===0&&d.status===416){let c=d.headers.get("Content-Range");if(!c||!c.startsWith("bytes */"))throw Error("Missing content-length on 416 response");let g=+c.substr(8);d=yield fetch(this.url,{signal:i,cache:"reload",headers:{range:`bytes=0-${g-1}`}})}let h=d.headers.get("Etag");if(h!=null&&h.startsWith("W/")&&(h=null),d.status===416||s&&h&&h!==s)throw this.mustReload=!0,new Ue(`Server returned non-matching ETag ${s} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(d.status>=300)throw Error(`Bad response code: ${d.status}`);let u=d.headers.get("Content-Length");if(d.status===200&&(!u||+u>e))throw a&&a.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield d.arrayBuffer(),etag:h||void 0,cacheControl:d.headers.get("Cache-Control")||void 0,expires:d.headers.get("Expires")||void 0}})}};w(gr,"FetchSource");var fr=gr;function W(r,e){let t=r.getUint32(e+4,!0),s=r.getUint32(e+0,!0);return t*Ae(2,32)+s}w(W,"getUint64");function ft(r,e){let t=new DataView(r),s=t.getUint8(7);if(s>3)throw Error(`Archive is spec version ${s} but this library supports up to spec version 3`);return{specVersion:s,rootDirectoryOffset:W(t,8),rootDirectoryLength:W(t,16),jsonMetadataOffset:W(t,24),jsonMetadataLength:W(t,32),leafDirectoryOffset:W(t,40),leafDirectoryLength:W(t,48),tileDataOffset:W(t,56),tileDataLength:W(t,64),numAddressedTiles:W(t,72),numTileEntries:W(t,80),numTileContents:W(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}w(ft,"bytesToHeader");function pt(r){let e={buf:new Uint8Array(r),pos:0},t=we(e),s=[],a=0;for(let i=0;i<t;i++){let o=we(e);s.push({tileId:a+o,offset:0,length:0,runLength:1}),a+=o}for(let i=0;i<t;i++)s[i].runLength=we(e);for(let i=0;i<t;i++)s[i].length=we(e);for(let i=0;i<t;i++){let o=we(e);o===0&&i>0?s[i].offset=s[i-1].offset+s[i-1].length:s[i].offset=o-1}return s}w(pt,"deserializeIndex");var pr=class extends Error{};w(pr,"EtagMismatch");var Ue=pr;function xt(r,e){return M(this,null,function*(){let t=yield r.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let s=t.data.slice(0,Ls),a=ft(s,t.etag),i=t.data.slice(a.rootDirectoryOffset,a.rootDirectoryOffset+a.rootDirectoryLength),o=`${r.getKey()}|${a.etag||""}|${a.rootDirectoryOffset}|${a.rootDirectoryLength}`,l=pt(yield e(i,a.internalCompression));return[a,[o,l.length,l]]})}w(xt,"getHeaderAndRoot");function bt(r,e,t,s,a){return M(this,null,function*(){let i=yield r.getBytes(t,s,void 0,a.etag),o=yield e(i.data,a.internalCompression),l=pt(o);if(l.length===0)throw new Error("Empty directory is invalid");return l})}w(bt,"getDirectory");var xr=class{constructor(r=100,e=!0,t=Oe){this.cache=new Map,this.maxCacheEntries=r,this.counter=1,this.decompress=t}getHeader(r){return M(this,null,function*(){let e=r.getKey(),t=this.cache.get(e);if(t)return t.lastUsed=this.counter++,t.data;let s=yield xt(r,this.decompress);return s[1]&&this.cache.set(s[1][0],{lastUsed:this.counter++,data:s[1][2]}),this.cache.set(e,{lastUsed:this.counter++,data:s[0]}),this.prune(),s[0]})}getDirectory(r,e,t,s){return M(this,null,function*(){let a=`${r.getKey()}|${s.etag||""}|${e}|${t}`,i=this.cache.get(a);if(i)return i.lastUsed=this.counter++,i.data;let o=yield bt(r,this.decompress,e,t,s);return this.cache.set(a,{lastUsed:this.counter++,data:o}),this.prune(),o})}prune(){if(this.cache.size>this.maxCacheEntries){let r=1/0,e;this.cache.forEach((t,s)=>{t.lastUsed<r&&(r=t.lastUsed,e=s)}),e&&this.cache.delete(e)}}invalidate(r){return M(this,null,function*(){this.cache.delete(r.getKey())})}};w(xr,"ResolvedValueCache");var _s=xr,br=class{constructor(r=100,e=!0,t=Oe){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=r,this.counter=1,this.decompress=t}getHeader(r){return M(this,null,function*(){let e=r.getKey(),t=this.cache.get(e);if(t)return t.lastUsed=this.counter++,yield t.data;let s=new Promise((a,i)=>{xt(r,this.decompress).then(o=>{o[1]&&this.cache.set(o[1][0],{lastUsed:this.counter++,data:Promise.resolve(o[1][2])}),a(o[0]),this.prune()}).catch(o=>{i(o)})});return this.cache.set(e,{lastUsed:this.counter++,data:s}),s})}getDirectory(r,e,t,s){return M(this,null,function*(){let a=`${r.getKey()}|${s.etag||""}|${e}|${t}`,i=this.cache.get(a);if(i)return i.lastUsed=this.counter++,yield i.data;let o=new Promise((l,d)=>{bt(r,this.decompress,e,t,s).then(h=>{l(h),this.prune()}).catch(h=>{d(h)})});return this.cache.set(a,{lastUsed:this.counter++,data:o}),o})}prune(){if(this.cache.size>=this.maxCacheEntries){let r=1/0,e;this.cache.forEach((t,s)=>{t.lastUsed<r&&(r=t.lastUsed,e=s)}),e&&this.cache.delete(e)}}invalidate(r){return M(this,null,function*(){let e=r.getKey();if(this.invalidations.get(e))return yield this.invalidations.get(e);this.cache.delete(r.getKey());let t=new Promise((s,a)=>{this.getHeader(r).then(i=>{s(),this.invalidations.delete(e)}).catch(i=>{a(i)})});this.invalidations.set(e,t)})}};w(br,"SharedPromiseCache");var vr=br,yr=class{constructor(r,e,t){typeof r=="string"?this.source=new fr(r):this.source=r,t?this.decompress=t:this.decompress=Oe,e?this.cache=e:this.cache=new vr}getHeader(){return M(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(r,e,t,s){return M(this,null,function*(){let a=ut(r,e,t),i=yield this.cache.getHeader(this.source);if(r<i.minZoom||r>i.maxZoom)return;let o=i.rootDirectoryOffset,l=i.rootDirectoryLength;for(let d=0;d<=3;d++){let h=yield this.cache.getDirectory(this.source,o,l,i),u=gt(h,a);if(u){if(u.runLength>0){let c=yield this.source.getBytes(i.tileDataOffset+u.offset,u.length,s,i.etag);return{data:yield this.decompress(c.data,i.tileCompression),cacheControl:c.cacheControl,expires:c.expires}}o=i.leafDirectoryOffset+u.offset,l=u.length}else return}throw Error("Maximum directory depth exceeded")})}getZxy(r,e,t,s){return M(this,null,function*(){try{return yield this.getZxyAttempt(r,e,t,s)}catch(a){if(a instanceof Ue)return this.cache.invalidate(this.source),yield this.getZxyAttempt(r,e,t,s);throw a}})}getMetadataAttempt(){return M(this,null,function*(){let r=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(r.jsonMetadataOffset,r.jsonMetadataLength,void 0,r.etag),t=yield this.decompress(e.data,r.internalCompression),s=new TextDecoder("utf-8");return JSON.parse(s.decode(t))})}getMetadata(){return M(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(r){if(r instanceof Ue)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw r}})}getTileJson(r){return M(this,null,function*(){let e=yield this.getHeader(),t=yield this.getMetadata(),s=mt(e.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${r}/{z}/{x}/{y}${s}`],vector_layers:t.vector_layers,attribution:t.attribution,description:t.description,name:t.name,version:t.version,bounds:[e.minLon,e.minLat,e.maxLon,e.maxLat],center:[e.centerLon,e.centerLat,e.centerZoom],minzoom:e.minZoom,maxzoom:e.maxZoom}})}};w(yr,"PMTiles");var Qe=yr;const wr=Object.freeze(Object.defineProperty({__proto__:null,Compression:hr,EtagMismatch:Ue,FetchSource:fr,FileSource:Ss,PMTiles:Qe,Protocol:Ye,ResolvedValueCache:_s,SharedPromiseCache:vr,TileType:ur,bytesToHeader:ft,findTile:gt,getUint64:W,leafletRasterLayer:ks,readVarint:we,tileIdToZxy:dr,tileTypeExt:mt,zxyToTileId:ut},Symbol.toStringTag,{value:"Module"}));window.pmtiles=wr;window.__trackCDN("pmtiles",!0);console.log("[PMTiles] ✓ Loaded via ES module:",wr);if(window.maplibregl){const r=new Ye;window.maplibregl.addProtocol("pmtiles",r.tile),window.__pmtiles_registered=!0,console.log("[PMTiles] ✓ Protocol registered")}else{const r=setInterval(()=>{if(window.maplibregl){clearInterval(r);const e=new Ye;window.maplibregl.addProtocol("pmtiles",e.tile),window.__pmtiles_registered=!0,console.log("[PMTiles] ✓ Protocol registered (delayed)")}},100)}var yt={exports:{}},Ce={};/**
* @license React
* react-jsx-runtime.production.js
*
* Copyright (c) Meta Platforms, Inc. and affiliates.
*
* This source code is licensed under the MIT license found in the
* LICENSE file in the root directory of this source tree.
*/var wt;function Ps(){if(wt)return Ce;wt=1;var r=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(s,a,i){var o=null;if(i!==void 0&&(o=""+i),a.key!==void 0&&(o=""+a.key),"key"in a){i={};for(var l in a)l!=="key"&&(i[l]=a[l])}else i=a;return a=i.ref,{$$typeof:r,type:s,key:o,ref:a!==void 0?a:null,props:i}}return Ce.Fragment=e,Ce.jsx=t,Ce.jsxs=t,Ce}var jt;function As(){return jt||(jt=1,yt.exports=Ps()),yt.exports}var n=As();class Es{constructor(){this.indexCacheByMaXa={},this.indexLoadPromises={},this.communeListCache=null,this.communeListPromise=null,this.allShardsLoaded=!1,this.allShardsPromise=null,this.RAW_FALLBACK_BASE="https://raw.githubusercontent.com/hvduoc/xemgiadat-v2/main/public/data/parcels",window.LandParcelService=this,(window.requestIdleCallback||(e=>setTimeout(e,0)))(()=>{this.loadCommuneList().catch(()=>{})})}parseParcelQuery(e){const t=(e||"").trim();if(!t)return{soThua:null,soTo:null,raw:t};const s=t.match(/^(\d+)\s*\/\s*(\d+)$/);if(s)return{soThua:parseInt(s[1],10),soTo:parseInt(s[2],10),raw:t};const a=t.match(/th[uứửữụ]a\s*(\d+)\s*t[oờởỡọ]\s*(\d+)/i);if(a)return{soThua:parseInt(a[1],10),soTo:parseInt(a[2],10),raw:t};const i=t.match(/t[oờởỡọ]\s*(\d+)\s*th[uứửữụ]a\s*(\d+)/i);if(i)return{soThua:parseInt(i[2],10),soTo:parseInt(i[1],10),raw:t};const o=t.match(/^(\d+)\s*[:\s]\s*(\d+)$/);if(o)return{soThua:parseInt(o[2],10),soTo:parseInt(o[1],10),raw:t};const l=t.match(/^(\d+)$/);return l?{soThua:parseInt(l[1],10),soTo:null,raw:t}:{soThua:null,soTo:null,raw:t}}async loadAllShards(){if(!this.allShardsLoaded)return this.allShardsPromise?this.allShardsPromise:(this.allShardsPromise=(async()=>{try{await this.loadCommuneList();const e=this.communeListCache||[];if(e.length===0){console.warn("[LandParcelService] No communes found, cannot load shards");return}await Promise.all(e.map(t=>this.loadIndexForMaXa(t))),this.allShardsLoaded=!0,console.log(`[LandParcelService] ✅ All ${e.length} shards loaded`)}catch(e){console.error("[LandParcelService] Failed to load all shards:",e)}})(),this.allShardsPromise)}async searchV1(e){const t=this.parseParcelQuery(e);if(t.soThua===null)return null;await this.loadAllShards();let s=null;if(t.soTo!==null){const i=`${t.soTo}:${t.soThua}`;for(const[o,l]of Object.entries(this.indexCacheByMaXa)){const d=l[i];if(d){s={lng:d[0],lat:d[1],maXa:o,soTo:t.soTo,soThua:t.soThua};break}}}if(!s&&t.soThua!==null){const i=`:${t.soThua}`;for(const[o,l]of Object.entries(this.indexCacheByMaXa)){for(const[d,h]of Object.entries(l))if(d.endsWith(i)){const u=parseInt(d.split(":")[0],10);s={lng:h[0],lat:h[1],maXa:o,soTo:u,soThua:t.soThua};break}if(s)break}}if(!s)return null;const a=window.MapController;return a&&typeof a.flyToCoordinates=="function"&&a.flyToCoordinates(s.lng,s.lat,18),this.highlightParcelAfterFly(s),s}async highlightParcelAfterFly(e){var t,s,a;try{const i=e.maXa;if(!i)return;await this.loadIndexForMaXa(i),await new Promise(u=>setTimeout(u,1700));const o=(s=(t=window.MapController)==null?void 0:t.getMap)==null?void 0:s.call(t);if(!o)return;const l=window.StyleEngine;if(!l)return;const d=o.querySourceFeatures(l.SOURCE_ID,{sourceLayer:l.SOURCE_LAYER});if(!d||d.length===0)return;const h=d.find(u=>{const c=u.properties||{},g=parseInt(c.SoHieuToBanDo||c["Số hiệu tờ bản đồ"]||c.so_to||"0",10),x=parseInt(c.SoThuTuThua||c["Số thửa"]||c.so_thua||"0",10);return g===e.soTo&&x===e.soThua});if(h){const u=h.id||((a=h.properties)==null?void 0:a.OBJECTID);u!==void 0&&(o.setFilter(l.LAYER_HIGHLIGHT,["==",["id"],u]),console.log(`[LandParcelService] ✅ Highlighted thửa ${e.soThua}, tờ ${e.soTo}`))}}catch(i){console.warn("[LandParcelService] Highlight failed:",i)}}createEmptyFeatureCollection(){return{type:"FeatureCollection",features:[]}}getPolygonCenter(e,t){var s,a;if((e==null?void 0:e.type)!=="Polygon"||!((a=(s=e.coordinates)==null?void 0:s[0])!=null&&a[0]))return t;const i=e.coordinates[0],o=i.map(d=>d[0]),l=i.map(d=>d[1]);return[(Math.min(...o)+Math.max(...o))/2,(Math.min(...l)+Math.max(...l))/2]}ensureListingLayers(e){!e||e.getSource("user-listings")||(e.addSource("user-listings",{type:"geojson",data:this.createEmptyFeatureCollection(),cluster:!0,clusterMaxZoom:14,clusterRadius:50}),e.addLayer({id:"user-listings-clusters",type:"circle",source:"user-listings",filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#51bbd6",5,"#f1f075",10,"#f28cb1"],"circle-radius":["step",["get","point_count"],20,5,30,10,40]}}),e.addLayer({id:"user-listings-cluster-count",type:"symbol",source:"user-listings",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":12}}),e.addLayer({id:"user-listings-points",type:"circle",source:"user-listings",filter:["!",["has","point_count"]],paint:{"circle-color":"#ff4444","circle-radius":8,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}))}buildListingFeatures(e,t){return e.docs.map(s=>{try{const a=s.data()||{};if(typeof a.lng!="number"||typeof a.lat!="number")return console.warn(`[LandParcelService] Invalid coordinates for listing ${s.id}`),null;const i=a.userId?t[a.userId]:null,o=(i==null?void 0:i.displayName)||a.userName||"Nguoi dang",l=(i==null?void 0:i.phone)||a.phone||"";return{type:"Feature",geometry:{type:"Point",coordinates:[a.lng,a.lat]},properties:{id:s.id,userId:a.userId||"",so_to:a.soHieuToBanDo||"",so_thua:a.soThuTuThua||"",dien_tich:a.dienTich||0,priceValue:a.priceValue||0,priceUnit:a.priceUnit||"VND",isNegotiable:a.isNegotiable||!1,loaiGiaoDich:a.loaiGiaoDich||"ban-dat",userName:o,phone:l,note:a.note||"",status:a.status||"approved"}}}catch(a){return console.warn(`[LandParcelService] Error processing listing ${s.id}:`,a),null}}).filter(Boolean)}updateGeoJsonSource(e,t,s){if(!e)return;const a=e.getSource(t);a&&typeof a.setData=="function"&&a.setData({type:"FeatureCollection",features:s})}async loadCommuneList(){if(!this.communeListCache)return this.communeListPromise?this.communeListPromise:(this.communeListPromise=(async()=>{try{const e="./data/parcels/communes.json",t=`${this.RAW_FALLBACK_BASE}/communes.json`,s=[e,t];let a=null;for(const d of s)try{const h=await fetch(d,{cache:"no-store"});if(h.ok){a=h;break}}catch(h){console.warn("[LandParcelService] Commune list fetch failed:",d,h)}if(!a)throw new Error("Failed to load commune list");const i=window.requestIdleCallback||(d=>setTimeout(d,0));await new Promise(d=>i(d));const o=await a.json(),l=Array.isArray(o==null?void 0:o.communes)?o.communes:[];this.communeListCache=l.map(d=>String(d)).filter(Boolean)}catch(e){console.error("[LandParcelService] Commune list load failed:",e),this.communeListCache=[],window.LandParcelService=this}})(),this.communeListPromise)}async getCommuneList(){return await this.loadCommuneList(),this.communeListCache||[]}async loadIndexForMaXa(e){const t=String(e||"").trim();if(t&&!this.indexCacheByMaXa[t])return this.indexLoadPromises[t]?this.indexLoadPromises[t]:(this.indexLoadPromises[t]=(async()=>{try{const s=`./data/parcels/${t}.json`,a=`${this.RAW_FALLBACK_BASE}/${t}.json`,i=[s,a];let o=null;for(const u of i)try{const c=await fetch(u,{cache:"no-store"});if(c.ok){o=c;break}}catch(c){console.warn("[LandParcelService] Shard fetch failed:",u,c)}if(!o)throw new Error(`Failed to load shard for ${t}`);const l=window.requestIdleCallback||(u=>setTimeout(u,0));await new Promise(u=>l(u));const d=await o.json(),h=d==null?void 0:d.index;h&&typeof h=="object"?this.indexCacheByMaXa[t]=h:(console.warn("[LandParcelService] Invalid shard format:",t),this.indexCacheByMaXa[t]={})}catch(s){console.error("[LandParcelService] Shard load failed:",s),this.indexCacheByMaXa[t]={},window.LandParcelService=this}})(),this.indexLoadPromises[t])}async searchParcelByNumber(e,t){if(!e||!e.trim())return null;const s=await this.searchV1(e);return s?[s.lng,s.lat]:null}normalizeParcelKey(e){const t=e.trim();if(!t)return null;if(t.includes(":"))return t;const s=t.split(/[\s/]+/).filter(Boolean);if(s.length<2)return null;const a=parseInt(s[0],10),i=parseInt(s[1],10);return Number.isNaN(a)||Number.isNaN(i)?null:`${a}:${i}`}}window.LandParcelService=new Es;const et=class{static async init(){this.dataLoaded||(this.dataLoaded=!0,console.log("[AIInsight] Initialized (sharded mode — no monolithic index)"))}static getAreaAveragePrice(e){if(!this.priceData||!Array.isArray(this.priceData))return null;const t=this.priceData.filter(a=>a.ma_xa===e);if(t.length===0)return null;const s=t.map(a=>a.gia_uoc_tinh).filter(a=>a>0);return s.length===0?null:s.reduce((a,i)=>a+i,0)/s.length}static getPriceInsight(e){if(!e.gia_uoc_tinh||e.gia_uoc_tinh<=0)return{type:"unknown",message:"Chưa có đủ dữ liệu để đánh giá",badge:"Đang cập nhật"};const t=e.gia_uoc_tinh/e.dien_tich,s=this.getAreaAveragePrice(e.ma_xa);if(!s)return e.gia_uoc_tinh<5e8?{type:"good",message:"Giá phù hợp với thị trường, tiềm năng đầu tư tốt",badge:"Giá tốt"}:e.gia_uoc_tinh>2e9?{type:"high",message:"Mức giá cao, phù hợp với nhà đầu tư chuyên nghiệp",badge:"Cao cấp"}:{type:"potential",message:"Vị trí đẹp, giá hợp lý cho đầu tư dài hạn",badge:"Tiềm năng"};const a=s/100,i=(t-a)/a*100;return i<-10?{type:"good",message:`Giá thấp hơn trung bình khu vực ${Math.abs(i).toFixed(0)}%, cơ hội đầu tư tốt`,badge:"Giá tốt"}:i>20?{type:"high",message:`Giá cao hơn trung bình khu vực ${i.toFixed(0)}%, vị trí đắc địa`,badge:"Cao cấp"}:{type:"potential",message:"Giá phù hợp với thị trường, đáng để xem xét",badge:"Hợp lý"}}static getListingInsight(e){if(!e.priceValue||e.priceValue<=0)return e.isNegotiable?{type:"potential",message:"Giá có thể thương lượng, liên hệ để biết thêm chi tiết",badge:"Thương lượng"}:{type:"unknown",message:"Liên hệ chủ nhà để biết giá chính xác",badge:"Liên hệ"};const t=e.priceValue/e.dien_tich;return t<5e6?{type:"good",message:"Mức giá rất hợp lý, nên xem xét đầu tư ngay",badge:"Giá tốt"}:t<15e6?{type:"potential",message:"Giá phù hợp với thị trường, đáng để khảo sát kỹ",badge:"Hợp lý"}:t<3e7?{type:"high",message:"Vị trí đắc địa, phù hợp kinh doanh hoặc đầu tư cao cấp",badge:"Cao cấp"}:{type:"high",message:"Bất động sản hạng sang, khu vực trung tâm hoặc mặt tiền",badge:"Hạng sang"}}static getStatusBadges(e){const t=[];e.createdAt&&(Date.now()-new Date(e.createdAt).getTime())/864e5<7&&t.push("Mới đăng"),e.so_thua&&e.so_to&&t.push("Đã xác thực");const s=e.priceValue?this.getListingInsight(e):this.getPriceInsight(e);return s.badge&&!t.includes(s.badge)&&t.push(s.badge),t.slice(0,3)}};et.priceData=null,et.dataLoaded=!1;let Nt=et;typeof window<"u"&&(window.AIInsightService=Nt,Nt.init());const jr=class{static getBookmarks(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("[BookmarkService] Failed to get bookmarks:",e),[]}}static isBookmarked(e){try{return this.getBookmarks().includes(e)}catch(t){return console.error("[BookmarkService] Failed to check bookmark:",t),!1}}static addBookmark(e){try{const t=this.getBookmarks();return t.includes(e)?!1:(t.push(e),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),console.log("[BookmarkService] ✅ Bookmark added:",e),!0)}catch(t){return console.error("[BookmarkService] Failed to add bookmark:",t),!1}}static removeBookmark(e){try{const t=this.getBookmarks(),s=t.indexOf(e);return s>-1?(t.splice(s,1),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),console.log("[BookmarkService] 🗑️ Bookmark removed:",e),!0):!1}catch(t){return console.error("[BookmarkService] Failed to remove bookmark:",t),!1}}static toggleBookmark(e){const t=this.isBookmarked(e);return t?this.removeBookmark(e):this.addBookmark(e),!t}static clearAll(){try{localStorage.removeItem(this.STORAGE_KEY),console.log("[BookmarkService] 🗑️ All bookmarks cleared")}catch(e){console.error("[BookmarkService] Failed to clear bookmarks:",e)}}static getCount(){return this.getBookmarks().length}};jr.STORAGE_KEY="xemgiadat_bookmarks";let Is=jr;window.BookmarkService=Is;class Ms{static async compressImage(e,t=.7,s=1200){return new Promise((a,i)=>{const o=new FileReader;o.readAsDataURL(e),o.onload=l=>{var d;const h=new Image;h.src=(d=l.target)==null?void 0:d.result,h.onload=()=>{const u=document.createElement("canvas");let c=h.width,g=h.height;c>s&&(g=s/c*g,c=s),u.width=c,u.height=g;const x=u.getContext("2d");x==null||x.drawImage(h,0,0,c,g);const j=u.toDataURL("image/jpeg",t);a(j)},h.onerror=u=>i(u)},o.onerror=l=>i(l)})}}window.ImageService=Ms;class $s{static calculateTotalValue(e){return(e.dien_tich||0)*45e6}static formatCurrency(e){return new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)}}window.PriceService=$s;class Ds{static getSafeLocation(){return window.__SAFE_LOCATION__||{href:"https://xemgiadat.com/",origin:"https://xemgiadat.com",protocol:"https:",host:"xemgiadat.com",hostname:"xemgiadat.com",pathname:"/",search:"",hash:""}}static getParams(){try{const e=this.getSafeLocation().hash||"",t=e.startsWith("#")?e.substring(1):e,s=new URLSearchParams(t);return{lat:s.get("lat")?parseFloat(s.get("lat")):null,lng:s.get("lng")?parseFloat(s.get("lng")):null,zoom:s.get("z")?parseFloat(s.get("z")):null,parcelId:s.get("p")||null,listingId:s.get("l")||null}}catch{return{lat:null,lng:null,zoom:null,parcelId:null,listingId:null}}}static updateUrl(e,t,s,a,i){try{const o=new URLSearchParams;o.set("lat",e.toFixed(6)),o.set("lng",t.toFixed(6)),o.set("z",s.toFixed(2)),a&&o.set("p",a),i&&o.set("l",i);const l=`#${o.toString()}`;window.history&&typeof window.history.replaceState=="function"&&window.history.replaceState(null,"",l);const d=window.__SAFE_LOCATION__;d&&(d.hash=l)}catch{}}static generateShareLink(e,t,s){const a=this.getSafeLocation().href.split("#")[0],i=`lat=${t.toFixed(6)}&lng=${s.toFixed(6)}&z=18&p=${e}`;return`${a}#${i}`}static generateListingShareLink(e,t,s){const a=this.getSafeLocation().href.split("#")[0],i=`lat=${t.toFixed(6)}&lng=${s.toFixed(6)}&z=18&l=${e}`;return`${a}#${i}`}}window.LinkService=Ds;class Bs{constructor(){try{this.protocol=new window.pmtiles.Protocol;const e=window.maplibregl;e.addProtocol&&(!e._protocols||!e._protocols.pmtiles)&&e.addProtocol("pmtiles",(t,s)=>{var a;return(a=this.protocol)==null?void 0:a.tile(t,s)})}catch(e){console.warn("Failed to initialize PMTiles protocol:",e)}}initialize(e,t){try{const s=window.maplibregl;return s.workerUrl="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl-csp-worker.js",this.map=new s.Map({container:e,style:{version:8,sources:{osm:{type:"raster",tiles:["https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"],tileSize:256,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'}},layers:[{id:"osm",type:"raster",source:"osm"}]},center:t.center||[108.2022,16.0544],zoom:t.zoom||13,attributionControl:!1,hash:!1,validateStyle:!1,transformRequest:a=>a.startsWith("/")?{url:`https://xemgiadat.com${a}`}:{url:a},...t}),this.map.addControl(new s.NavigationControl({showCompass:!1}),"top-right"),this.map}catch(s){return console.error("Map initialization failed:",s),null}}addMockData(e){if(!this.map)return;const t={type:"FeatureCollection",features:e.map(s=>({type:"Feature",geometry:{type:"Point",coordinates:s.coordinates},properties:{...s}}))};if(this.map.getSource("mock-parcels")){this.map.getSource("mock-parcels").setData(t);return}this.map.addSource("mock-parcels",{type:"geojson",data:t}),this.map.addLayer({id:"mock-parcels-points",type:"circle",source:"mock-parcels",paint:{"circle-radius":8,"circle-color":"#3b82f6","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}})}setupSmartLoading(e){if(!this.map)return;const t=()=>{var s,a,i;(((s=this.map)==null?void 0:s.getZoom())||0)>15&&!((a=this.map)!=null&&a.getSource("parcels"))&&(this.addParcelLayers(e),(i=this.map)==null||i.off("zoomend",t))};this.map.on("zoomend",t)}addParcelLayers(e){if(!this.map||this.map.getSource("parcels"))return;let t=e;e.startsWith("http")||(t=`https://xemgiadat.com/${e}`);try{this.map.addSource("parcels",{type:"vector",url:`pmtiles://${t}`}),this.map.addLayer({id:"parcels-line",type:"line",source:"parcels","source-layer":"default",paint:{"line-color":"#3b82f6","line-width":1}})}catch(s){console.warn("Failed to add parcel layers:",s)}}getMap(){return this.map}}window.MapModule=Bs;const Us=window.React,{useEffect:zs,useRef:Os,useState:B,useMemo:Fs}=Us,Rs=window.lucideReact||{},{MapPin:De,Share2:kt,X:ke,ChevronUp:ga,Copy:Hs,Rocket:Vs,Camera:Ze,ArrowLeft:Gs,CheckCircle2:Zs,Phone:Ke,Banknote:Ks,Send:Tt,FileText:Ws,Info:Js,Bookmark:qs,BookmarkCheck:Xs,Sparkles:Ct,TrendingUp:Lt,TrendingDown:St,Eye:_t,Box:Ys,Wrench:fa,Coffee:We,Video:pa,Scissors:xa,QrCode:Qs}=Rs,ea=()=>{var r,e,t,s,a,i,o,l,d,h,u;const c=Os(null),g=window.MapController,x=Fs(()=>{const m=new g;return g.setInstance(m),m},[]),j="0123456789",S="0123456789",R="VCB",de="ADMIN",[b,T]=B(null),[f,Q]=B(null),[U,D]=B("info"),[A,z]=B("expanded"),[H,$]=B(!1),[je,V]=B(!1),[ne,ee]=B(!1),[re,E]=B(!1),[he,O]=B(""),[pe,xe]=B(""),[G,_]=B(""),[ue,P]=B([]),[oe,se]=B(!1),[C,te]=B({price:"",phone:"",note:"",images:[]}),[be,me]=B(!1);zs(()=>{if(!c.current)return;const m=window.LinkService,p=window.PriceService,F=m.getParams();return x.init(c.current,F,v=>{const ce={id:v.id||v.OBJECTID,so_thua:v["Số thửa"]||v.so_thua||"N/A",so_to:v["Số hiệu tờ bản đồ"]||v.so_to||"N/A",dien_tich:Number(v["Diện tích"]||v.dien_tich||0),muc_dich:v["Ký hiệu mục đích sử dụng"]||v.muc_dich||"N/A",ma_xa:v["Mã xã"]||v.ma_xa||"N/A",dia_chi:v["Địa chỉ"]!=="Null"?v["Địa chỉ"]:"TP. Đà Nẵng",coordinates:v.coordinates};ce.gia_uoc_tinh=p.calculateTotalValue(ce),T(ce),Q(null),D("info"),z("expanded"),te({price:"",phone:"",note:"",images:[]}),_(""),P([])},v=>{Q(v),T(null),D("listing-detail"),z("expanded"),_(""),P([])}),F.listingId&&(console.log("[App] Loading listing from deep link:",F.listingId),x.getListingById(F.listingId).then(v=>{v?(Q(v),T(null),D("listing-detail"),z("expanded"),v.coordinates&&x.flyToCoordinates(v.coordinates[0],v.coordinates[1],18)):console.warn("[App] Listing not found:",F.listingId)})),()=>{}},[x]);const Z=(m="medium")=>{if("vibrate"in navigator){const F={light:10,medium:20,heavy:30};navigator.vibrate(F[m])}const p=document.activeElement;p&&(p.style.transform="scale(0.95)",setTimeout(()=>{p.style.transform=""},100))},ve=()=>{const m=x.getMap();m&&(Z("medium"),H?(m.easeTo({pitch:0,bearing:0,duration:1e3}),$(!1)):(m.easeTo({pitch:60,bearing:-20,duration:1e3}),$(!0)))},le=()=>{const m=window.AIInsightService;return m?b?m.getPriceInsight(b):f?m.getListingInsight(f):null:null},Me=()=>{const m=window.AIInsightService;if(!m)return[];const p=b||f;return p?m.getStatusBadges(p):[]},Nr=async m=>{if(m.preventDefault(),!!G.trim()){se(!0);try{console.log("🔍 Global Search Triggered:",G.trim());const p=window.LandParcelService;if(p&&typeof p.searchV1=="function"&&await p.searchV1(G.trim())){P([]),_(""),se(!1);return}console.log("[Search] Không tìm thấy thửa đất, thử tìm tin đăng..."),P([])}catch(p){console.error("Search failed:",p),P([])}finally{se(!1)}}},kr=async m=>{const p=window.PriceService;m.gia_uoc_tinh=p.calculateTotalValue(m),T(m),D("info"),z("expanded"),_(""),P([]),await x.flyToParcel(m.so_to,m.so_thua)},Tr=async m=>{if(m.target.files){const p=window.ImageService,F=Array.from(m.target.files),v=await Promise.all(F.slice(0,5).map(ce=>p.compressImage(ce,.6,1e3)));te(ce=>({...ce,images:[...ce.images,...v]}))}},Cr=async()=>{me(!0),await new Promise(m=>setTimeout(m,1500)),D("success"),me(!1),setTimeout(()=>{T(null),D("info")},3e3)},Ne=m=>{O(m),xe(""),E(!0)},Lr=()=>{if(!pe.trim()){alert("Vui lòng nhập số điện thoại!");return}const m=b||f,p=m?`Tờ ${m.so_to}, Thửa ${m.so_thua} tại ${m.dia_chi}`:"Vị trí chưa xác định",F=`Tôi muốn đặt dịch vụ ${he} cho thửa đất ${p}. SĐT liên hệ: ${pe}`,v=`https://zalo.me/${j}?text=${encodeURIComponent(F)}`;window.open(v,"_blank"),E(!1),xe("")},Sr=()=>{var m;if(!b)return;Z("light");const p=window.LinkService,F=window.PriceService,v=p.generateParcelShareLink(b.coordinates[0],b.coordinates[1]),ce=F.formatCurrency(b.gia_uoc_tinh||0),Fe=`Bán đất ${b.dien_tich}m² - Giá ${ce} - Tại ${b.dia_chi}. Xem chi tiết: ${v}`;navigator.share?navigator.share({title:"Thông tin thửa đất",text:Fe}).catch(()=>{var vt;(vt=navigator.clipboard)==null||vt.writeText(Fe),$e("Đã copy nội dung!")}):((m=navigator.clipboard)==null||m.writeText(Fe),$e("Đã copy nội dung!"))},_r=()=>{var m;if(!b)return;Z("light");const p=`${b.coordinates[1].toFixed(6)}, ${b.coordinates[0].toFixed(6)}`;(m=navigator.clipboard)==null||m.writeText(p),$e("Đã copy tọa độ!")},$e=m=>{const p=document.createElement("div");p.className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-slate-900 text-white px-6 py-3 rounded-full shadow-xl text-sm font-bold animate-in fade-in slide-in-from-top-4 duration-300",p.textContent=m,document.body.appendChild(p),setTimeout(()=>{p.classList.add("animate-out","fade-out","slide-out-to-top-4"),setTimeout(()=>p.remove(),300)},2e3)};return n.jsxs("div",{className:"relative w-full h-full bg-slate-900 overflow-hidden",children:[n.jsx("div",{className:"absolute top-4 left-4 right-4 z-50",children:n.jsxs("form",{onSubmit:Nr,className:"backdrop-blur-xl bg-white/90 rounded-2xl shadow-2xl border border-white/20",children:[n.jsxs("div",{className:"flex items-center px-4 py-3",children:[n.jsxs("svg",{className:"w-5 h-5 text-slate-400 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[n.jsx("circle",{cx:"11",cy:"11",r:"8",strokeWidth:"2"}),n.jsx("path",{d:"m21 21-4.3-4.3",strokeWidth:"2"})]}),n.jsx("input",{type:"text",placeholder:"Tìm số tờ, số thửa...",className:"flex-1 outline-none text-slate-900 font-semibold placeholder:text-slate-400",value:G,onChange:m=>_(m.target.value)}),G&&n.jsx("button",{type:"button",onClick:()=>{_(""),P([])},className:"ml-2 p-1",children:n.jsx(ke,{className:"w-5 h-5 text-slate-400"})})]}),(oe||ue.length>0)&&n.jsx("div",{className:"border-t border-slate-100 max-h-64 overflow-y-auto",children:oe?n.jsxs("div",{className:"px-4 py-8 text-center text-slate-500",children:[n.jsx("div",{className:"inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-slate-900"}),n.jsx("p",{className:"mt-2 text-sm",children:"Đang tìm kiếm..."})]}):ue.length===0?n.jsx("div",{className:"px-4 py-6 text-center text-slate-500 text-sm",children:"Không tìm thấy kết quả. Hãy zoom ra hoặc pan map."}):ue.map((m,p)=>n.jsx("button",{onClick:()=>kr(m),className:"w-full px-4 py-3 hover:bg-slate-50 text-left border-b border-slate-100 last:border-0 transition-colors",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsxs("p",{className:"font-bold text-slate-900",children:["Tờ ",m.so_to," / Thửa ",m.so_thua]}),n.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:[m.dia_chi," • ",m.dien_tich," m²"]})]}),n.jsx(De,{className:"w-4 h-4 text-red-500 flex-shrink-0"})]})},p))})]})}),n.jsx("div",{className:"absolute bottom-28 right-4 z-50 flex flex-col gap-3",children:n.jsxs("button",{onClick:ve,className:`backdrop-blur-xl ${H?"bg-blue-600/90":"bg-white/90"} 
              rounded-2xl shadow-2xl border ${H?"border-blue-400/20":"border-white/20"} 
              p-4 transition-all duration-300 active:scale-95 hover:scale-105`,"aria-label":H?"Chuyển về 2D":"Chuyển sang 3D",children:[n.jsx(Ys,{className:`w-6 h-6 ${H?"text-white":"text-slate-700"}`}),n.jsx("div",{className:`text-xs font-bold mt-1 ${H?"text-white":"text-slate-700"}`,children:H?"2D":"3D"})]})}),n.jsx("div",{ref:c,className:"w-full h-full"}),(b||f)&&n.jsx("div",{className:`absolute bottom-0 inset-x-0 z-[100] transition-all duration-300 ease-out transform
          ${A==="expanded"?"translate-y-0":"translate-y-[calc(100%-80px)]"}
        `,children:n.jsxs("div",{className:"max-w-xl mx-auto backdrop-blur-2xl bg-white/95 rounded-t-[2.5rem] shadow-[0_-20px_60px_rgba(0,0,0,0.3)] pb-safe border-t border-white/20",children:[n.jsx("div",{className:"h-10 flex flex-col items-center justify-center cursor-pointer",onClick:()=>z(A==="peek"?"expanded":"peek"),children:n.jsx("div",{className:"w-12 h-1.5 bg-slate-300 rounded-full"})}),n.jsxs("div",{className:"px-6 pb-8 overflow-y-auto max-h-[85vh] scrollbar-hide",children:[U==="info"&&b&&n.jsxs("div",{className:"animate-in fade-in slide-in-from-bottom-4 duration-300",children:[Me().length>0&&n.jsx("div",{className:"flex gap-2 mb-4 flex-wrap",children:Me().map((m,p)=>n.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm
                            ${m.includes("Giá tốt")||m.includes("Hợp lý")?"bg-green-100 text-green-700 border border-green-200":m.includes("Cao cấp")||m.includes("Hạng sang")?"bg-purple-100 text-purple-700 border border-purple-200":m.includes("Mới đăng")?"bg-blue-100 text-blue-700 border border-blue-200":m.includes("Đã xác thực")?"bg-emerald-100 text-emerald-700 border border-emerald-200":"bg-slate-100 text-slate-700 border border-slate-200"}
                          `,children:m},p))}),n.jsxs("div",{className:"flex justify-between items-start mb-6",children:[n.jsxs("div",{children:[n.jsxs("h2",{className:"text-2xl font-black text-slate-900 leading-tight",children:["Thửa ",b.so_thua," ",n.jsxs("span",{className:"text-slate-300",children:["/ Tờ ",b.so_to]})]}),n.jsxs("p",{className:"text-sm text-slate-500 font-medium flex items-center gap-1 mt-1",children:[n.jsx(De,{className:"w-4 h-4 text-red-500"})," ",b.dia_chi]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:()=>ee(!0),className:"p-2 bg-amber-50 hover:bg-amber-100 rounded-full transition-colors","aria-label":"Mời cà phê",children:n.jsx(We,{className:"w-5 h-5 text-amber-600"})}),n.jsx("button",{onClick:()=>T(null),className:"p-2 bg-slate-100 rounded-full",children:n.jsx(ke,{className:"w-5 h-5 text-slate-400"})})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[n.jsxs("div",{className:"bg-slate-50 p-4 rounded-2xl border border-slate-100",children:[n.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1",children:"Diện tích"}),n.jsxs("p",{className:"text-lg font-black text-slate-800",children:[b.dien_tich," m²"]})]}),n.jsxs("div",{className:"bg-slate-50 p-4 rounded-2xl border border-slate-100",children:[n.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1",children:"Loại đất"}),n.jsx("p",{className:"text-lg font-black text-slate-800",children:b.muc_dich})]})]}),n.jsxs("div",{className:"bg-yellow-50 border border-yellow-100 p-5 rounded-2xl mb-6 flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("span",{className:"text-[10px] font-bold text-yellow-600 uppercase tracking-widest",children:"Giá nhà nước 2025"}),n.jsx("p",{className:"text-3xl font-black text-yellow-700 leading-none mt-1",children:window.PriceService.formatCurrency(b.gia_uoc_tinh||0)})]}),n.jsx(Js,{className:"w-6 h-6 text-yellow-400"})]}),le()&&n.jsxs("div",{className:"backdrop-blur-sm bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-100 p-5 rounded-2xl mb-6",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx(Ct,{className:"w-5 h-5 text-indigo-600"}),n.jsx("span",{className:"text-xs font-bold text-indigo-900 uppercase tracking-widest",children:"AI Đánh giá"})]}),n.jsxs("div",{className:"flex items-start gap-3",children:[((r=le())==null?void 0:r.type)==="good"&&n.jsx(St,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),((e=le())==null?void 0:e.type)==="high"&&n.jsx(Lt,{className:"w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5"}),((t=le())==null?void 0:t.type)==="potential"&&n.jsx(_t,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),n.jsx("p",{className:"text-sm text-slate-700 leading-relaxed font-medium",children:(s=le())==null?void 0:s.message})]})]}),n.jsxs("div",{className:"flex flex-col gap-3",children:[n.jsxs("button",{onClick:()=>{Z("medium"),D("listing")},className:"w-full h-16 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl font-black text-lg flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all hover:shadow-2xl",children:[n.jsx(Vs,{className:"w-6 h-6 text-yellow-400"})," Rao bán lô này"]}),n.jsxs("div",{className:"flex gap-3",children:[n.jsxs("button",{onClick:Sr,className:"flex-1 backdrop-blur-sm bg-slate-100/80 text-slate-700 h-14 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all",children:[n.jsx(kt,{className:"w-4 h-4"})," Chia sẻ"]}),n.jsxs("button",{onClick:_r,className:"flex-1 backdrop-blur-sm bg-slate-100/80 text-slate-700 h-14 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all",children:[n.jsx(Hs,{className:"w-4 h-4"})," Tọa độ"]})]}),n.jsxs("div",{className:"mt-2 pt-4 border-t border-slate-200",children:[n.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase tracking-widest mb-3",children:"Dịch vụ hỗ trợ"}),n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsxs("button",{onClick:()=>Ne("Chụp 360°"),className:"p-3 bg-blue-50 hover:bg-blue-100 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95",children:[n.jsx(Ze,{className:"w-5 h-5 text-blue-600"}),n.jsx("span",{className:"text-xs font-bold text-blue-900",children:"Chụp 360°"})]}),n.jsxs("button",{onClick:()=>Ne("Dọn cỏ"),className:"p-3 bg-green-50 hover:bg-green-100 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95",children:[n.jsx("span",{className:"text-xl",children:"🌱"}),n.jsx("span",{className:"text-xs font-bold text-green-900",children:"Dọn cỏ"})]}),n.jsxs("button",{onClick:()=>Ne("Cắm mốc"),className:"p-3 bg-orange-50 hover:bg-orange-100 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95",children:[n.jsx("span",{className:"text-xl",children:"📍"}),n.jsx("span",{className:"text-xs font-bold text-orange-900",children:"Cắm mốc"})]})]})]})]}),n.jsx("div",{className:"mt-2 bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl p-4 text-center",children:n.jsx("p",{className:"text-xs text-slate-400 font-medium",children:"📢 Liên hệ quảng cáo tại đây"})})]}),U==="listing"&&b&&n.jsxs("div",{className:"animate-in slide-in-from-right-8 duration-300",children:[n.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[n.jsx("button",{onClick:()=>D("info"),className:"p-2 bg-slate-100 rounded-full",children:n.jsx(Gs,{className:"w-6 h-6 text-slate-600"})}),n.jsx("h2",{className:"text-xl font-black text-slate-900",children:"Chi tiết rao bán"})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"p-4 bg-slate-50 border border-slate-200 rounded-2xl",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),n.jsx("span",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:"Dữ liệu GIS xác thực"})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsxs("div",{children:[n.jsx("p",{className:"text-[9px] text-slate-400 font-bold uppercase",children:"Tờ"}),n.jsx("p",{className:"font-black text-slate-700",children:b.so_to})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-[9px] text-slate-400 font-bold uppercase",children:"Thửa"}),n.jsx("p",{className:"font-black text-slate-700",children:b.so_thua})]}),n.jsxs("div",{children:[n.jsx("p",{className:"text-[9px] text-slate-400 font-bold uppercase",children:"DT (m²)"}),n.jsx("p",{className:"font-black text-slate-700",children:b.dien_tich})]})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block",children:"Giá bán (VNĐ)"}),n.jsxs("div",{className:"relative",children:[n.jsx(Ks,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-300"}),n.jsx("input",{type:"number",className:"w-full h-14 bg-white border border-slate-200 rounded-xl pl-11 pr-4 font-bold outline-none focus:border-blue-500",placeholder:"Nhập giá...",value:C.price,onChange:m=>te({...C,price:m.target.value})})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block",children:"SĐT liên hệ"}),n.jsxs("div",{className:"relative",children:[n.jsx(Ke,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-300"}),n.jsx("input",{className:"w-full h-14 bg-white border border-slate-200 rounded-xl pl-11 pr-4 font-bold outline-none focus:border-blue-500",placeholder:"09xxx...",value:C.phone,onChange:m=>te({...C,phone:m.target.value})})]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block",children:"Ghi chú (Tùy chọn)"}),n.jsx("textarea",{className:"w-full h-24 bg-white border border-slate-200 rounded-xl p-4 font-medium text-sm outline-none focus:border-blue-500 resize-none",placeholder:"Mô tả ưu điểm thửa đất, hướng, pháp lý...",value:C.note,onChange:m=>te({...C,note:m.target.value})})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"text-[10px] font-bold text-slate-400 uppercase ml-2 mb-2 block",children:["Hình ảnh thực tế (",C.images.length,"/5)"]}),n.jsxs("div",{className:"flex gap-3 overflow-x-auto pb-2 scrollbar-hide",children:[C.images.length<5&&n.jsxs("label",{className:"w-20 h-20 shrink-0 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all",children:[n.jsx(Ze,{className:"w-5 h-5 text-slate-400"}),n.jsx("input",{type:"file",multiple:!0,className:"hidden",onChange:Tr,accept:"image/*"})]}),C.images.map((m,p)=>n.jsxs("div",{className:"relative w-20 h-20 shrink-0",children:[n.jsx("img",{src:m,className:"w-full h-full object-cover rounded-2xl border border-slate-100"}),n.jsx("button",{onClick:()=>te({...C,images:C.images.filter((F,v)=>v!==p)}),className:"absolute -top-1 -right-1 bg-red-500 text-white p-1 rounded-full shadow-lg",children:n.jsx(ke,{className:"w-2 h-2"})})]},p))]})]}),n.jsx("button",{onClick:Cr,disabled:be||!C.phone||!C.price,className:`w-full h-16 rounded-2xl font-black text-lg flex items-center justify-center gap-3 transition-all
                        ${be||!C.phone||!C.price?"bg-slate-200 text-slate-400":"bg-blue-600 text-white shadow-xl active:scale-95"}
                      `,children:be?"Đang đăng tin...":n.jsxs(n.Fragment,{children:[n.jsx(Tt,{className:"w-5 h-5"})," Hoàn tất đăng tin"]})})]})]}),U==="listing-detail"&&f&&n.jsxs("div",{className:"animate-in fade-in slide-in-from-bottom-4 duration-300",children:[(Me().length>0||f.createdAt&&((a=window.DateFormatter)==null?void 0:a.isOldListing(f.createdAt)))&&n.jsxs("div",{className:"flex gap-2 mb-4 flex-wrap",children:[Me().map((m,p)=>n.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm
                            ${m.includes("Giá tốt")||m.includes("Hợp lý")?"bg-green-100 text-green-700 border border-green-200":m.includes("Cao cấp")||m.includes("Hạng sang")?"bg-purple-100 text-purple-700 border border-purple-200":m.includes("Mới đăng")?"bg-blue-100 text-blue-700 border border-blue-200":m.includes("Đã xác thực")?"bg-emerald-100 text-emerald-700 border border-emerald-200":"bg-slate-100 text-slate-700 border border-slate-200"}
                          `,children:m},p)),f.createdAt&&((i=window.DateFormatter)==null?void 0:i.isOldListing(f.createdAt))&&n.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm bg-gray-100 text-gray-600 border border-gray-300",children:"⏳ Tin cũ - Cần xác thực lại"})]}),n.jsxs("div",{className:"flex justify-between items-start mb-6",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-2xl font-black text-slate-900 leading-tight",children:f.loaiGiaoDich==="ban-dat"?"🏷️ Bán đất":f.loaiGiaoDich==="ban-nha"?"🏠 Bán nhà":f.loaiGiaoDich==="cho-thue"?"🔑 Cho thuê":"Tin đăng"}),n.jsxs("p",{className:"text-sm text-slate-500 font-medium flex items-center gap-1 mt-1",children:[n.jsx(De,{className:"w-4 h-4 text-red-500"})," Tờ ",f.so_to||"N/A"," / Thửa ",f.so_thua||"N/A"]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:()=>ee(!0),className:"p-2 bg-amber-50 hover:bg-amber-100 rounded-full transition-colors","aria-label":"Mời cà phê",children:n.jsx(We,{className:"w-5 h-5 text-amber-600"})}),n.jsx("button",{onClick:()=>{Q(null)},className:"p-2 bg-slate-100 rounded-full",children:n.jsx(ke,{className:"w-5 h-5 text-slate-400"})})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[n.jsxs("div",{className:"bg-slate-50 p-4 rounded-2xl border border-slate-100",children:[n.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1",children:"Diện tích"}),n.jsxs("p",{className:"text-lg font-black text-slate-800",children:[f.dien_tich," m²"]})]}),n.jsxs("div",{className:"bg-slate-50 p-4 rounded-2xl border border-slate-100",children:[n.jsx("p",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1",children:"Giá bán"}),n.jsx("p",{className:"text-lg font-black text-slate-800",children:f.isNegotiable?"Thương lượng":f.priceValue>0?window.PriceService.formatCurrency(f.priceValue):"Liên hệ"})]})]}),f.note&&n.jsxs("div",{className:"bg-blue-50 border border-blue-100 p-5 rounded-2xl mb-6",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[n.jsx(Ws,{className:"w-4 h-4 text-blue-500"}),n.jsx("span",{className:"text-[10px] font-bold text-blue-600 uppercase tracking-widest",children:"Ghi chú"})]}),n.jsx("p",{className:"text-sm text-slate-700 leading-relaxed",children:f.note})]}),le()&&n.jsxs("div",{className:"backdrop-blur-sm bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-100 p-5 rounded-2xl mb-6",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx(Ct,{className:"w-5 h-5 text-indigo-600"}),n.jsx("span",{className:"text-xs font-bold text-indigo-900 uppercase tracking-widest",children:"AI Đánh giá"})]}),n.jsxs("div",{className:"flex items-start gap-3",children:[((o=le())==null?void 0:o.type)==="good"&&n.jsx(St,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),((l=le())==null?void 0:l.type)==="high"&&n.jsx(Lt,{className:"w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5"}),((d=le())==null?void 0:d.type)==="potential"&&n.jsx(_t,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),n.jsx("p",{className:"text-sm text-slate-700 leading-relaxed font-medium",children:(h=le())==null?void 0:h.message})]})]}),n.jsxs("div",{className:"bg-slate-50 border border-slate-200 p-5 rounded-2xl mb-6",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),n.jsx("span",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:"Thông tin liên hệ"})]}),n.jsx("p",{className:"font-bold text-slate-900 mb-1",children:f.userName}),f.phone&&n.jsxs("a",{href:`tel:${f.phone}`,className:"text-blue-600 font-semibold flex items-center gap-2 hover:underline",children:[n.jsx(Ke,{className:"w-4 h-4"}),f.phone]})]}),n.jsxs("div",{className:"flex flex-col gap-3",children:[f.phone&&n.jsxs("a",{href:`tel:${f.phone}`,onClick:()=>Z("heavy"),className:"w-full h-16 bg-gradient-to-r from-green-600 to-green-500 text-white rounded-2xl font-black text-lg flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all hover:shadow-2xl",children:[n.jsx(Ke,{className:"w-6 h-6"})," Gọi điện ngay"]}),n.jsxs("div",{className:"flex gap-3",children:[n.jsx("button",{onClick:()=>{Z("medium"),window.BookmarkService.toggleBookmark(f.id),Q({...f})},className:"flex-1 backdrop-blur-sm bg-slate-100/80 text-slate-700 h-14 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition-all",children:(u=window.BookmarkService)!=null&&u.isBookmarked(f.id)?n.jsxs(n.Fragment,{children:[n.jsx(Xs,{className:"w-4 h-4"})," Đã lưu"]}):n.jsxs(n.Fragment,{children:[n.jsx(qs,{className:"w-4 h-4"})," Lưu"]})}),n.jsxs("button",{onClick:()=>{var m;Z("light");const p=window.LinkService.generateListingShareLink(f.id,f.coordinates[0],f.coordinates[1]);(m=navigator.clipboard)==null||m.writeText(p),$e("Link đã được copy!")},className:"flex-1 bg-slate-100 text-slate-600 h-14 rounded-2xl font-bold text-sm flex items-center justify-center gap-2",children:[n.jsx(kt,{className:"w-4 h-4"})," Chia sẻ"]}),n.jsxs("button",{onClick:()=>{f.coordinates&&window.MapController.flyToCoordinates(f.coordinates[0],f.coordinates[1],18)},className:"flex-1 bg-slate-100 text-slate-600 h-14 rounded-2xl font-bold text-sm flex items-center justify-center gap-2",children:[n.jsx(De,{className:"w-4 h-4"})," Vị trí"]})]}),n.jsxs("div",{className:"mt-2 pt-4 border-t border-slate-200",children:[n.jsx("p",{className:"text-xs font-bold text-slate-500 uppercase tracking-widest mb-3",children:"Dịch vụ hỗ trợ"}),n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsxs("button",{onClick:()=>Ne("Chụp 360°"),className:"p-3 bg-blue-50 hover:bg-blue-100 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95",children:[n.jsx(Ze,{className:"w-5 h-5 text-blue-600"}),n.jsx("span",{className:"text-xs font-bold text-blue-900",children:"Chụp 360°"})]}),n.jsxs("button",{onClick:()=>Ne("Dọn cỏ"),className:"p-3 bg-green-50 hover:bg-green-100 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95",children:[n.jsx("span",{className:"text-xl",children:"🌱"}),n.jsx("span",{className:"text-xs font-bold text-green-900",children:"Dọn cỏ"})]}),n.jsxs("button",{onClick:()=>Ne("Cắm mốc"),className:"p-3 bg-orange-50 hover:bg-orange-100 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95",children:[n.jsx("span",{className:"text-xl",children:"📍"}),n.jsx("span",{className:"text-xs font-bold text-orange-900",children:"Cắm mốc"})]})]})]}),n.jsx("div",{className:"mt-2 bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl p-4 text-center",children:n.jsx("p",{className:"text-xs text-slate-400 font-medium",children:"📢 Liên hệ quảng cáo tại đây"})})]})]}),U==="success"&&n.jsxs("div",{className:"flex flex-col items-center justify-center py-16 animate-in zoom-in-95 duration-500",children:[n.jsx("div",{className:"w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 shadow-inner",children:n.jsx(Zs,{className:"w-14 h-14 text-green-600"})}),n.jsx("h2",{className:"text-2xl font-black text-slate-900 mb-2",children:"Thành công!"}),n.jsx("p",{className:"text-slate-500 text-center max-w-[240px] text-sm leading-relaxed",children:"Tin rao của bạn đã được liên kết với dữ liệu GIS và đang chờ duyệt."})]})]})]})}),re&&n.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm",onClick:()=>E(!1),children:n.jsxs("div",{className:"bg-white rounded-3xl p-6 max-w-sm mx-4 shadow-2xl",onClick:m=>m.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between mb-6",children:[n.jsx("h3",{className:"text-xl font-black text-slate-900",children:"📋 Yêu cầu dịch vụ"}),n.jsx("button",{onClick:()=>E(!1),className:"p-2 hover:bg-slate-100 rounded-full",children:n.jsx(ke,{className:"w-5 h-5 text-slate-400"})})]}),n.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-2xl",children:[n.jsxs("p",{className:"text-sm font-bold text-slate-900 mb-1",children:["Dịch vụ: ",he]}),n.jsxs("p",{className:"text-xs text-slate-600",children:[b&&`Tờ ${b.so_to}, Thửa ${b.so_thua}`,f&&`Tờ ${f.so_to}, Thửa ${f.so_thua}`]})]}),n.jsxs("div",{className:"mb-6",children:[n.jsx("label",{className:"block text-sm font-bold text-slate-700 mb-2",children:"Số điện thoại liên hệ"}),n.jsx("input",{type:"tel",placeholder:"Nhập số điện thoại...",value:pe,onChange:m=>xe(m.target.value),className:"w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none text-slate-900 font-semibold"})]}),n.jsxs("button",{onClick:Lr,className:"w-full h-14 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-2xl font-bold text-base flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all hover:shadow-xl",children:[n.jsx(Tt,{className:"w-5 h-5"})," Gửi yêu cầu qua Zalo"]}),n.jsx("p",{className:"text-xs text-slate-500 text-center mt-3",children:"Yêu cầu sẽ được gửi đến Admin qua Zalo"})]})}),ne&&n.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm",onClick:()=>ee(!1),children:n.jsxs("div",{className:"bg-white rounded-3xl p-6 max-w-sm mx-4 shadow-2xl text-center",onClick:m=>m.stopPropagation(),children:[n.jsx("div",{className:"flex justify-end mb-2",children:n.jsx("button",{onClick:()=>ee(!1),className:"p-2 hover:bg-slate-100 rounded-full",children:n.jsx(ke,{className:"w-5 h-5 text-slate-400"})})}),n.jsx(We,{className:"w-16 h-16 text-amber-600 mx-auto mb-4"}),n.jsx("h3",{className:"text-2xl font-black text-slate-900 mb-2",children:"☕ Mời cà phê"}),n.jsx("p",{className:"text-sm text-slate-600 mb-6",children:"Nếu ứng dụng hữu ích với bạn, hãy mời chúng tôi ly cà phê nhé! ❤️"}),n.jsx("div",{className:"bg-slate-100 rounded-2xl p-6 mb-4 flex items-center justify-center",children:n.jsx(Qs,{className:"w-32 h-32 text-slate-400"})}),n.jsx("p",{className:"text-xs text-slate-500 mb-2",children:"Quét mã QR để gửi qua Momo/Banking"}),n.jsxs("p",{className:"text-xs font-bold text-slate-700",children:["Số tài khoản: ",S]}),n.jsxs("p",{className:"text-xs text-slate-600",children:["Ngân hàng: ",R," - Chủ TK: ",de]}),n.jsx("div",{className:"mt-6 bg-amber-50 border border-amber-100 rounded-xl p-3",children:n.jsx("p",{className:"text-xs text-amber-800 font-medium",children:"🙏 Cảm ơn sự ủng hộ của bạn!"})})]})})]})};window.App=ea;const ta=window.React,ra=window.ReactDOM,sa=()=>{try{const r={href:"https://xemgiadat.com/",origin:"https://xemgiadat.com",protocol:"https:",host:"xemgiadat.com",hostname:"xemgiadat.com",pathname:"/",search:"",hash:"",toString:()=>"https://xemgiadat.com/"};window.__SAFE_LOCATION__=r;try{const e=new Proxy(window.location,{get:(t,s)=>{if(s in r)return r[s];try{return t[s]}catch{return}}});Object.defineProperty(window,"location",{value:e,configurable:!0,enumerable:!0})}catch{console.warn("Location proxy assignment restricted, using fallback.")}}catch(r){console.error("Bypass location failed:",r)}};sa();const aa=window.App,Pt=document.getElementById("root");Pt&&ra.createRoot(Pt).render(n.jsx(ta.StrictMode,{children:n.jsx(aa,{})}));
