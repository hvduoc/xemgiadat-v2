<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XemGiaDat V5.1 - GIS Standalone Pro</title>
    
    <!-- CDNs ƒêI·ªÄU KI·ªÜN TI√äN QUY·∫æT -->
    <script type="importmap">
    {
        "imports": {
            "pmtiles": "https://unpkg.com/pmtiles@3.2.0/dist/index.js"
        }
    }
    </script>
    
    <!-- Critical Initialization utilities (INLINED for reliability) -->
    <script>
    /**
     * XemGiaDat V2 - Critical Initialization (Inlined)
     * MUST be inline to ensure app reliability even if external files fail
     */
    (function() {
      'use strict';

      console.log('[INIT] XemGiaDat v2 initialization started (Vector Parcels mode)');

      /**
       * 1. CDN LOAD STATUS TRACKER
       */
      window.__CDN_LOAD_STATUS__ = {};
      window.__trackCDN = function(name, success) {
        window.__CDN_LOAD_STATUS__[name] = success;
        console.log('[CDN] ' + name + ': ' + (success ? '‚úì OK' : '‚úó FAILED'));
      };

      console.log('[INIT] ‚úì Critical utilities initialized inline');
    })();
    </script>
    
    <!-- Initialization utilities (refactored) -->
    <script type="module" src="./src/scripts/init.js?v=5.1"></script>
    
    <!-- Core Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.1/dist/maplibre-gl.js" onload="window.__trackCDN('maplibregl', true)" onerror="window.__trackCDN('maplibregl', false)"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" onload="window.__trackCDN('react', true)" onerror="window.__trackCDN('react', false)"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" onload="window.__trackCDN('react-dom', true)" onerror="window.__trackCDN('react-dom', false)"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js" onload="window.__trackCDN('babel', true)" onerror="window.__trackCDN('babel', false)"></script>
    <script src="https://cdn.tailwindcss.com" onerror="console.warn('[CDN] Tailwind CDN failed')"></script>
    
    <!-- Firebase (Compat SDK) + FirebaseUI -->
    <link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
    
    <!-- PMTiles Setup via ES Module -->
    <script type="module">
        import * as pmtiles from 'pmtiles';
        
        // Expose to window for backward compatibility
        window.pmtiles = pmtiles;
        window.__trackCDN('pmtiles', true);
        console.log('[PMTiles] ‚úì Loaded via ES module:', pmtiles);
        
        // Register protocol immediately
        if (window.maplibregl) {
            const protocol = new pmtiles.Protocol();
            window.maplibregl.addProtocol("pmtiles", protocol.tile);
            window.__pmtiles_registered = true;
            console.log('[PMTiles] ‚úì Protocol registered');
        } else {
            // Wait for maplibregl to load
            const checkMapLibre = setInterval(() => {
                if (window.maplibregl) {
                    clearInterval(checkMapLibre);
                    const protocol = new pmtiles.Protocol();
                    window.maplibregl.addProtocol("pmtiles", protocol.tile);
                    window.__pmtiles_registered = true;
                    console.log('[PMTiles] ‚úì Protocol registered (delayed)');
                }
            }, 100);
        }
    </script>

    <!-- Main Application Styles (Refactored) -->
    <link rel="stylesheet" href="./src/styles/main.css?v=4.2" />
</head>
<body>
    <div id="root"></div>
    <script>

        /**
         * 2. MAP CONTROLLER (Inline Implementation)
         */
        const normalizeParcelProps = (props) => {
            // PMTiles actual property names (from log): SoThuTuThua, SoHieuToBanDo, DienTich, KyHieuMucDichSuDung
            const so_thua = String(props.SoThuTuThua || props['S·ªë th·ª≠a'] || props.soThua || props.so_thua || '');
            const so_to = String(props.SoHieuToBanDo || props['S·ªë hi·ªáu t·ªù b·∫£n ƒë·ªì'] || props.soTo || props.so_to || '');
            const muc_dich = props.KyHieuMucDichSuDung || props['K√Ω hi·ªáu m·ª•c ƒë√≠ch s·ª≠ d·ª•ng'] || props.loaiDat || props.muc_dich || 'Ch∆∞a r√µ';
            const dien_tich_raw = props.DienTich ?? props['Di·ªán t√≠ch'] ?? props.dienTich ?? props.dien_tich ?? props.area ?? props.SHAPE_Area ?? props.Shape_Area ?? 0;
            const dien_tich = parseFloat(dien_tich_raw) || 0;
            const dia_chi_raw = props['ƒê·ªãa ch·ªâ'] || props.diaChi || props.dia_chi || props.DiaChi || '';
            const dia_chi = (dia_chi_raw && dia_chi_raw !== 'Null' && dia_chi_raw !== 'null') ? dia_chi_raw : 'Ch∆∞a c√≥';
            const ma_xa = String(props.MaXa || props['M√£ x√£'] || props.maXa || props.ma_xa || '');
            const object_id = props.OBJECTID || props.objectid || props.ObjectId || props.id || props.ID || '';
            
            return {
                so_thua,
                so_to,
                muc_dich,
                dien_tich,
                dia_chi,
                ma_xa,
                object_id
            };
        };

        /**
         * 3. HAVERSINE DISTANCE CALCULATION (adapted from old project)
         * Calculate distance between two lat/lng points in meters
         */
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371000; // Earth radius in meters
            const toRad = (deg) => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };

        /**
         * 4. DIMENSION DRAWER (adapted from old project for MapLibre)
         * Draw dimension labels on polygon edges
         */
        const clearDimensionLabels = () => {
            const container = document.querySelector('.maplibregl-canvas')?.parentElement;
            if (container) {
                container.querySelectorAll('.dimension-label-container').forEach(el => el.remove());
            }
        };

        // Store currently selected feature for redrawing on zoom/pan
        let selectedFeatureForDimensions = null;
        
        // Expose for React component to access
        window.__clearDimensionsAndHighlight = (map) => {
            clearDimensionLabels();
            selectedFeatureForDimensions = null;
            if (map && map.getLayer) {
                try {
                    map.setFilter('parcels-highlight', ['==', 'OBJECTID', -1]);
                    map.setFilter('parcels-highlight-fill', ['==', 'OBJECTID', -1]);
                } catch (e) {
                    console.warn('[Cleanup] Could not clear highlight:', e);
                }
            }
        };

        // Helper function to create fallback marker and show bottom sheet
        const createFallbackMarker = (map, lng, lat, errorType = 'not_found') => {
            const fallbackMarker = new maplibregl.Marker({ color: '#ef4444' })
                .setLngLat([lng, lat])
                .addTo(map);
            
            return {
                id: 'fallback-' + crypto.randomUUID(),
                so_thua: 'N/A',
                so_to: 'N/A',
                dien_tich: 'N/A',
                muc_dich: errorType === 'error' ? 'L·ªói t·∫£i d·ªØ li·ªáu' : 'Ch∆∞a x√°c ƒë·ªãnh',
                dia_chi: `T·ªça ƒë·ªô: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                ma_xa: '',
                coordinates: [lng, lat],
                isFallback: true
            };
        };

        const drawDimensions = (feature, map) => {
            clearDimensionLabels();
            
            if (!feature?.geometry?.coordinates || !map) return;
            
            // Store feature for redrawing on map move
            selectedFeatureForDimensions = feature;
            
            // Extract coordinates based on geometry type
            let coords = feature.geometry.type === 'Polygon'
                ? feature.geometry.coordinates?.[0]
                : feature.geometry.coordinates?.[0]?.[0];
                
            if (!Array.isArray(coords) || coords.length < 2) return;
            
            const MIN_DISPLAY_DIST = 2; // meters threshold
            const container = document.querySelector('.maplibregl-canvas')?.parentElement;
            if (!container) return;
            
            let shortGroup = [];
            let totalShortDist = 0;
            
            const drawLabel = (points, dist) => {
                // Calculate center (midpoint) of points
                const flat = points.flat();
                const midIdx = Math.floor(flat.length / 2);
                const mid = flat.length % 2 === 0
                    ? [
                        (flat[midIdx - 1][0] + flat[midIdx][0]) / 2,
                        (flat[midIdx - 1][1] + flat[midIdx][1]) / 2
                    ]
                    : flat[midIdx];
                
                try {
                    // Convert to screen coordinates using MapLibre projection
                    const screenPos = map.project([mid[0], mid[1]]);
                    
                    // Create marker element
                    const marker = document.createElement('div');
                    marker.className = 'dimension-label-container';
                    marker.innerHTML = `<div class="dimension-label">${Math.round(dist)}m</div>`;
                    marker.style.left = screenPos.x + 'px';
                    marker.style.top = screenPos.y + 'px';
                    
                    container.appendChild(marker);
                } catch (e) {
                    console.warn('[Dimensions] Failed to project coordinates:', e);
                }
            };
            
            // Process each edge
            for (let i = 0; i < coords.length - 1; i++) {
                const p1 = coords[i];
                const p2 = coords[i + 1];
                const dist = calculateDistance(p1[1], p1[0], p2[1], p2[0]);
                
                if (dist < MIN_DISPLAY_DIST) {
                    // Group short edges
                    shortGroup.push([p1, p2]);
                    totalShortDist += dist;
                } else {
                    // Flush short group if accumulated distance is significant
                    if (shortGroup.length > 0 && totalShortDist >= MIN_DISPLAY_DIST) {
                        drawLabel(shortGroup, totalShortDist);
                    }
                    shortGroup = [];
                    totalShortDist = 0;
                    
                    // Draw long edge
                    drawLabel([[p1, p2]], dist);
                }
            }
            
            // Flush remaining short group
            if (shortGroup.length > 0 && totalShortDist >= MIN_DISPLAY_DIST) {
                drawLabel(shortGroup, totalShortDist);
            }
            
            console.log('[Dimensions] ‚úì Drawn on parcel');
        };

        window.MapController = class MapController {
            static instance = null;

            constructor(map) {
                this.map = map;
            }

            static setInstance(instance) {
                MapController.instance = instance;
            }

            static getMap() {
                return MapController.instance ? MapController.instance.map : null;
            }

            static flyToParcel(soTo, soThua) {
                if (!MapController.instance) return null;
                return MapController.instance.flyToParcel(soTo, soThua);
            }

            flyToParcel(soTo, soThua) {
                if (!this.map) return null;

                const features = this.map.querySourceFeatures('parcels', {
                    sourceLayer: 'default'
                });

                const targetFeature = features.find(f => {
                    const props = f.properties || {};
                    const normalized = normalizeParcelProps(props);
                    return normalized.so_to === soTo && normalized.so_thua === soThua;
                });

                if (!targetFeature) return null;

                let center = [108.2022, 16.0544];
                if (targetFeature.geometry?.type === 'Polygon' && targetFeature.geometry.coordinates?.[0]?.[0]) {
                    const coords = targetFeature.geometry.coordinates[0];
                    const lngs = coords.map(c => c[0]);
                    const lats = coords.map(c => c[1]);
                    center = [
                        (Math.min(...lngs) + Math.max(...lngs)) / 2,
                        (Math.min(...lats) + Math.max(...lats)) / 2
                    ];
                }

                this.map.flyTo({
                    center,
                    zoom: 18,
                    duration: 1500,
                    essential: true
                });

                const parcelId = targetFeature.id || targetFeature.properties?.OBJECTID;
                if (parcelId) {
                    setTimeout(() => {
                        this.map.setFilter('parcels-highlight', ['==', 'OBJECTID', parcelId]);
                        this.map.setFilter('parcels-highlight-fill', ['==', 'OBJECTID', parcelId]);
                    }, 1600);
                }

                return targetFeature;
            }
        };

        /**
         * 3. SEARCH MODULE (Inline Implementation)
         */
        window.SearchModule = class SearchModule {
            search(query, parcels) {
                const q = query.toLowerCase().trim();
                if (!q) return [];

                return parcels
                    .map(p => {
                        let score = 0;
                        const so_thua = (p.so_thua || '').toLowerCase();
                        const so_to = (p.so_to || '').toLowerCase();
                        const dia_chi = (p.dia_chi || '').toLowerCase();

                        if (so_thua === q) score += 100;
                        else if (so_thua.includes(q)) score += 50;

                        if (so_to === q) score += 80;
                        else if (so_to.includes(q)) score += 40;

                        const addrMatch = dia_chi.indexOf(q);
                        if (addrMatch !== -1) score += (20 - addrMatch / 10);

                        return { parcel: p, score };
                    })
                    .filter(r => r.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);
            }
        };

        /**
         * 4. SEARCH SERVICE (Inline Implementation)
         */
        window.SearchService = class SearchService {
            constructor() {
                this.searchModule = new window.SearchModule();
                this.featureCache = new Map();
                this.lastCacheUpdate = 0;
            }

            updateCache(map) {
                if (!map) return;
                
                try {
                    const features = map.queryRenderedFeatures({
                        layers: ['parcels-fill-clickable']
                    });

                    if (features && features.length > 0) {
                        features.forEach(f => {
                            const props = f.properties || {};
                            const id = f.id || props.OBJECTID;
                            const normalized = normalizeParcelProps(props);
                            
                            if (id && normalized.so_thua && normalized.so_to) {
                                let coordinates = [108.2022, 16.0544];
                                if (f.geometry?.type === 'Polygon' && f.geometry.coordinates?.[0]?.[0]) {
                                    const coords = f.geometry.coordinates[0];
                                    const lngs = coords.map(c => c[0]);
                                    const lats = coords.map(c => c[1]);
                                    coordinates = [
                                        (Math.min(...lngs) + Math.max(...lngs)) / 2,
                                        (Math.min(...lats) + Math.max(...lats)) / 2
                                    ];
                                }

                                this.featureCache.set(id, {
                                    id: id,
                                    so_thua: normalized.so_thua,
                                    so_to: normalized.so_to,
                                    dien_tich: normalized.dien_tich,
                                    muc_dich: normalized.muc_dich,
                                    ma_xa: normalized.ma_xa,
                                    dia_chi: normalized.dia_chi,
                                    object_id: normalized.object_id,
                                    coordinates
                                });
                            }
                        });
                        
                        this.lastCacheUpdate = Date.now();
                        console.log(`[Cache] Updated: ${this.featureCache.size} features`);
                    }
                } catch (err) {
                    console.error('[Cache] Update error:', err);
                }
            }

            async searchParcels(query) {
                const map = window.MapController.getMap();
                if (!query || !map) return [];
                
                try {
                    if (this.featureCache.size === 0 || Date.now() - this.lastCacheUpdate > 5000) {
                        this.updateCache(map);
                    }

                    const parcels = Array.from(this.featureCache.values());

                    if (parcels.length === 0) {
                        console.warn('[Search] Cache tr·ªëng. H√£y zoom v√†o khu v·ª±c ƒê√† N·∫µng v√† th·ª≠ l·∫°i.');
                        return [];
                    }

                    const results = this.searchModule.search(query, parcels);
                    console.log(`[Search] "${query}" ‚Üí ${results.length} k·∫øt qu·∫£ t·ª´ ${parcels.length} features`);
                    return results.map(r => r.parcel);
                } catch (err) {
                    console.error('[Search] Error:', err);
                    return [];
                }
            }

            async find(soTo, soThua) {
                if (!soTo || !soThua) return null;
                const results = await this.searchParcels(`${soTo} ${soThua}`);
                const exact = results.find(p => p.so_to === soTo && p.so_thua === soThua);
                const found = exact || (results.length > 0 ? results[0] : null);

                if (found) {
                    window.MapController.flyToParcel(soTo, soThua);
                }

                return found;
            }
        };

        /**
         * 5. DATE FORMATTER (Inline Implementation)
         */
        window.DateFormatter = {
            formatDateVN: (timestamp) => {
                try {
                    let date;
                    
                    if (timestamp && typeof timestamp === 'object' && 'toDate' in timestamp) {
                        date = timestamp.toDate();
                    } else if (typeof timestamp === 'number') {
                        date = new Date(timestamp);
                    } else if (timestamp instanceof Date) {
                        date = timestamp;
                    } else {
                        return 'N/A';
                    }

                    const now = new Date();
                    const diffMs = now.getTime() - date.getTime();
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) return 'V·ª´a xong';
                    if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;

                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                } catch (error) {
                    console.error('Date formatting error:', error);
                    return 'N/A';
                }
            },
            
            isOldListing: (timestamp) => {
                try {
                    let date;
                    
                    if (timestamp && typeof timestamp === 'object' && 'toDate' in timestamp) {
                        date = timestamp.toDate();
                    } else if (typeof timestamp === 'number') {
                        date = new Date(timestamp);
                    } else if (timestamp instanceof Date) {
                        date = timestamp;
                    } else {
                        return false;
                    }

                    const now = new Date();
                    const diffMs = now.getTime() - date.getTime();
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                    return diffDays > 30;
                } catch (error) {
                    console.error('Date check error:', error);
                    return false;
                }
            }
        };

        /**
         * 6. LAND PARCEL SERVICE (Sharded Data Loading)
         */
        window.LandParcelService = {
            SHARD_DIR: './data/parcels',
            indexCacheByMaXa: {},
            communeListCache: null,
            loadPromises: {},
            communeListPromise: null,
            RAW_FALLBACK_BASE: 'https://raw.githubusercontent.com/hvduoc/xemgiadat-v2/main/public/data/parcels',

            async loadCommuneList() {
                if (this.communeListCache) return this.communeListCache;
                if (this.communeListPromise) return this.communeListPromise;

                this.communeListPromise = (async () => {
                    try {
                        const urls = [
                            `${this.SHARD_DIR}/communes.json`,
                            `${this.RAW_FALLBACK_BASE}/communes.json`
                        ];
                        let response = null;
                        for (const url of urls) {
                            try {
                                const res = await fetch(url, { cache: 'no-store' });
                                if (res.ok) { response = res; break; }
                            } catch (e) { /* try next */ }
                        }
                        if (!response) throw new Error('Failed to load commune list');
                        const data = await response.json();
                        this.communeListCache = Array.isArray(data?.communes) ? data.communes.map(String) : [];
                    } catch (err) {
                        console.error('[LandParcelService] Commune list failed:', err);
                        this.communeListCache = [];
                    }
                    return this.communeListCache;
                })();

                return this.communeListPromise;
            },

            async getCommuneList() {
                return this.communeListCache || await this.loadCommuneList();
            },

            async loadIndexForMaXa(maXa) {
                const key = String(maXa || '').trim();
                if (!key) return;
                if (this.indexCacheByMaXa[key]) return;
                if (this.loadPromises[key]) return this.loadPromises[key];

                this.loadPromises[key] = (async () => {
                    try {
                        const urls = [
                            `${this.SHARD_DIR}/${key}.json`,
                            `${this.RAW_FALLBACK_BASE}/${key}.json`
                        ];
                        let response = null;
                        for (const url of urls) {
                            try {
                                const res = await fetch(url, { cache: 'no-store' });
                                if (res.ok) { response = res; break; }
                            } catch (e) { /* try next */ }
                        }
                        if (!response) throw new Error(`Shard load failed: ${key}`);
                        const data = await response.json();
                        const index = data?.index;
                        this.indexCacheByMaXa[key] = (index && typeof index === 'object') ? index : {};
                    } catch (err) {
                        console.error('[LandParcelService] Shard load failed:', err);
                        this.indexCacheByMaXa[key] = {};
                    }
                })();

                return this.loadPromises[key];
            },

            normalizeParcelKey(parcelNumber) {
                const trimmed = (parcelNumber || '').trim();
                if (!trimmed) return null;
                if (trimmed.includes(':')) return trimmed;
                const parts = trimmed.split(/[\s/]+/).filter(Boolean);
                if (parts.length < 2) return null;
                const soTo = parseInt(parts[0], 10);
                const soThua = parseInt(parts[1], 10);
                if (isNaN(soTo) || isNaN(soThua)) return null;
                return `${soTo}:${soThua}`;
            },

            async searchParcelByNumber(parcelNumber, maXa) {
                if (!parcelNumber || !maXa) return null;
                await this.loadIndexForMaXa(maXa);
                const key = this.normalizeParcelKey(parcelNumber);
                if (!key) return null;
                const index = this.indexCacheByMaXa[maXa] || {};
                const coords = index[key];
                if (Array.isArray(coords) && coords.length === 2) {
                    return coords;
                }
                return null;
            }
        };
        // Pre-load commune list
        window.LandParcelService.loadCommuneList().catch(() => {});
        console.log('[Init] LandParcelService ready (sharded mode)');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        /**
         * 5. ICONS (SVG Inline)
         */
        const Icons = {
            Search: () => <svg className="w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            MapPin: () => <svg className="w-4 h-4 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            X: () => <svg className="w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18M6 6l12 12"/></svg>,
            Rocket: () => <svg className="w-6 h-6 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/></svg>,
            Camera: () => <svg className="w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            ArrowLeft: () => <svg className="w-6 h-6 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7M5 12h14"/></svg>,
            Check: () => <svg className="w-12 h-12 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M20 6 9 17l-5-5"/></svg>,
            Banknote: () => <svg className="w-5 h-5 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>,
            Phone: () => <svg className="w-4 h-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Share: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.6 13.5 15.4 17.5M15.4 6.5 8.6 10.5"/></svg>,
            Copy: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            User: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21a8 8 0 0 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>,
            Bookmark: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>,
            BookmarkCheck: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/><path d="M9 10l2 2 4-4" stroke="white" strokeWidth="2" fill="none"/></svg>,
            FileText: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>,
            Sparkles: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4M3 5h4M19 17v4M17 19h4"/></svg>,
            TrendingUp: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m22 7-8.5 8.5-5-5L2 17"/><path d="M16 7h6v6"/></svg>,
            TrendingDown: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m22 17-8.5-8.5-5 5L2 7"/><path d="M16 17h6v-6"/></svg>,
            Eye: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Box: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.29 7 8.71 5 8.71-5M12 22V12"/></svg>,
            Navigation: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a2 2 0 1 1-3.2-2.4"/></svg>,
            ChevronDown: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m18 15-6-6-6 6"/></svg>,
            Brain: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            MessageSquare: () => <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z"/></svg>
        };

        /**
                 * 4. UTILS: IMAGE COMPRESSION
         */
        const compressImage = async (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        /**
         * 4.5. BOOKMARK SERVICE
         */
        const BookmarkService = {
            STORAGE_KEY: 'xemgiadat_bookmarks',
            
            getBookmarks() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : [];
                } catch (err) {
                    console.error('[BookmarkService] Failed to get bookmarks:', err);
                    return [];
                }
            },
            
            isBookmarked(listingId) {
                try {
                    const bookmarks = this.getBookmarks();
                    return bookmarks.includes(listingId);
                } catch (err) {
                    console.error('[BookmarkService] Failed to check bookmark:', err);
                    return false;
                }
            },
            
            addBookmark(listingId) {
                try {
                    const bookmarks = this.getBookmarks();
                    if (!bookmarks.includes(listingId)) {
                        bookmarks.push(listingId);
                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(bookmarks));
                        console.log('[BookmarkService] ‚úÖ Bookmark added:', listingId);
                        return true;
                    }
                    return false;
                } catch (err) {
                    console.error('[BookmarkService] Failed to add bookmark:', err);
                    return false;
                }
            },
            
            removeBookmark(listingId) {
                try {
                    const bookmarks = this.getBookmarks();
                    const index = bookmarks.indexOf(listingId);
                    if (index > -1) {
                        bookmarks.splice(index, 1);
                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(bookmarks));
                        console.log('[BookmarkService] üóëÔ∏è Bookmark removed:', listingId);
                        return true;
                    }
                    return false;
                } catch (err) {
                    console.error('[BookmarkService] Failed to remove bookmark:', err);
                    return false;
                }
            },
            
            toggleBookmark(listingId) {
                const isBookmarked = this.isBookmarked(listingId);
                if (isBookmarked) {
                    this.removeBookmark(listingId);
                } else {
                    this.addBookmark(listingId);
                }
                return !isBookmarked;
            }
        };

        window.BookmarkService = BookmarkService;

        /**
         * 4.6. AI INSIGHT SERVICE
         */
        const AIInsightService = {
            priceData: null,
            dataLoaded: false,

            async init() {
                if (this.dataLoaded) return;
                // Data is now sharded per-commune ‚Äî no monolithic file to load
                // Price insights use hardcoded heuristics (area average not available in shards)
                this.dataLoaded = true;
                console.log('[AIInsight] Initialized (sharded mode ‚Äî no monolithic index)');
            },

            getAreaAveragePrice(maXa) {
                if (!this.priceData || !Array.isArray(this.priceData)) return null;
                const relevantParcels = this.priceData.filter(p => p.ma_xa === maXa);
                if (relevantParcels.length === 0) return null;
                const prices = relevantParcels.map(p => p.gia_uoc_tinh).filter(price => price > 0);
                if (prices.length === 0) return null;
                return prices.reduce((sum, price) => sum + price, 0) / prices.length;
            },

            getPriceInsight(parcel) {
                if (!parcel.gia_uoc_tinh || parcel.gia_uoc_tinh <= 0) {
                    return { type: 'unknown', message: 'Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ƒë√°nh gi√°', badge: 'ƒêang c·∫≠p nh·∫≠t' };
                }

                const pricePerM2 = parcel.gia_uoc_tinh / parcel.dien_tich;
                const areaAverage = this.getAreaAveragePrice(parcel.ma_xa);

                if (!areaAverage) {
                    if (parcel.gia_uoc_tinh < 500000000) {
                        return { type: 'good', message: 'Gi√° ph√π h·ª£p v·ªõi th·ªã tr∆∞·ªùng, ti·ªÅm nƒÉng ƒë·∫ßu t∆∞ t·ªët', badge: 'Gi√° t·ªët' };
                    } else if (parcel.gia_uoc_tinh > 2000000000) {
                        return { type: 'high', message: 'M·ª©c gi√° cao, ph√π h·ª£p v·ªõi nh√† ƒë·∫ßu t∆∞ chuy√™n nghi·ªáp', badge: 'Cao c·∫•p' };
                    } else {
                        return { type: 'potential', message: 'V·ªã tr√≠ ƒë·∫πp, gi√° h·ª£p l√Ω cho ƒë·∫ßu t∆∞ d√†i h·∫°n', badge: 'Ti·ªÅm nƒÉng' };
                    }
                }

                const avgPricePerM2 = areaAverage / 100;
                const priceDiff = ((pricePerM2 - avgPricePerM2) / avgPricePerM2) * 100;

                if (priceDiff < -10) {
                    return { type: 'good', message: `Gi√° th·∫•p h∆°n trung b√¨nh khu v·ª±c ${Math.abs(priceDiff).toFixed(0)}%, c∆° h·ªôi ƒë·∫ßu t∆∞ t·ªët`, badge: 'Gi√° t·ªët' };
                } else if (priceDiff > 20) {
                    return { type: 'high', message: `Gi√° cao h∆°n trung b√¨nh khu v·ª±c ${priceDiff.toFixed(0)}%, v·ªã tr√≠ ƒë·∫Øc ƒë·ªãa`, badge: 'Cao c·∫•p' };
                } else {
                    return { type: 'potential', message: 'Gi√° ph√π h·ª£p v·ªõi th·ªã tr∆∞·ªùng, ƒë√°ng ƒë·ªÉ xem x√©t', badge: 'H·ª£p l√Ω' };
                }
            },

            getListingInsight(listing) {
                if (!listing.priceValue || listing.priceValue <= 0) {
                    if (listing.isNegotiable) {
                        return { type: 'potential', message: 'Gi√° c√≥ th·ªÉ th∆∞∆°ng l∆∞·ª£ng, li√™n h·ªá ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt', badge: 'Th∆∞∆°ng l∆∞·ª£ng' };
                    }
                    return { type: 'unknown', message: 'Li√™n h·ªá ch·ªß nh√† ƒë·ªÉ bi·∫øt gi√° ch√≠nh x√°c', badge: 'Li√™n h·ªá' };
                }

                const pricePerM2 = listing.priceValue / listing.dien_tich;

                if (pricePerM2 < 5000000) {
                    return { type: 'good', message: 'M·ª©c gi√° r·∫•t h·ª£p l√Ω, n√™n xem x√©t ƒë·∫ßu t∆∞ ngay', badge: 'Gi√° t·ªët' };
                } else if (pricePerM2 < 15000000) {
                    return { type: 'potential', message: 'Gi√° ph√π h·ª£p v·ªõi th·ªã tr∆∞·ªùng, ƒë√°ng ƒë·ªÉ kh·∫£o s√°t k·ªπ', badge: 'H·ª£p l√Ω' };
                } else if (pricePerM2 < 30000000) {
                    return { type: 'high', message: 'V·ªã tr√≠ ƒë·∫Øc ƒë·ªãa, ph√π h·ª£p kinh doanh ho·∫∑c ƒë·∫ßu t∆∞ cao c·∫•p', badge: 'Cao c·∫•p' };
                } else {
                    return { type: 'high', message: 'B·∫•t ƒë·ªông s·∫£n h·∫°ng sang, khu v·ª±c trung t√¢m ho·∫∑c m·∫∑t ti·ªÅn', badge: 'H·∫°ng sang' };
                }
            },

            getStatusBadges(item) {
                const badges = [];
                if (item.createdAt) {
                    const daysSinceCreated = (Date.now() - new Date(item.createdAt).getTime()) / (1000 * 60 * 60 * 24);
                    if (daysSinceCreated < 7) badges.push('M·ªõi ƒëƒÉng');
                }
                if (item.so_thua && item.so_to) badges.push('ƒê√£ x√°c th·ª±c');
                const insight = item.priceValue ? this.getListingInsight(item) : this.getPriceInsight(item);
                if (insight.badge && !badges.includes(insight.badge)) badges.push(insight.badge);
                return badges.slice(0, 3);
            }
        };

        window.AIInsightService = AIInsightService;
        AIInsightService.init();

        /**
                 * 5. APP COMPONENT
         */
        const App = () => {
            const mapContainer = useRef(null);
            const mapRef = useRef(null);
                const searchServiceRef = useRef(null);
            const [selected, setSelected] = useState(null);
            const [selectedListing, setSelectedListing] = useState(null);
            const [view, setView] = useState('info'); 
            const [searchQuery, setSearchQuery] = useState('');
                const [searchResults, setSearchResults] = useState([]);
                const [isSearching, setIsSearching] = useState(false);
            const [images, setImages] = useState([]);
            const [form, setForm] = useState({ 
                price: '', 
                note: '',
                transactionType: 'ban-dat',
                priceUnit: 'VND',
                isNegotiable: false
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
                const [authUser, setAuthUser] = useState(null);
                const [showLogin, setShowLogin] = useState(false);
                const [showUserMenu, setShowUserMenu] = useState(false);
                const [shareOpen, setShareOpen] = useState(false);
            const [is3DView, setIs3DView] = useState(false);
            const [showProfile, setShowProfile] = useState(false); // Profile section toggle
            const [showAIConsultant, setShowAIConsultant] = useState(false); // AI Consultant toggle
            const [aiQuery, setAiQuery] = useState(''); // AI query input
            const [aiResponse, setAiResponse] = useState(null); // AI response
            const [showStreetView, setShowStreetView] = useState(false); // Street View toggle
            const [knowledgeBase, setKnowledgeBase] = useState([]); // AI Knowledge Base
            
            // Commune dropdown for sharded search
            const [communeOptions, setCommuneOptions] = useState([]);
            const [selectedMaXa, setSelectedMaXa] = useState('');
            const [isCommuneLoading, setIsCommuneLoading] = useState(false);
            
            // Bottom Sheet swipe gesture states
            const [sheetTranslateY, setSheetTranslateY] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const dragStartY = useRef(0);
            const dragStartTranslate = useRef(0);
            
            const LISTINGS_SOURCE_ID = 'user-listings';
            const LISTINGS_LAYER_CLUSTERS = 'user-listings-clusters';
            const LISTINGS_LAYER_COUNT = 'user-listings-cluster-count';
            const LISTINGS_LAYER_POINTS = 'user-listings-points';
            
            // Cache for listings
            const listingsCache = useRef({ data: null, timestamp: 0 });
            const CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes
            
            // Global flag to prevent click-through from listings to parcels
            const isListingInteractionActive = useRef(false);

            const ensureListingsLayers = (map) => {
                if (!map || map.getSource(LISTINGS_SOURCE_ID)) return;

                map.addSource(LISTINGS_SOURCE_ID, {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: []
                    },
                    cluster: true,
                    clusterMaxZoom: 16,
                    clusterRadius: 45
                });

                map.addLayer({
                    id: LISTINGS_LAYER_CLUSTERS,
                    type: 'circle',
                    source: LISTINGS_SOURCE_ID,
                    filter: ['has', 'point_count'],
                    paint: {
                        'circle-color': '#2563eb',
                        'circle-radius': ['step', ['get', 'point_count'], 16, 10, 20, 30, 26],
                        'circle-opacity': 0.9
                    }
                });

                // Skip text layer - OSM style has no glyphs
                // Cluster count will be shown via CSS on hover or in popup

                map.addLayer({
                    id: LISTINGS_LAYER_POINTS,
                    type: 'circle',
                    source: LISTINGS_SOURCE_ID,
                    filter: ['!', ['has', 'point_count']],
                    paint: {
                        'circle-color': '#f97316',
                        'circle-radius': 6,
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff'
                    }
                });

                // Invisible hitbox layer for better click detection (16px = 6px visual + 10px extra)
                map.addLayer({
                    id: 'user-listings-points-hitbox',
                    type: 'circle',
                    source: LISTINGS_SOURCE_ID,
                    filter: ['!', ['has', 'point_count']],
                    paint: {
                        'circle-radius': 16,
                        'circle-opacity': 0
                    }
                });
            };

            const refreshListings = async (map, forceRefresh = false) => {
                if (!map) return;
                
                try {
                    // Check cache validity
                    const now = Date.now();
                    const cacheAge = now - listingsCache.current.timestamp;
                    const isCacheValid = listingsCache.current.data && cacheAge < CACHE_DURATION_MS;

                    if (!forceRefresh && isCacheValid) {
                        console.log(`[Listings] üì¶ Using cached data (age: ${Math.round(cacheAge / 1000)}s)`);
                        const source = map.getSource(LISTINGS_SOURCE_ID);
                        if (source && source.setData) {
                            source.setData({
                                type: 'FeatureCollection',
                                features: listingsCache.current.data
                            });
                        }
                        return;
                    }

                    console.log('[Listings] üîÑ Fetching fresh data from Firebase...');
                    const firebaseInit = window.__initFirebase;
                    if (!firebaseInit) {
                        throw new Error('Firebase not initialized');
                    }

                    const { db } = await firebaseInit();
                    const snapshot = await db.collection('listings').limit(200).get();
                    
                    if (!snapshot) {
                        throw new Error('Failed to fetch listings');
                    }
                    
                    // Extract unique user IDs to fetch user profiles
                    const uniqueUserIds = [...new Set(snapshot.docs.map(doc => doc.data().userId).filter(Boolean))];
                    
                    // Fetch all user profiles in parallel
                    const userProfiles = {};
                    if (uniqueUserIds.length > 0) {
                        const userPromises = uniqueUserIds.map(uid => 
                            db.collection('users').doc(uid).get()
                                .then(userDoc => ({ uid, data: userDoc.exists ? userDoc.data() : null }))
                                .catch(err => {
                                    console.warn(`[Listings] Failed to fetch user ${uid}:`, err);
                                    return { uid, data: null };
                                })
                        );
                        const results = await Promise.all(userPromises);
                        results.forEach(({ uid, data }) => {
                            if (data) userProfiles[uid] = data;
                        });
                    }

                    const features = snapshot.docs.map(doc => {
                        try {
                            const data = doc.data() || {};
                            if (typeof data.lng !== 'number' || typeof data.lat !== 'number') {
                                console.warn(`[Listings] Invalid coordinates for listing ${doc.id}`);
                                return null;
                            }
                            
                            // Get user profile or fallback to old data
                            const userProfile = data.userId ? userProfiles[data.userId] : null;
                            const userName = userProfile?.displayName || data.userName || 'Ng∆∞·ªùi ƒëƒÉng';
                            const phone = userProfile?.phone || data.phone || '';
                            
                            return {
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [data.lng, data.lat]
                                },
                                properties: {
                                    id: doc.id,
                                    userId: data.userId || '',
                                    so_to: data.soHieuToBanDo || '',
                                    so_thua: data.soThuTuThua || '',
                                    dien_tich: data.dienTich || 0,
                                    priceValue: data.priceValue || 0,
                                    priceUnit: data.priceUnit || 'VND',
                                    isNegotiable: data.isNegotiable || false,
                                    loaiGiaoDich: data.loaiGiaoDich || 'ban-dat',
                                    userName,
                                    phone,
                                    note: data.note || '',
                                    status: data.status || 'approved',
                                    createdAt: data.createdAt || null,
                                    viewCount: data.viewCount || 0
                                }
                            };
                        } catch (err) {
                            console.warn(`[Listings] Error processing listing ${doc.id}:`, err);
                            return null;
                        }
                    }).filter(Boolean);

                    // Update cache
                    listingsCache.current = { data: features, timestamp: now };

                    const source = map.getSource(LISTINGS_SOURCE_ID);
                    if (source && source.setData) {
                        source.setData({
                            type: 'FeatureCollection',
                            features
                        });
                        console.log(`[Listings] ‚úÖ Loaded ${features.length} listings (cached for ${CACHE_DURATION_MS / 1000}s)`);
                    }
                } catch (err) {
                    console.error('[Listings] ‚ùå Load failed:', err);
                    
                    // Use stale cache as fallback
                    if (listingsCache.current.data) {
                        console.log('[Listings] üì¶ Using stale cache as fallback');
                        const source = map.getSource(LISTINGS_SOURCE_ID);
                        if (source && source.setData) {
                            source.setData({
                                type: 'FeatureCollection',
                                features: listingsCache.current.data
                            });
                        }
                    } else {
                        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu tin ƒëƒÉng. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    }
                }
            };

            const buildListingPopupHtml = (props) => {
                const soTo = props.so_to || 'N/A';
                const soThua = props.so_thua || 'N/A';
                const dienTich = props.dien_tich || 0;
                const price = props.priceValue || 0;
                const priceUnit = props.priceUnit || 'VND';
                const userName = props.userName || 'Ng∆∞·ªùi ƒëƒÉng';
                const isNegotiable = props.isNegotiable ? 'üí¨ Th∆∞∆°ng l∆∞·ª£ng' : '';
                const loaiGiaoDich = props.loaiGiaoDich || 'ban-dat';
                
                const transactionLabel = loaiGiaoDich === 'ban-dat' ? 'üè∑Ô∏è B√°n' : 
                                        loaiGiaoDich === 'ban-nha' ? 'üè† B√°n nh√†' :
                                        loaiGiaoDich === 'cho-thue' ? 'üîë Cho thu√™' : '‚úì ' + loaiGiaoDich;
                
                const priceText = price > 0
                    ? new Intl.NumberFormat('vi-VN').format(price) + ' ' + priceUnit
                    : isNegotiable;

                return `
                    <div style="min-width:200px;font-family:sans-serif">
                        <div style="font-weight:800;color:#0f172a;font-size:14px;margin-bottom:8px">
                            Th·ª≠a ${soThua} / T·ªù ${soTo}
                        </div>
                        <div style="display:grid;gap:6px;font-size:12px;margin-bottom:8px">
                            <div style="color:#475569">üìê ${dienTich} m¬≤</div>
                            <div style="color:#d97706;font-weight:600">${transactionLabel}</div>
                            <div style="color:#059669;font-weight:600">üí∞ ${priceText}</div>
                        </div>
                        <div style="border-top:1px solid #e2e8f0;padding-top:6px;font-size:11px;color:#64748b">
                            üìç ƒêƒÉng b·ªüi ${userName}
                        </div>
                    </div>
                `;
            };

            // Clear dimensions and highlight when selected is cleared
            useEffect(() => {
                if (selected === null && window.__clearDimensionsAndHighlight) {
                    window.__clearDimensionsAndHighlight(mapRef.current);
                }
            }, [selected]);

            useEffect(() => {
                let unsubscribe = null;
                let isMounted = true;

                (async () => {
                    try {
                        const firebaseInit = window.__initFirebase;
                        if (!firebaseInit) return;

                        const { auth } = await firebaseInit();
                        unsubscribe = auth.onAuthStateChanged(async (user) => {
                            if (!isMounted) return;

                            if (user && window.__ensureUserDocument) {
                                await window.__ensureUserDocument(user);
                            }

                            setAuthUser(user || null);
                            if (user) setShowLogin(false);
                        });
                    } catch (err) {
                        console.warn('[Auth] Init failed:', err);
                    }
                })();

                return () => {
                    isMounted = false;
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            useEffect(() => {
                if (!showLogin) return;

                (async () => {
                    try {
                        const firebaseInit = window.__initFirebase;
                        const firebaseUiInit = window.__initFirebaseUi;
                        if (!firebaseInit || !firebaseUiInit) return;

                        await firebaseInit();
                        firebaseUiInit('#firebaseui-auth-container');
                    } catch (err) {
                        console.warn('[Auth] FirebaseUI init failed:', err);
                    }
                })();
            }, [showLogin]);

            useEffect(() => {
                // Setup worker URL
                if (window.maplibregl) {
                    window.maplibregl.workerUrl = 'https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl-csp-worker.js';
                }

                const map = new window.maplibregl.Map({
                    container: mapContainer.current,
                    style: {
                        version: 8,
                        sources: {
                            'osm': { 
                                type: 'raster', 
                                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], 
                                tileSize: 256, 
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            },
                            'parcels': {
                                type: 'vector',
                                url: 'pmtiles://https://xemgiadat.com/tiles/danang_parcels_final.pmtiles'
                            }
                        },
                        layers: [
                            { id: 'osm', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.8 } },
                            { id: 'parcels-fill-clickable', type: 'fill', source: 'parcels', 'source-layer': 'default', paint: { 'fill-color': 'transparent' } },
                            { 
                                id: 'parcels-line', 
                                type: 'line', 
                                source: 'parcels', 
                                'source-layer': 'default', 
                                paint: { 
                                    'line-color': '#3B82F6', 
                                    'line-width': [
                                        'interpolate',
                                        ['exponential', 1.5],
                                        ['zoom'],
                                        12, 0.3,
                                        14, 0.5,
                                        16, 0.8,
                                        18, 1.2
                                    ],
                                    'line-opacity': [
                                        'interpolate',
                                        ['linear'],
                                        ['zoom'],
                                        12, 0.4,
                                        14, 0.6,
                                        16, 0.8,
                                        18, 1
                                    ]
                                }
                            },
                            { id: 'parcels-highlight-fill', type: 'fill', source: 'parcels', 'source-layer': 'default', filter: ['==', 'OBJECTID', -1], paint: { 'fill-color': '#FBBF24', 'fill-opacity': 0.5 } },
                            { id: 'parcels-highlight', type: 'line', source: 'parcels', 'source-layer': 'default', filter: ['==', 'OBJECTID', -1], paint: { 'line-color': '#F59E0B', 'line-width': 5 } }
                        ]
                    },
                    center: [108.2022, 16.0544],
                    zoom: 14,
                    hash: false,
                    attributionControl: false
                });

                mapRef.current = map;
                
                // PRIORITY 1: Listings click handlers (MUST BE BEFORE parcel handler)
                // This ensures listing points are clickable even when overlapping with parcels
                map.on('click', LISTINGS_LAYER_CLUSTERS, (e) => {
                    // Auto-close search dropdown
                    setSearchResults([]);
                    setSearchQuery('');
                    
                    const features = map.queryRenderedFeatures(e.point, {
                        layers: [LISTINGS_LAYER_CLUSTERS]
                    });
                    const cluster = features?.[0];
                    const clusterId = cluster?.properties?.cluster_id;
                    const source = map.getSource(LISTINGS_SOURCE_ID);
                    if (!source || clusterId === undefined) return;

                    // Set the flag to prevent parcel click
                    isListingInteractionActive.current = true;

                    source.getClusterExpansionZoom(clusterId, (err, zoom) => {
                        if (err) return;
                        map.easeTo({
                            center: cluster.geometry.coordinates,
                            zoom
                        });
                    });
                    
                    // Prevent parcel click
                    e.originalEvent.stopPropagation();
                });

                // Click handler for hitbox layer (better click detection)
                map.on('click', 'user-listings-points-hitbox', (e) => {
                    console.log('[Listings] Point clicked!', e.features?.[0]);
                    
                    // Set the flag to prevent parcel click
                    isListingInteractionActive.current = true;
                    
                    // Auto-close search dropdown
                    setSearchResults([]);
                    setSearchQuery('');
                    
                    const feature = e.features?.[0];
                    if (!feature) return;

                    // Validate geometry type
                    const geometry = feature.geometry;
                    if (geometry.type !== 'Point') {
                        console.warn('[Listings] Expected Point geometry, got:', geometry.type);
                        return;
                    }

                    // Extract listing data from feature properties
                    const props = feature.properties;
                    const coords = geometry.coordinates;
                    
                    const listingData = {
                        id: props.id,
                        userId: props.userId || '',
                        so_to: props.so_to || '',
                        so_thua: props.so_thua || '',
                        dien_tich: props.dien_tich || 0,
                        priceValue: props.priceValue || 0,
                        priceUnit: props.priceUnit || 'VND',
                        isNegotiable: props.isNegotiable || false,
                        loaiGiaoDich: props.loaiGiaoDich || 'ban-dat',
                        userName: props.userName || 'Ng∆∞·ªùi ƒëƒÉng',
                        phone: props.phone || '',
                        note: props.note || '',
                        status: props.status || 'approved',
                        coordinates: [coords[0], coords[1]],
                        createdAt: props.createdAt || null,
                        viewCount: props.viewCount || 0
                    };

                    // Smooth flyTo animation to the listing point
                    map.flyTo({
                        center: coords,
                        zoom: 18.5,
                        duration: 1500,
                        essential: true
                    });
                    
                    // UI/UX Enhancement: Temporarily hide other listing icons for focus effect
                    // Hide other listings for 2 seconds to reduce visual clutter
                    if (map.getLayer('user-listings-points')) {
                        map.setLayoutProperty('user-listings-points', 'visibility', 'none');
                    }
                    if (map.getLayer('user-listings-points-hitbox')) {
                        map.setLayoutProperty('user-listings-points-hitbox', 'visibility', 'none');
                    }
                    if (map.getLayer(LISTINGS_LAYER_CLUSTERS)) {
                        map.setLayoutProperty(LISTINGS_LAYER_CLUSTERS, 'visibility', 'none');
                    }
                    if (map.getLayer(LISTINGS_LAYER_COUNT)) {
                        map.setLayoutProperty(LISTINGS_LAYER_COUNT, 'visibility', 'none');
                    }
                    
                    // Restore visibility after 2 seconds
                    setTimeout(() => {
                        if (map.getLayer('user-listings-points')) {
                            map.setLayoutProperty('user-listings-points', 'visibility', 'visible');
                        }
                        if (map.getLayer('user-listings-points-hitbox')) {
                            map.setLayoutProperty('user-listings-points-hitbox', 'visibility', 'visible');
                        }
                        if (map.getLayer(LISTINGS_LAYER_CLUSTERS)) {
                            map.setLayoutProperty(LISTINGS_LAYER_CLUSTERS, 'visibility', 'visible');
                        }
                        if (map.getLayer(LISTINGS_LAYER_COUNT)) {
                            map.setLayoutProperty(LISTINGS_LAYER_COUNT, 'visibility', 'visible');
                        }
                    }, 2000);

                    // Show listing details in side panel
                    setSelectedListing(listingData);
                    setSelected(null);
                    setView('listing-detail');
                    
                    console.log('[Listings] Listing selected:', listingData);
                    
                    // Increment view count in Firebase
                    incrementViewCount(listingData.id).catch(err => {
                        console.warn('[ViewCount] Failed to increment:', err);
                        // Non-critical: View count increment failure shouldn't block user experience
                        // Tracked for analytics but doesn't affect core functionality
                    });
                    
                    // CRITICAL: Prevent parcel click from firing
                    e.originalEvent.stopPropagation();
                });
                
                // PRIORITY 2: Parcel click handler (comes after listings)
                map.on('click', 'parcels-fill-clickable', (e) => {
                    // Check if a listing interaction is active - prevent click-through
                    if (isListingInteractionActive.current) {
                        console.log('[Click] Parcel click blocked due to active listing interaction');
                        isListingInteractionActive.current = false;
                        return;
                    }
                    
                    if (!e.features?.[0]) return;
                    
                    // Auto-close search dropdown when parcel is selected
                    setSearchResults([]);
                    setSearchQuery('');
                    
                    // Get the clicked feature
                    const clickedFeature = e.features[0];
                    const props = clickedFeature.properties || {};
                    
                    // Debug: Log ALL property information
                    console.log('[Click] ===== FEATURE DEBUG =====');
                    console.log('[Click] Feature ID:', clickedFeature.id);
                    console.log('[Click] Feature type:', clickedFeature.geometry?.type);
                    console.log('[Click] Raw properties:', props);
                    console.log('[Click] All property keys:', Object.keys(props));
                    console.log('[Click] All property values:');
                    Object.entries(props).forEach(([key, val]) => {
                        console.log(`  ${key}: ${val} (${typeof val})`);
                    });
                    
                    const normalized = normalizeParcelProps(props);
                    console.log('[Click] Normalized data:', normalized);
                    
                    // Highlight parcel - use OBJECTID since feature.id is undefined
                    const objectId = props.OBJECTID;
                    if (objectId !== undefined && objectId !== null) {
                        console.log('[Highlight] ‚úÖ Setting highlight for OBJECTID:', objectId);
                        
                        // Set filter using OBJECTID property
                        map.setFilter('parcels-highlight', ['==', 'OBJECTID', objectId]);
                        map.setFilter('parcels-highlight-fill', ['==', 'OBJECTID', objectId]);
                        
                        // Verify filter was set
                        setTimeout(() => {
                            const filter = map.getFilter('parcels-highlight');
                            console.log('[Highlight] Current filter:', JSON.stringify(filter));
                        }, 100);
                    } else {
                        console.warn('[Highlight] ‚ö†Ô∏è No OBJECTID found in properties');
                    }
                    
                    // Draw dimension labels on polygon edges
                    drawDimensions(clickedFeature, map);
                    
                    // Set selected state with ACTUAL data
                    const selectedData = {
                        id: normalized.object_id || '',
                        so_thua: normalized.so_thua,
                        so_to: normalized.so_to,
                        dien_tich: normalized.dien_tich,
                        muc_dich: normalized.muc_dich,
                        dia_chi: normalized.dia_chi,
                        ma_xa: normalized.ma_xa,
                        coordinates: [e.lngLat.lng, e.lngLat.lat]
                    };
                    
                    console.log('[Click] ‚úÖ Setting selected data:', selectedData);
                    setSelected(selectedData);
                    setView('info');
                });
                
                // PRIORITY 3: Background click handler (reset flag when clicking empty space)
                map.on('click', (e) => {
                    // Check if click was on a feature (cluster, listing, or parcel)
                    const features = map.queryRenderedFeatures(e.point, {
                        layers: [LISTINGS_LAYER_CLUSTERS, 'user-listings-points-hitbox', 'parcels-fill-clickable']
                    });
                    
                    // If no features clicked, reset the flag
                    if (!features || features.length === 0) {
                        console.log('[Click] Background clicked - resetting interaction flag');
                        isListingInteractionActive.current = false;
                    }
                });
                
                // Cursor pointer on hover
                map.on('mouseenter', 'parcels-fill-clickable', () => { map.getCanvas().style.cursor = 'pointer'; });
                map.on('mouseleave', 'parcels-fill-clickable', () => { map.getCanvas().style.cursor = ''; });
                
                // Kh·ªüi t·∫°o MapController v√† SearchService sau khi map load xong
                map.on('load', () => {
                    if (window.MapController) {
                        const controller = new window.MapController(map);
                        window.MapController.setInstance(controller);
                    }
                    if (window.SearchService) {
                        searchServiceRef.current = new window.SearchService();
                        
                                            // Initial cache update
                                            setTimeout(() => {
                                                if (searchServiceRef.current) {
                                                    searchServiceRef.current.updateCache(map);
                                                }
                                            }, 1000);
                    }
                    console.log('[MAP] ‚úì Loaded with vector parcels');

                    ensureListingsLayers(map);
                    refreshListings(map);

                    // Mouse cursor handlers for listings
                    map.on('mouseenter', LISTINGS_LAYER_CLUSTERS, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', LISTINGS_LAYER_CLUSTERS, () => {
                        map.getCanvas().style.cursor = '';
                    });
                    // Use hitbox layer for better pointer detection
                    map.on('mouseenter', 'user-listings-points-hitbox', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', 'user-listings-points-hitbox', () => {
                        map.getCanvas().style.cursor = '';
                    });
                
                    // Auto-close search when clicking empty map area
                    map.on('click', (e) => {
                        // Only clear if search is open
                        if (searchQuery || searchResults.length > 0) {
                            setSearchResults([]);
                            setSearchQuery('');
                        }
                    });
                                                // Auto-update cache when map stops moving
                                map.on('idle', () => {
                                    if (searchServiceRef.current) {
                                        searchServiceRef.current.updateCache(map);
                                    }
                                });

                                const deepLink = parseDeepLinkParams();
                                if (deepLink && !Number.isNaN(deepLink.lat) && !Number.isNaN(deepLink.lng)) {
                                    map.flyTo({
                                        center: [deepLink.lng, deepLink.lat],
                                        zoom: deepLink.zoom || 18,
                                        duration: 1500,
                                        essential: true
                                    });

                                    // NEW LOGIC: Wait for map.once('idle') to ensure Vector Tiles are loaded
                                    map.once('idle', async () => {
                                        try {
                                            if (searchServiceRef.current) {
                                                searchServiceRef.current.updateCache(map);
                                            }

                                            // Query the feature at the shared location
                                            const point = map.project([deepLink.lng, deepLink.lat]);
                                            const features = map.queryRenderedFeatures(point, {
                                                layers: ['parcels-fill-clickable']
                                            });

                                            if (features && features.length > 0) {
                                                const clickedFeature = features[0];
                                                const props = clickedFeature.properties || {};
                                                const normalized = normalizeParcelProps(props);

                                                // Highlight parcel
                                                const objectId = props.OBJECTID;
                                                if (objectId !== undefined && objectId !== null) {
                                                    map.setFilter('parcels-highlight', ['==', 'OBJECTID', objectId]);
                                                    map.setFilter('parcels-highlight-fill', ['==', 'OBJECTID', objectId]);
                                                }

                                                // Draw dimensions
                                                drawDimensions(clickedFeature, map);

                                                // Set selected state
                                                setSelected({
                                                    id: normalized.object_id || '',
                                                    so_thua: normalized.so_thua,
                                                    so_to: normalized.so_to,
                                                    dien_tich: normalized.dien_tich,
                                                    muc_dich: normalized.muc_dich,
                                                    dia_chi: normalized.dia_chi,
                                                    ma_xa: normalized.ma_xa,
                                                    coordinates: [deepLink.lng, deepLink.lat]
                                                });
                                                setView('info');
                                                console.log('[DeepLink] ‚úÖ Parcel selected from shared link');
                                            } else {
                                                // FALLBACK: Place a red marker if Vector ID not found
                                                console.warn('[DeepLink] No parcel found at shared coordinates - placing fallback marker');
                                                setSelected(createFallbackMarker(map, deepLink.lng, deepLink.lat));
                                                setView('info');
                                            }
                                        } catch (err) {
                                            console.warn('[DeepLink] Parcel lookup failed:', err);
                                            // FALLBACK on error: Place red marker
                                            setSelected(createFallbackMarker(map, deepLink.lng, deepLink.lat, 'error'));
                                            setView('info');
                                        }
                                    });
                                }
                });
                
                // Redraw dimensions when map moves (zoom/pan) to keep labels in correct position
                map.on('move', () => {
                    if (selectedFeatureForDimensions) {
                        drawDimensions(selectedFeatureForDimensions, map);
                    }
                });
                
                return () => map.remove();
            }, []);
            
            // Load Commune List for sharded search
            useEffect(() => {
                const lps = window.LandParcelService;
                if (!lps) return;
                setIsCommuneLoading(true);
                lps.getCommuneList().then(list => {
                    setCommuneOptions(list || []);
                    console.log('[Commune] Loaded', list?.length, 'communes');
                }).catch(err => {
                    console.error('[Commune] Load failed:', err);
                }).finally(() => setIsCommuneLoading(false));
            }, []);

            // Prefetch shard when commune selected
            useEffect(() => {
                if (!selectedMaXa) return;
                const lps = window.LandParcelService;
                if (lps) {
                    lps.loadIndexForMaXa(selectedMaXa).then(() => {
                        console.log('[Shard] Prefetched:', selectedMaXa);
                    });
                }
            }, [selectedMaXa]);

            // Load AI Knowledge Base
            useEffect(() => {
                fetch('./data/land-law-2024.json')
                    .then(res => res.json())
                    .then(data => {
                        setKnowledgeBase(data.knowledgeBase || []);
                        console.log('[AI] Knowledge base loaded:', data.knowledgeBase?.length, 'entries');
                    })
                    .catch(err => {
                        console.error('[AI] Failed to load knowledge base:', err);
                    });
            }, []);

            const handleSearch = async (e) => {
                e.preventDefault();
                if (!searchQuery.trim()) return;

                const parts = searchQuery.trim().split(/[\/\s]+/).filter(Boolean);
                if (parts.length < 2) return;

                const [soTo, soThua] = parts;

                setIsSearching(true);
                try {
                    // PRIORITY 1: Try LandParcelService sharded search when commune selected
                    const lps = window.LandParcelService;
                    if (lps && selectedMaXa) {
                        const normalizedKey = `${parseInt(soTo, 10)}:${parseInt(soThua, 10)}`;
                        const coords = await lps.searchParcelByNumber(normalizedKey, selectedMaXa);
                        if (coords) {
                            console.log('[Search] Shard hit:', normalizedKey, '‚Üí', coords);
                            const map = window.MapController?.getMap?.();
                            if (map) {
                                map.flyTo({ center: coords, zoom: 18, duration: 1500, essential: true });
                            }
                            setSearchResults([]);
                            setSearchQuery('');
                            return;
                        }
                    }

                    // PRIORITY 2: Fallback to viewport-based search
                    if (searchServiceRef.current) {
                        const results = await searchServiceRef.current.searchParcels(`${soTo} ${soThua}`);
                        setSearchResults(results || []);
                    } else {
                        setSearchResults([]);
                    }
                } catch (err) {
                    console.error('Search failed:', err);
                    setSearchResults([]);
                } finally {
                    setIsSearching(false);
                }
            };

            const handleSelectResult = (parcel) => {
                if (!parcel) return;
                // Fly to parcel location
                const map = window.MapController.getMap();
                if (map && parcel.coordinates) {
                    map.flyTo({
                        center: parcel.coordinates,
                        zoom: 18,
                        duration: 1500
                    });
                }


                setSelected({
                    id: parcel.id,
                    so_thua: parcel.so_thua,
                    so_to: parcel.so_to,
                    dien_tich: parcel.dien_tich,
                    muc_dich: parcel.muc_dich,
                    dia_chi: parcel.dia_chi,
                    coordinates: parcel.coordinates
                });
                setView('info');

                setSearchQuery('');
                setSearchResults([]);
            };

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                const compressed = await Promise.all(files.slice(0, 5 - images.length).map(f => compressImage(f)));
                setImages(prev => [...prev, ...compressed]);
            };

            const parseDeepLinkParams = () => {
                const realLoc = window.__REAL_LOCATION__ || window.location;
                const searchParams = new URLSearchParams((realLoc.search || '').replace(/^\?/, ''));
                const hashParams = new URLSearchParams((realLoc.hash || '').replace(/^#/, ''));
                const getParam = (key) => searchParams.get(key) ?? hashParams.get(key);

                const lat = getParam('lat');
                const lng = getParam('lng');
                if (!lat || !lng) return null;

                return {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    zoom: getParam('z') ? parseFloat(getParam('z')) : 18,
                    soTo: getParam('soTo') || null,
                    soThua: getParam('soThua') || null
                };
            };

            // ===== HELPER FUNCTIONS FOR PREMIUM FEATURES =====
            
            // Haptic feedback simulation
            const triggerHaptic = (type) => {
                const durations = { light: 10, medium: 20, heavy: 50 };
                if ('vibrate' in navigator) {
                    navigator.vibrate(durations[type] || 20);
                }
            };
            
            // Bottom Sheet swipe gesture handlers
            const handleSheetTouchStart = (e) => {
                dragStartY.current = e.touches[0].clientY;
                dragStartTranslate.current = sheetTranslateY;
                setIsDragging(true);
            };
            
            const handleSheetTouchMove = (e) => {
                if (!isDragging) return;
                const currentY = e.touches[0].clientY;
                const diff = currentY - dragStartY.current;
                
                // Only allow dragging down to dismiss the sheet; prevent upward dragging beyond initial position
                if (diff > 0) {
                    setSheetTranslateY(dragStartTranslate.current + diff);
                }
            };
            
            const handleSheetTouchEnd = () => {
                setIsDragging(false);
                
                // If dragged more than 100px, close the sheet
                if (sheetTranslateY > 100) {
                    setSelected(null);
                    setSelectedListing(null);
                    isListingInteractionActive.current = false;
                    triggerHaptic('light');
                }
                
                // Reset translation
                setSheetTranslateY(0);
            };

            // Toggle 3D view
            const toggle3DView = () => {
                const map = mapRef.current;
                if (!map) return;
                
                triggerHaptic('medium');
                
                if (!is3DView) {
                    map.easeTo({ pitch: 60, bearing: -20, duration: 1000 });
                    setIs3DView(true);
                } else {
                    map.easeTo({ pitch: 0, bearing: 0, duration: 1000 });
                    setIs3DView(false);
                }
            };

            // Get AI insight for parcel
            const getAIInsight = (item) => {
                if (!window.AIInsightService) return null;
                if (item.priceValue) {
                    return window.AIInsightService.getListingInsight(item);
                } else if (item.dien_tich) {
                    // Add fake price for demo
                    return window.AIInsightService.getPriceInsight({
                        ...item,
                        gia_uoc_tinh: item.dien_tich * 5000000 // 5M/m¬≤ estimate
                    });
                }
                return null;
            };

            // Get status badges
            const getStatusBadges = (item) => {
                if (!window.AIInsightService) return [];
                return window.AIInsightService.getStatusBadges(item || {});
            };
            
            // Increment view count using Firebase increment()
            const incrementViewCount = async (listingId) => {
                try {
                    const firebaseInit = window.__initFirebase;
                    if (!firebaseInit) throw new Error('Firebase not ready');
                    
                    const { db } = await firebaseInit();
                    
                    // Safe access to FieldValue with fallback
                    if (!window.firebase?.firestore?.FieldValue) {
                        throw new Error('Firebase FieldValue not available');
                    }
                    
                    const increment = window.firebase.firestore.FieldValue.increment(1);
                    
                    await db.collection('listings').doc(listingId).update({
                        viewCount: increment
                    });
                    
                    console.log('[ViewCount] ‚úÖ Incremented for listing:', listingId);
                } catch (err) {
                    console.error('[ViewCount] Failed to increment:', err);
                    throw err;
                }
            };
            
            // Fuzzy search function for AI knowledge base
            const fuzzySearch = (query, knowledgeBase) => {
                const normalizeText = (text) => {
                    return text.toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                        .replace(/ƒë/g, 'd')
                        .trim();
                };
                
                const queryNormalized = normalizeText(query);
                const queryWords = queryNormalized.split(/\s+/);
                
                // Score each entry
                const scored = knowledgeBase.map(entry => {
                    let score = 0;
                    const questionNormalized = normalizeText(entry.question);
                    const keywordsNormalized = entry.keywords.map(k => normalizeText(k));
                    
                    // Check exact match in question
                    if (questionNormalized.includes(queryNormalized)) {
                        score += 100;
                    }
                    
                    // Check each query word
                    queryWords.forEach(word => {
                        // Match in question
                        if (questionNormalized.includes(word)) {
                            score += 10;
                        }
                        
                        // Match in keywords
                        keywordsNormalized.forEach(keyword => {
                            if (keyword.includes(word) || word.includes(keyword)) {
                                score += 20;
                            }
                        });
                    });
                    
                    return { entry, score };
                });
                
                // Sort by score and return best match
                scored.sort((a, b) => b.score - a.score);
                
                // Return best match if score is good enough
                if (scored.length > 0 && scored[0].score > 0) {
                    return scored[0].entry;
                }
                
                return null;
            };
            
            // Handle AI query submission with local RAG
            const handleAIQuery = () => {
                if (!aiQuery.trim()) return;
                
                triggerHaptic('medium');
                
                // Search knowledge base
                const match = fuzzySearch(aiQuery, knowledgeBase);
                
                if (match) {
                    setAiResponse(`‚úÖ **${match.question}**\n\n${match.answer}`);
                } else {
                    setAiResponse('‚ùì Xin l·ªói, t√¥i ch∆∞a c√≥ th√¥ng tin v·ªÅ c√¢u h·ªèi n√†y.\n\nVui l√≤ng th·ª≠ h·ªèi v·ªÅ:\n‚Ä¢ Lu·∫≠t ƒê·∫•t ƒëai 2024\n‚Ä¢ Gi√° ƒë·∫•t ƒê√† N·∫µng 2026\n‚Ä¢ Th·ªß t·ª•c chuy·ªÉn nh∆∞·ª£ng, t√°ch th·ª≠a\n‚Ä¢ Quy ƒë·ªãnh v·ªÅ quy·ªÅn s·ª≠ d·ª•ng ƒë·∫•t\n\nHo·∫∑c li√™n h·ªá chuy√™n vi√™n ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n chi ti·∫øt.');
                }
            };

            const submitForm = async () => {
                if (!authUser) {
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng tin rao b√°n!');
                    setShowLogin(true);
                    return;
                }

                if (!selected) return;

                // Validate required fields
                if (!form.isNegotiable && (!form.price || form.price === '')) {
                    alert('‚ùå Vui l√≤ng nh·∫≠p gi√° b√°n ho·∫∑c ch·ªçn "Gi√° c√≥ th·ªÉ th∆∞∆°ng l∆∞·ª£ng"!');
                    return;
                }

                setIsSubmitting(true);
                try {
                    console.log('[Listings] Starting submission with authUser:', authUser.uid);
                    const firebaseInit = window.__initFirebase;
                    if (!firebaseInit) throw new Error('Firebase not ready');

                    const { db } = await firebaseInit();
                    console.log('[Listings] Firebase initialized, db:', !!db);
                    
                    const now = window.firebase.firestore.FieldValue.serverTimestamp();
                    const coords = selected.coordinates || [108.2022, 16.0544];
                    const priceValue = form.isNegotiable ? 0 : Number(form.price || 0);
                    const note = (form.note || '').trim().slice(0, 500);

                    const listing = {
                        userId: authUser.uid,
                        note,
                        lat: coords[1],
                        lng: coords[0],
                        maXa: selected.ma_xa || '',
                        soThuTuThua: selected.so_thua || '',
                        soHieuToBanDo: selected.so_to || '',
                        dienTich: selected.dien_tich || 0,
                        priceValue,
                        priceUnit: form.priceUnit || 'VND',
                        isNegotiable: form.isNegotiable,
                        loaiGiaoDich: form.transactionType || 'ban-dat',
                        status: 'approved',
                        imageCount: images.length || 0,
                        viewCount: 0,
                        createdAt: now,
                        updatedAt: now
                    };

                    console.log('[Listings] Submitting listing data:', listing);
                    const docRef = await db.collection('listings').add(listing);
                    console.log('[Listings] ‚úÖ Submitted successfully with ID:', docRef.id);

                    const map = window.MapController?.getMap?.();
                    if (map) {
                        console.log('[Listings] Refreshing map listings...');
                        await refreshListings(map);
                        console.log('[Listings] ‚úÖ Map listings refreshed');
                    }

                    setView('success');
                    setTimeout(() => {
                        setSelected(null);
                        setView('info');
                        setImages([]);
                        setForm({ 
                            price: '', 
                            note: '',
                            transactionType: 'ban-dat',
                            priceUnit: 'VND',
                            isNegotiable: false
                        });
                    }, 2000);
                } catch (err) {
                    console.error('[Listings] Submit failed with error:', {
                        message: err.message,
                        code: err.code,
                        fullError: err
                    });
                    
                    let errorMsg = 'G·ª≠i tin th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.';
                    if (err.code === 'permission-denied') {
                        errorMsg = '‚ùå L·ªói quy·ªÅn: Ki·ªÉm tra Firestore rules. B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p?';
                    } else if (err.message.includes('Firebase not ready')) {
                        errorMsg = '‚ùå Firebase ch∆∞a s·∫µn s√†ng. Th·ª≠ l·∫°i sau.';
                    } else if (err.message) {
                        errorMsg = `‚ùå L·ªói: ${err.message}`;
                    }
                    
                    alert(errorMsg);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const getShareBaseUrl = () => {
                const realLoc = window.__REAL_LOCATION__ || window.location;
                return `${realLoc.origin}${realLoc.pathname}`;
            };

            const buildSharePayload = () => {
                const map = window.MapController?.getMap?.();
                const coords = selected?.coordinates || (map ? [map.getCenter().lng, map.getCenter().lat] : [108.2022, 16.0544]);
                return {
                    lat: coords[1],
                    lng: coords[0],
                    soTo: selected?.so_to,
                    soThua: selected?.so_thua
                };
            };

            const generateShareLink = (payload) => {
                const params = new URLSearchParams();
                params.set('lat', Number(payload.lat).toFixed(6));
                params.set('lng', Number(payload.lng).toFixed(6));
                params.set('z', '18');
                if (payload.soTo) params.set('soTo', payload.soTo);
                if (payload.soThua) params.set('soThua', payload.soThua);
                return `${getShareBaseUrl()}?${params.toString()}`;
            };

            const generateShareText = (payload) => {
                if (payload.soThua && payload.soTo) {
                    return `Kh√°m ph√° th·ª≠a ƒë·∫•t (Th·ª≠a: ${payload.soThua}, T·ªù: ${payload.soTo}) t·∫°i ƒê√† N·∫µng tr√™n B·∫£n ƒë·ªì Gi√° ƒë·∫•t C·ªông ƒë·ªìng!`;
                }
                return 'Kh√°m ph√° v·ªã tr√≠ tr√™n B·∫£n ƒë·ªì Gi√° ƒë·∫•t C·ªông ƒë·ªìng!';
            };

            const copyToClipboard = async (text) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    alert('ƒê√£ sao ch√©p li√™n k·∫øt!');
                    return;
                }
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                temp.remove();
                alert('ƒê√£ sao ch√©p li√™n k·∫øt!');
            };

            const shareToPlatform = async (platform) => {
                setShareOpen(false);
                const payload = buildSharePayload();
                const link = generateShareLink(payload);
                const text = generateShareText(payload);

                if (platform === 'copy') {
                    await copyToClipboard(link);
                    return;
                }

                if (platform === 'zalo') {
                    await copyToClipboard(link);
                    alert('ƒê√£ copy link! H√£y d√°n v√†o Zalo ƒë·ªÉ chia s·∫ª.');
                    return;
                }

                if (platform === 'native') {
                    if (navigator.share) {
                        await navigator.share({
                            title: 'XemGiaDat',
                            text,
                            url: link
                        });
                        return;
                    }
                    await copyToClipboard(link);
                    return;
                }

                let shareUrl = '';
                if (platform === 'facebook') {
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}&quote=${encodeURIComponent(text)}`;
                } else if (platform === 'whatsapp') {
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + link)}`;
                }

                if (shareUrl) {
                    window.open(shareUrl, '_blank', 'width=600,height=400');
                }
            };

            const handleLogin = () => {
                setShowLogin(true);
            };

            const handleLogout = async () => {
                try {
                    const auth = window.__firebaseAuth || window.firebase?.auth?.();
                    if (auth) await auth.signOut();
                } catch (err) {
                    console.warn('[Auth] Logout failed:', err);
                }
            };

            return (
                <div className="relative w-full h-full select-none bg-slate-900">
                    {/* Search Bar */}
                    <div className="absolute top-4 left-4 right-4 z-50 flex items-center gap-2">
                        {/* Search Bar with Glassmorphism */}
                        <div className="flex-1" style={{maxWidth: '600px'}}>
                            <form onSubmit={handleSearch} className="rounded-2xl shadow-2xl border" style={{backdropFilter: 'blur(24px)', backgroundColor: 'rgba(255, 255, 255, 0.9)', borderColor: 'rgba(255, 255, 255, 0.2)'}}>
                                <div className="flex items-center px-4 py-3">
                                    <Icons.Search />
                                    <input 
                                        type="text"
                                        placeholder="Nh·∫≠p s·ªë t·ªù v√† s·ªë th·ª≠a (VD: 45 123)" 
                                        className="flex-1 outline-none text-slate-900 font-semibold placeholder-slate-400 px-3"
                                        value={searchQuery}
                                        onChange={e => setSearchQuery(e.target.value)}
                                    />
                                    {searchQuery && (
                                        <button type="button" onClick={()=>{setSearchQuery(''); setSearchResults([]);}} className="p-1">
                                            <Icons.X />
                                        </button>
                                    )}
                                </div>

                                {/* Commune Dropdown */}
                                <div className="px-4 pb-2">
                                    <select
                                        value={selectedMaXa}
                                        onChange={e => setSelectedMaXa(e.target.value)}
                                        disabled={isCommuneLoading}
                                        className="w-full text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 font-medium text-slate-700 outline-none focus:border-blue-400"
                                    >
                                        <option value="">
                                            {isCommuneLoading ? '‚è≥ ƒêang t·∫£i x√£/ph∆∞·ªùng...' : 'üèòÔ∏è Ch·ªçn x√£/ph∆∞·ªùng (t√¨m nhanh)'}
                                        </option>
                                        {communeOptions.map(code => (
                                            <option key={code} value={code}>M√£ x√£: {code}</option>
                                        ))}
                                    </select>
                                </div>
                            
                                {/* Search Results */}
                                {(isSearching || searchResults.length > 0) && (
                                    <div className="border-t border-slate-100" style={{maxHeight: '300px', overflowY: 'auto'}}>
                                        {isSearching ? (
                                            <div className="px-4 py-8 text-center text-slate-500">
                                                <div style={{display: 'inline-block', width: '24px', height: '24px', border: '2px solid #e2e8f0', borderTopColor: '#0f172a', borderRadius: '50%', animation: 'spin 1s linear infinite'}}></div>
                                                <p style={{marginTop: '8px', fontSize: '14px'}}>ƒêang t√¨m ki·∫øm...</p>
                                            </div>
                                        ) : searchResults.length === 0 ? (
                                            <div className="px-4 py-6 text-center" style={{fontSize: '14px'}}>
                                                <p className="text-slate-700 font-semibold mb-2">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>
                                                <p className="text-slate-500 text-xs">
                                                    üí° H√£y zoom/pan b·∫£n ƒë·ªì ƒë·∫øn khu v·ª±c ƒê√† N·∫µng v√† th·ª≠ l·∫°i
                                                </p>
                                            </div>
                                        ) : (
                                            searchResults.map((parcel, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => handleSelectResult(parcel)}
                                                    className="w-full px-4 py-3 text-left border-b border-slate-100 hover:bg-slate-50 transition-colors"
                                                    style={{display: 'block', width: '100%'}}
                                                >
                                                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                                        <div>
                                                            <p className="font-bold text-slate-900">
                                                                T·ªù {parcel.so_to} / Th·ª≠a {parcel.so_thua}
                                                            </p>
                                                            <p className="text-slate-500" style={{fontSize: '12px', marginTop: '4px'}}>
                                                                {parcel.dia_chi} ‚Ä¢ {parcel.dien_tich} m¬≤
                                                            </p>
                                                        </div>
                                                        <Icons.MapPin />
                                                    </div>
                                                </button>
                                            ))
                                        )}
                                    </div>
                                )}
                            </form>
                        </div>

                        {/* Auth Button - Inline with Search */}
                        <div className="flex-shrink-0">
                            {authUser ? (
                                <div className="relative">
                                    <button
                                        onClick={() => setShowUserMenu(!showUserMenu)}
                                        className="flex items-center gap-1.5 px-2.5 py-2 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow transition-shadow"
                                    >
                                        {authUser.photoURL ? (
                                            <img src={authUser.photoURL} alt="avatar" className="w-6 h-6 rounded-full" />
                                        ) : (
                                            <div className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                                <Icons.User className="w-3 h-3 text-blue-600" />
                                            </div>
                                        )}
                                        <span className="text-xs font-bold text-slate-700 hidden sm:inline">
                                            {(authUser.displayName || authUser.email || 'User').split(' ')[0]}
                                        </span>
                                    </button>

                                    {showUserMenu && (
                                        <div className="absolute right-0 mt-1 w-36 bg-white rounded-lg border border-slate-200 shadow-xl overflow-hidden z-10">
                                            <button
                                                onClick={() => { setShowUserMenu(false); handleLogout(); }}
                                                className="w-full px-3 py-2 text-left text-xs font-bold text-red-600 hover:bg-red-50"
                                            >
                                                ƒêƒÉng xu·∫•t
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <button
                                    onClick={handleLogin}
                                    className="flex items-center gap-1 px-3 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl shadow-md hover:shadow-lg transition-all text-xs font-black"
                                >
                                    <Icons.User className="w-4 h-4" />
                                    <span className="hidden sm:inline">ƒêƒÉng nh·∫≠p</span>
                                </button>
                            )}
                        </div>
                    </div>

                    <div ref={mapContainer} className="map-container" />

                    {/* 3D View Toggle Button */}
                    <div className="absolute bottom-28 right-4 z-50">
                        <button
                            onClick={toggle3DView}
                            className="rounded-full shadow-2xl border p-2 transition-all w-10 h-10 flex flex-col items-center justify-center"
                            style={{
                                backdropFilter: 'blur(24px)',
                                backgroundColor: is3DView ? 'rgba(37, 99, 235, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                                borderColor: is3DView ? 'rgba(96, 165, 250, 0.2)' : 'rgba(255, 255, 255, 0.2)'
                            }}
                            aria-label={is3DView ? 'Chuy·ªÉn v·ªÅ 2D' : 'Chuy·ªÉn sang 3D'}
                        >
                            <Icons.Box className={is3DView ? 'text-white w-5 h-5' : 'text-slate-700 w-5 h-5'} />
                        </button>
                    </div>
                    
                    {/* AI Consultant Button */}
                    <div className="absolute bottom-48 right-4 z-50">
                        <button
                            onClick={() => { setShowAIConsultant(true); triggerHaptic('medium'); }}
                            className="rounded-full shadow-2xl border p-2 transition-all w-10 h-10 flex items-center justify-center"
                            style={{
                                backdropFilter: 'blur(24px)',
                                background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.9), rgba(99, 102, 241, 0.9))',
                                borderColor: 'rgba(167, 139, 250, 0.3)'
                            }}
                            aria-label="AI T∆∞ v·∫•n"
                        >
                            <Icons.Sparkles className="text-white w-5 h-5" />
                        </button>
                    </div>

                    {(selected || selectedListing) && (
                        <>
                            {/* Bottom Sheet Overlay */}
                            <div 
                                className="bottom-sheet-overlay"
                                onClick={() => { setSelected(null); setSelectedListing(null); isListingInteractionActive.current = false; }}
                            />
                            
                            <div 
                                className={`absolute bottom-0 inset-x-0 z-[100] bottom-sheet ${isDragging ? 'dragging' : ''}`}
                                style={{ transform: `translateY(${sheetTranslateY}px)` }}
                                onTouchStart={handleSheetTouchStart}
                                onTouchMove={handleSheetTouchMove}
                                onTouchEnd={handleSheetTouchEnd}
                            >
                                <div className="max-w-xl mx-auto rounded-t-[2.5rem] pb-safe border-t overflow-hidden" style={{backdropFilter: 'blur(48px)', backgroundColor: 'rgba(255, 255, 255, 0.95)', boxShadow: '0 -20px 60px rgba(0, 0, 0, 0.3)', borderColor: 'rgba(255, 255, 255, 0.2)'}}>
                                    <div className="h-10 flex justify-center items-center cursor-pointer" onClick={() => { setSelected(null); setSelectedListing(null); isListingInteractionActive.current = false; }}>
                                        <div className="w-12 h-1.5 bg-slate-300 rounded-full" />
                                    </div>

                                <div className="px-5 pb-6 overflow-y-auto max-h-[80vh] scrollbar-hide">
                                    {view === 'info' && selected && (
                                        <div className="animate-slide-up">
                                            {/* Status Badges */}
                                            {getStatusBadges(selected).length > 0 && (
                                                <div className="flex gap-2 mb-3 flex-wrap">
                                                    {getStatusBadges(selected).map((badge, i) => (
                                                        <span 
                                                            key={i}
                                                            className="px-3 py-1 rounded-full text-xs font-bold"
                                                            style={{
                                                                backdropFilter: 'blur(8px)',
                                                                backgroundColor: badge.includes('Gi√° t·ªët') || badge.includes('H·ª£p l√Ω') ? '#dcfce7' :
                                                                    badge.includes('Cao c·∫•p') || badge.includes('H·∫°ng sang') ? '#f3e8ff' :
                                                                    badge.includes('M·ªõi ƒëƒÉng') ? '#dbeafe' :
                                                                    badge.includes('ƒê√£ x√°c th·ª±c') ? '#d1fae5' : '#f1f5f9',
                                                                color: badge.includes('Gi√° t·ªët') || badge.includes('H·ª£p l√Ω') ? '#15803d' :
                                                                    badge.includes('Cao c·∫•p') || badge.includes('H·∫°ng sang') ? '#7e22ce' :
                                                                    badge.includes('M·ªõi ƒëƒÉng') ? '#1e40af' :
                                                                    badge.includes('ƒê√£ x√°c th·ª±c') ? '#047857' : '#475569',
                                                                border: '1px solid',
                                                                borderColor: badge.includes('Gi√° t·ªët') || badge.includes('H·ª£p l√Ω') ? '#bbf7d0' :
                                                                    badge.includes('Cao c·∫•p') || badge.includes('H·∫°ng sang') ? '#e9d5ff' :
                                                                    badge.includes('M·ªõi ƒëƒÉng') ? '#bfdbfe' :
                                                                    badge.includes('ƒê√£ x√°c th·ª±c') ? '#a7f3d0' : '#e2e8f0'
                                                            }}
                                                        >
                                                            {badge}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="flex justify-between items-start mb-3 gap-2">
                                                <div className="flex-1 min-w-0">
                                                    <h2 className="text-lg font-black text-slate-900 leading-tight">
                                                        Th·ª≠a {selected.so_thua}
                                                    </h2>
                                                    <p className="text-xs text-slate-500 font-medium flex items-center gap-0.5 mt-0.5 truncate">
                                                        <Icons.MapPin /> {selected.dia_chi}
                                                    </p>
                                                </div>
                                                <button onClick={() => { setSelected(null); isListingInteractionActive.current = false; }} className="p-1 bg-slate-100 rounded-lg flex-shrink-0 mt-0.5">
                                                    <Icons.X className="w-4 h-4" />
                                                </button>
                                            </div>

                                            <div className="grid grid-cols-3 gap-1.5 mb-3 text-center">
                                                <div className="bg-blue-50 p-2 rounded-lg border border-blue-100">
                                                    <p className="text-[8px] font-bold text-blue-600 uppercase tracking-widest">T·ªù</p>
                                                    <p className="text-sm font-black text-slate-800">{selected.so_to}</p>
                                                </div>
                                                <div className="bg-green-50 p-2 rounded-lg border border-green-100">
                                                    <p className="text-[8px] font-bold text-green-600 uppercase tracking-widest">DT</p>
                                                    <p className="text-xs font-black text-slate-800">{selected.dien_tich}m¬≤</p>
                                                </div>
                                                <div className="bg-amber-50 p-2 rounded-lg border border-amber-100">
                                                    <p className="text-[8px] font-bold text-amber-600 uppercase tracking-widest">M·ª•c</p>
                                                    <p className="text-xs font-black text-slate-800 truncate">{selected.muc_dich?.substring(0, 3)}</p>
                                                </div>
                                            </div>

                                            {/* AI Insights Section */}
                                            {getAIInsight(selected) && (
                                                <div className="p-5 rounded-2xl mb-3 border" style={{
                                                    backdropFilter: 'blur(8px)',
                                                    background: 'linear-gradient(to bottom right, rgba(238, 242, 255, 0.8), rgba(243, 232, 255, 0.8))',
                                                    borderColor: 'rgba(199, 210, 254, 0.5)'
                                                }}>
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <Icons.Sparkles style={{color: '#4f46e5', width: '20px', height: '20px'}} />
                                                        <span className="text-xs font-bold uppercase tracking-widest" style={{color: '#1e1b4b'}}>AI ƒê√°nh gi√°</span>
                                                    </div>
                                                    <div className="flex items-start gap-3">
                                                        {getAIInsight(selected).type === 'good' && <Icons.TrendingDown style={{color: '#16a34a', width: '20px', height: '20px', flexShrink: 0, marginTop: '2px'}} />}
                                                        {getAIInsight(selected).type === 'high' && <Icons.TrendingUp style={{color: '#9333ea', width: '20px', height: '20px', flexShrink: 0, marginTop: '2px'}} />}
                                                        {getAIInsight(selected).type === 'potential' && <Icons.Eye style={{color: '#2563eb', width: '20px', height: '20px', flexShrink: 0, marginTop: '2px'}} />}
                                                        <p className="text-sm leading-relaxed font-medium" style={{color: '#334155'}}>
                                                            {getAIInsight(selected).message}
                                                        </p>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Primary Action Buttons */}
                                            <div className="grid grid-cols-3 gap-1.5 mb-2">
                                                <button 
                                                    onClick={() => {
                                                        triggerHaptic('medium');
                                                        if (!authUser) {
                                                            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng tin rao b√°n!');
                                                            setShowLogin(true);
                                                            return;
                                                        }
                                                        setView('form');
                                                    }} 
                                                    className="h-10 text-white rounded-lg font-black text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                    style={{background: 'linear-gradient(to right, #0f172a, #1e293b)'}}
                                                >
                                                    <Icons.Rocket /> Rao
                                                </button>
                                                <button
                                                    onClick={() => { triggerHaptic('light'); setShareOpen(true); }}
                                                    className="h-10 bg-blue-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.Share /> Chia
                                                </button>
                                                <button
                                                    onClick={async () => { 
                                                        triggerHaptic('light'); 
                                                        const payload = buildSharePayload();
                                                        const link = generateShareLink(payload);
                                                        await copyToClipboard(link);
                                                        // Show enhanced toast notification
                                                        alert('‚úÖ ƒê√£ sao ch√©p! K√®m th√¥ng tin t√≥m t·∫Øt:\n\nTh·ª≠a ' + selected.so_thua + ' - T·ªù ' + selected.so_to + '\nDT: ' + selected.dien_tich + 'm¬≤');
                                                    }}
                                                    className="h-10 bg-slate-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.Copy /> Link
                                                </button>
                                            </div>
                                            
                                            {/* Secondary Action Buttons - Feature Parity with Listing */}
                                            <div className="grid grid-cols-3 gap-1.5">
                                                <a
                                                    href={`https://www.google.com/maps/dir/?api=1&destination=${selected.coordinates[1]},${selected.coordinates[0]}`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    onClick={() => triggerHaptic('medium')}
                                                    className="h-10 bg-blue-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.Navigation className="w-4 h-4" /> Ch·ªâ ƒë∆∞·ªùng
                                                </a>
                                                <button
                                                    onClick={() => {
                                                        setShowStreetView(true);
                                                        triggerHaptic('medium');
                                                    }}
                                                    className="h-10 bg-amber-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.Eye className="w-4 h-4" /> Th·ª±c t·∫ø
                                                </button>
                                                <a
                                                    href={`https://www.google.com/maps/search/ti·ªán+√≠ch,+tr∆∞·ªùng+h·ªçc,+ch·ª£/@${selected.coordinates[1]},${selected.coordinates[0]},15z`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    onClick={() => triggerHaptic('medium')}
                                                    className="h-10 bg-green-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.MapPin className="w-4 h-4" /> Ti·ªán √≠ch
                                                </a>
                                            </div>
                                        </div>
                                    )}

                                    {view === 'form' && (
                                        <div className="animate-slide-up">
                                            <div className="flex items-center gap-4 mb-6">
                                                <button onClick={() => setView('info')} className="p-2 bg-slate-100 rounded-full"><Icons.ArrowLeft /></button>
                                                <h2 className="text-xl font-black text-slate-900">Th√¥ng tin rao b√°n</h2>
                                            </div>

                                            <div className="space-y-4">
                                                <div className="p-4 bg-slate-50 border border-slate-200 rounded-2xl flex justify-between">
                                                    <div><p className="text-[9px] text-slate-400 font-bold uppercase">S·ªë t·ªù/th·ª≠a (GIS)</p><p className="font-black text-slate-700">{selected.so_to} / {selected.so_thua}</p></div>
                                                    <div><p className="text-[9px] text-slate-400 font-bold uppercase">Di·ªán t√≠ch</p><p className="font-black text-slate-700">{selected.dien_tich}m¬≤</p></div>
                                                </div>

                                                {/* Lo·∫°i giao d·ªãch */}
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-600 uppercase mb-2">Lo·∫°i giao d·ªãch</label>
                                                    <select value={form.transactionType} onChange={e=>setForm({...form, transactionType:e.target.value})} className="w-full h-12 bg-white border border-slate-200 rounded-xl px-4 font-medium outline-none focus:border-blue-500">
                                                        <option value="ban-dat">üè∑Ô∏è B√°n ƒë·∫•t</option>
                                                        <option value="ban-nha">üè† B√°n nh√†/nh√† ph·ªë</option>
                                                        <option value="cho-thue">üîë Cho thu√™</option>
                                                        <option value="tim-mua">üîç T√¨m mua</option>
                                                    </select>
                                                </div>

                                                {/* Gi√° & ƒê∆°n v·ªã */}
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="relative">
                                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-400">GI√Å</div>
                                                        <input type="number" placeholder="Nh·∫≠p gi√°..." className="w-full h-12 bg-white border border-slate-200 rounded-xl pl-10 pr-3 font-bold text-sm outline-none focus:border-blue-500" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} />
                                                    </div>
                                                    <select value={form.priceUnit} onChange={e=>setForm({...form, priceUnit:e.target.value})} className="h-12 bg-white border border-slate-200 rounded-xl px-2 font-bold text-xs outline-none focus:border-blue-500">
                                                        <option value="VND">VND</option>
                                                        <option value="VND/m¬≤">VND/m¬≤</option>
                                                        <option value="tri·ªáu/m¬≤">Tri·ªáu/m¬≤</option>
                                                        <option value="t·ª∑">T·ª∑</option>
                                                    </select>
                                                </div>

                                                {/* Th∆∞∆°ng l∆∞·ª£ng */}
                                                <label className="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-xl cursor-pointer">
                                                    <input type="checkbox" checked={form.isNegotiable} onChange={e=>setForm({...form, isNegotiable:e.target.checked})} className="w-5 h-5 accent-blue-600" />
                                                    <span className="text-sm font-bold text-slate-700">üí¨ Gi√° c√≥ th·ªÉ th∆∞∆°ng l∆∞·ª£ng</span>
                                                </label>

                                                {/* Th√¥ng tin li√™n h·ªá t·ª´ profile */}
                                                <div className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs">
                                                    <p className="font-bold text-slate-700 mb-1">üìû Th√¥ng tin li√™n h·ªá</p>
                                                    <p className="text-slate-500">ƒê∆∞·ª£c l·∫•y t·ª´ h·ªì s∆° c·ªßa b·∫°n: {authUser?.displayName} ({authUser?.email})</p>
                                                    <p className="text-blue-600 mt-1">üí° C·∫≠p nh·∫≠t SƒêT t·∫°i ph·∫ßn H·ªì s∆° ƒë·ªÉ hi·ªÉn th·ªã cho ng∆∞·ªùi xem</p>
                                                </div>

                                                {/* M√¥ t·∫£ */}
                                                <textarea placeholder="Ghi ch√∫ th√™m (h∆∞·ªõng ƒë·∫•t, ph√°p l√Ω, ti·ªÅm nƒÉng...)" className="w-full h-20 bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm font-medium outline-none focus:border-blue-500 resize-none" value={form.note} onChange={e=>setForm({...form, note:e.target.value})} />

                                                {/* ·∫¢nh */}
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-600 uppercase mb-2">H√¨nh ·∫£nh (t√πy ch·ªçn)</label>
                                                    <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                                                        <label className="w-20 h-20 shrink-0 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center cursor-pointer hover:bg-blue-50 transition">
                                                            <Icons.Camera />
                                                            <input type="file" multiple className="hidden" onChange={handleImageUpload} accept="image/*" />
                                                        </label>
                                                        {images.map((img, i) => (
                                                            <div key={i} className="relative w-20 h-20 shrink-0">
                                                                <img src={img} className="w-full h-full object-cover rounded-2xl border" />
                                                                <button onClick={()=>setImages(images.filter((_,idx)=>idx!==i))} className="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full shadow-lg"><Icons.X /></button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                <button 
                                                    onClick={submitForm} 
                                                    disabled={isSubmitting || (!form.isNegotiable && !form.price)}
                                                    className={`w-full h-14 rounded-2xl font-black text-base shadow-xl active:scale-95 transition-all
                                                        ${isSubmitting || (!form.isNegotiable && !form.price) ? 'bg-slate-200 text-slate-400' : 'bg-green-600 text-white'}
                                                    `}
                                                >
                                                    {isSubmitting ? '‚è≥ ƒêang g·ª≠i...' : '‚úì Ho√†n t·∫•t ƒëƒÉng tin'}
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {view === 'success' && (
                                        <div className="flex flex-col items-center justify-center py-16 animate-slide-up">
                                            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 shadow-inner">
                                                <Icons.Check />
                                            </div>
                                            <h2 className="text-2xl font-black text-slate-900 mb-2">ƒê√£ ghi nh·∫≠n!</h2>
                                            <p className="text-slate-500 text-center max-w-[240px] text-sm">D·ªØ li·ªáu rao b√°n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c li√™n k·∫øt v·ªõi b·∫£n ƒë·ªì GIS ch√≠nh x√°c.</p>
                                        </div>
                                    )}

                                    {view === 'listing-detail' && selectedListing && (
                                        <div className="animate-slide-up">
                                            {/* Status Badges */}
                                            {getStatusBadges(selectedListing).length > 0 && (
                                                <div className="flex gap-2 mb-3 flex-wrap">
                                                    {getStatusBadges(selectedListing).map((badge, i) => (
                                                        <span 
                                                            key={i}
                                                            className="px-3 py-1 rounded-full text-xs font-bold"
                                                            style={{
                                                                backdropFilter: 'blur(8px)',
                                                                backgroundColor: badge.includes('Gi√° t·ªët') || badge.includes('H·ª£p l√Ω') ? '#dcfce7' :
                                                                    badge.includes('Cao c·∫•p') || badge.includes('H·∫°ng sang') ? '#f3e8ff' :
                                                                    badge.includes('M·ªõi ƒëƒÉng') ? '#dbeafe' :
                                                                    badge.includes('ƒê√£ x√°c th·ª±c') ? '#d1fae5' : '#f1f5f9',
                                                                color: badge.includes('Gi√° t·ªët') || badge.includes('H·ª£p l√Ω') ? '#15803d' :
                                                                    badge.includes('Cao c·∫•p') || badge.includes('H·∫°ng sang') ? '#7e22ce' :
                                                                    badge.includes('M·ªõi ƒëƒÉng') ? '#1e40af' :
                                                                    badge.includes('ƒê√£ x√°c th·ª±c') ? '#047857' : '#475569',
                                                                border: '1px solid',
                                                                borderColor: badge.includes('Gi√° t·ªët') || badge.includes('H·ª£p l√Ω') ? '#bbf7d0' :
                                                                    badge.includes('Cao c·∫•p') || badge.includes('H·∫°ng sang') ? '#e9d5ff' :
                                                                    badge.includes('M·ªõi ƒëƒÉng') ? '#bfdbfe' :
                                                                    badge.includes('ƒê√£ x√°c th·ª±c') ? '#a7f3d0' : '#e2e8f0'
                                                            }}
                                                        >
                                                            {badge}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="flex justify-between items-start mb-3 gap-2">
                                                <div className="flex-1 min-w-0">
                                                    <h2 className="text-lg font-black text-slate-900 leading-tight">
                                                        {selectedListing.loaiGiaoDich === 'ban-dat' ? 'üè∑Ô∏è B√°n ƒë·∫•t' : 
                                                         selectedListing.loaiGiaoDich === 'ban-nha' ? 'üè† B√°n nh√†' :
                                                         selectedListing.loaiGiaoDich === 'cho-thue' ? 'üîë Cho thu√™' : 'Tin ƒëƒÉng'}
                                                    </h2>
                                                    <p className="text-xs text-slate-500 font-medium flex items-center gap-0.5 mt-0.5 truncate">
                                                        <Icons.MapPin /> T·ªù {selectedListing.so_to || 'N/A'} / Th·ª≠a {selectedListing.so_thua || 'N/A'}
                                                    </p>
                                                </div>
                                                <button onClick={() => { setSelectedListing(null); isListingInteractionActive.current = false; }} className="p-1 bg-slate-100 rounded-lg flex-shrink-0 mt-0.5">
                                                    <Icons.X className="w-4 h-4" />
                                                </button>
                                            </div>

                                            <div className="grid grid-cols-2 gap-2 mb-3">
                                                <div className="bg-green-50 p-3 rounded-lg border border-green-100">
                                                    <p className="text-[8px] font-bold text-green-600 uppercase tracking-widest mb-1">Di·ªán t√≠ch</p>
                                                    <p className="text-base font-black text-slate-800">{selectedListing.dien_tich} m¬≤</p>
                                                </div>
                                                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                                    <p className="text-[8px] font-bold text-blue-600 uppercase tracking-widest mb-1">Gi√° b√°n</p>
                                                    <p className="text-sm font-black text-slate-800">
                                                        {selectedListing.isNegotiable ? 
                                                          'TL' : 
                                                          selectedListing.priceValue > 0 ? 
                                                            (selectedListing.priceValue / 1000000000).toFixed(1) + 'B' : 
                                                            'Li√™n h·ªá'
                                                        }
                                                    </p>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-2 mb-3">
                                                <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                                                    <p className="text-[8px] font-bold text-purple-600 uppercase tracking-widest mb-1">Ng√†y ƒëƒÉng</p>
                                                    <p className="text-xs font-black text-slate-800">
                                                        {selectedListing.createdAt ? 
                                                          (() => {
                                                              try {
                                                                  // Handle Firebase Timestamp
                                                                  const date = selectedListing.createdAt.toDate ? 
                                                                      selectedListing.createdAt.toDate() : 
                                                                      new Date(selectedListing.createdAt);
                                                                  const now = new Date();
                                                                  const diffTime = now - date;
                                                                  
                                                                  // Handle future dates
                                                                  if (diffTime < 0) return 'M·ªõi ƒëƒÉng';
                                                                  
                                                                  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                                                                  
                                                                  if (diffDays === 0) return 'H√¥m nay';
                                                                  if (diffDays === 1) return 'H√¥m qua';
                                                                  if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
                                                                  if (diffDays < 28) return `${Math.floor(diffDays / 7)} tu·∫ßn tr∆∞·ªõc`;
                                                                  
                                                                  // Calculate actual month difference for longer periods
                                                                  const yearDiff = now.getFullYear() - date.getFullYear();
                                                                  const monthDiff = now.getMonth() - date.getMonth();
                                                                  let totalMonths = yearDiff * 12 + monthDiff;
                                                                  
                                                                  // Adjust if day hasn't been reached yet in current month
                                                                  if (now.getDate() < date.getDate()) {
                                                                      totalMonths--;
                                                                  }
                                                                  
                                                                  if (totalMonths > 0 && totalMonths < 12) return `${totalMonths} th√°ng tr∆∞·ªõc`;
                                                                  return date.toLocaleDateString('vi-VN');
                                                              } catch (e) {
                                                                  return 'N/A';
                                                              }
                                                          })() : 
                                                          'N/A'
                                                        }
                                                    </p>
                                                </div>
                                                <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                                                    <p className="text-[8px] font-bold text-orange-600 uppercase tracking-widest mb-1">L∆∞·ª£t xem</p>
                                                    <p className="text-xs font-black text-slate-800">
                                                        {selectedListing.viewCount || 0}
                                                    </p>
                                                </div>
                                            </div>

                                            {selectedListing.note && (
                                                <div className="bg-amber-50 border border-amber-100 p-3 rounded-lg mb-3">
                                                    <div className="flex items-center gap-1 mb-1">
                                                        <Icons.FileText className="w-3 h-3 text-amber-600" />
                                                        <span className="text-[8px] font-bold text-amber-600 uppercase tracking-widest">Ghi ch√∫</span>
                                                    </div>
                                                    <p className="text-xs text-slate-700 leading-relaxed">{selectedListing.note}</p>
                                                </div>
                                            )}

                                            {/* AI Insights Section */}
                                            {getAIInsight(selectedListing) && (
                                                <div className="p-5 rounded-2xl mb-3 border" style={{
                                                    backdropFilter: 'blur(8px)',
                                                    background: 'linear-gradient(to bottom right, rgba(238, 242, 255, 0.8), rgba(243, 232, 255, 0.8))',
                                                    borderColor: 'rgba(199, 210, 254, 0.5)'
                                                }}>
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <Icons.Sparkles style={{color: '#4f46e5', width: '20px', height: '20px'}} />
                                                        <span className="text-xs font-bold uppercase tracking-widest" style={{color: '#1e1b4b'}}>AI ƒê√°nh gi√°</span>
                                                    </div>
                                                    <div className="flex items-start gap-3">
                                                        {getAIInsight(selectedListing).type === 'good' && <Icons.TrendingDown style={{color: '#16a34a', width: '20px', height: '20px', flexShrink: 0, marginTop: '2px'}} />}
                                                        {getAIInsight(selectedListing).type === 'high' && <Icons.TrendingUp style={{color: '#9333ea', width: '20px', height: '20px', flexShrink: 0, marginTop: '2px'}} />}
                                                        {getAIInsight(selectedListing).type === 'potential' && <Icons.Eye style={{color: '#2563eb', width: '20px', height: '20px', flexShrink: 0, marginTop: '2px'}} />}
                                                        <p className="text-sm leading-relaxed font-medium" style={{color: '#334155'}}>
                                                            {getAIInsight(selectedListing).message}
                                                        </p>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Contact Info - Move to collapsible section */}
                                            {!showProfile && (
                                                <button
                                                    onClick={() => setShowProfile(true)}
                                                    className="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg mb-3 text-left"
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-xs font-bold text-slate-600">Xem h·ªì s∆° ng∆∞·ªùi b√°n</span>
                                                        <Icons.ChevronDown className="w-4 h-4 text-slate-400" />
                                                    </div>
                                                </button>
                                            )}
                                            
                                            {showProfile && (
                                                <div className="bg-slate-50 border border-slate-200 p-3 rounded-lg mb-3 animate-slide-up">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-1">
                                                            <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse" />
                                                            <span className="text-[8px] font-bold text-slate-400 uppercase tracking-widest">H·ªì s∆°</span>
                                                        </div>
                                                        <button onClick={() => setShowProfile(false)}>
                                                            <Icons.ChevronUp className="w-4 h-4 text-slate-400" />
                                                        </button>
                                                    </div>
                                                    <p className="font-bold text-slate-900 text-sm mb-1">{selectedListing.userName}</p>
                                                    {selectedListing.phone && (
                                                        <a href={`tel:${selectedListing.phone}`} className="text-blue-600 font-semibold text-sm flex items-center gap-1 hover:underline">
                                                            <Icons.Phone className="w-3 h-3" />
                                                            {selectedListing.phone}
                                                        </a>
                                                    )}
                                                </div>
                                            )}

                                            {/* Primary Action Buttons - G·ªçi ngay & Zalo */}
                                            <div className="grid grid-cols-2 gap-2 mb-3">
                                                {selectedListing.phone && (
                                                    <>
                                                        <a 
                                                            href={`tel:${selectedListing.phone}`}
                                                            onClick={() => triggerHaptic('heavy')}
                                                            className="h-12 text-white rounded-xl font-black text-sm flex items-center justify-center gap-2 transition-all active:scale-95"
                                                            style={{background: 'linear-gradient(to right, #16a34a, #15803d)'}}
                                                        >
                                                            <Icons.Phone className="w-5 h-5" /> G·ªçi ngay
                                                        </a>
                                                        <a 
                                                            href={`https://zalo.me/${selectedListing.phone.replace(/\D/g, '')}?text=${encodeURIComponent(`Ch√†o anh/ch·ªã, t√¥i quan t√¢m l√¥ ƒë·∫•t ${selectedListing.so_to || 'N/A'}/${selectedListing.so_thua || 'N/A'} - DT ${selectedListing.dien_tich || 0}m¬≤ - Gi√° ${selectedListing.isNegotiable ? 'th∆∞∆°ng l∆∞·ª£ng' : (selectedListing.priceValue > 0 ? (selectedListing.priceValue / 1000000000).toFixed(1) + ' t·ª∑' : 'li√™n h·ªá')}. Xin vui l√≤ng t∆∞ v·∫•n th√™m. C·∫£m ∆°n!`)}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            onClick={() => triggerHaptic('heavy')}
                                                            className="h-12 text-white rounded-xl font-black text-sm flex items-center justify-center gap-2 transition-all active:scale-95"
                                                            style={{background: 'linear-gradient(to right, #0068ff, #0180ff)'}}
                                                        >
                                                            üí¨ Zalo
                                                        </a>
                                                    </>
                                                )}
                                            </div>
                                            
                                            {/* Secondary Action Buttons */}
                                            <div className="grid grid-cols-4 gap-2 mb-2">
                                                <a
                                                    href={`https://www.google.com/maps/dir/?api=1&destination=${selectedListing.coordinates[1]},${selectedListing.coordinates[0]}`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    onClick={() => triggerHaptic('medium')}
                                                    className="h-10 bg-blue-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.Navigation className="w-4 h-4" /> Ch·ªâ ƒë∆∞·ªùng
                                                </a>
                                                <button
                                                    onClick={() => {
                                                        setShowStreetView(true);
                                                        triggerHaptic('medium');
                                                    }}
                                                    className="h-10 bg-amber-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                >
                                                    <Icons.Eye className="w-4 h-4" /> Xem th·ª±c t·∫ø
                                                </button>
                                                <button
                                                    onClick={() => { triggerHaptic('light'); setShareOpen(true); }}
                                                    className="h-10 bg-blue-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                    aria-label="Chia s·∫ª"
                                                >
                                                    <Icons.Share /> Chia
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        triggerHaptic('medium');
                                                        BookmarkService.toggleBookmark(selectedListing.id);
                                                        setSelectedListing({...selectedListing}); // Force re-render
                                                    }}
                                                    className="h-10 text-slate-700 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-all active:scale-95"
                                                    style={{backdropFilter: 'blur(8px)', backgroundColor: 'rgba(241, 245, 249, 0.8)'}}
                                                >
                                                    {BookmarkService.isBookmarked(selectedListing.id) ? 
                                                        <><Icons.BookmarkCheck className="w-4 h-4" /> ƒê√£ l∆∞u</> : 
                                                        <><Icons.Bookmark className="w-4 h-4" /> L∆∞u</>
                                                    }
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        </>
                    )}

                    {shareOpen && (
                        <div className="fixed inset-0 z-[150] bg-black/40 flex items-end justify-center">
                            <div className="w-full max-w-md bg-white rounded-t-3xl p-6 shadow-2xl">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-black text-slate-900">Chia s·∫ª th·ª≠a ƒë·∫•t</h3>
                                    <button onClick={() => setShareOpen(false)} className="p-2 bg-slate-100 rounded-full"><Icons.X /></button>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => shareToPlatform('facebook')} className="h-12 rounded-xl bg-blue-600 text-white font-bold">Facebook</button>
                                    <button onClick={() => shareToPlatform('whatsapp')} className="h-12 rounded-xl bg-green-600 text-white font-bold">WhatsApp</button>
                                    <button onClick={() => shareToPlatform('zalo')} className="h-12 rounded-xl bg-slate-100 text-slate-700 font-bold">Zalo (Copy)</button>
                                    <button onClick={() => shareToPlatform('native')} className="h-12 rounded-xl bg-slate-900 text-white font-bold">Chia s·∫ª kh√°c</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showLogin && (
                        <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                            <div className="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden">
                                <div className="flex items-center justify-between px-5 py-4 border-b border-slate-100">
                                    <h3 className="text-lg font-black text-slate-900">ƒêƒÉng nh·∫≠p</h3>
                                    <button onClick={() => setShowLogin(false)} className="p-2 bg-slate-100 rounded-full"><Icons.X /></button>
                                </div>
                                <div id="firebaseui-auth-container" className="p-4"></div>
                            </div>
                        </div>
                    )}
                    
                    {/* AI Consultant Modal */}
                    {showAIConsultant && (
                        <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                            <div className="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                                <div className="flex items-center justify-between px-5 py-4 border-b border-slate-100"
                                    style={{
                                        background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1))'
                                    }}
                                >
                                    <div className="flex items-center gap-2">
                                        <Icons.Sparkles className="w-6 h-6" style={{color: '#8b5cf6'}} />
                                        <h3 className="text-lg font-black text-slate-900">AI T∆∞ v·∫•n Lu·∫≠t ƒê·∫•t ƒêai</h3>
                                    </div>
                                    <button onClick={() => { setShowAIConsultant(false); setAiResponse(null); setAiQuery(''); }} className="p-2 bg-slate-100 rounded-full">
                                        <Icons.X />
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-5 space-y-4">
                                    <div className="bg-gradient-to-br from-purple-50 to-indigo-50 p-4 rounded-2xl border border-purple-100">
                                        <p className="text-sm text-slate-700 leading-relaxed">
                                            <strong>ü§ñ Tr·ª£ l√Ω AI th√¥ng minh</strong> - H·ªèi t√¥i v·ªÅ <strong>Lu·∫≠t ƒê·∫•t ƒêai 2024</strong> v√† <strong>B·∫£ng gi√° ƒë·∫•t 2026</strong>. 
                                            T√¥i c√≥ th·ªÉ gi√∫p b·∫°n hi·ªÉu quy·ªÅn l·ª£i, nghƒ©a v·ª• v√† gi√° tr·ªã th·ª±c c·ªßa th·ª≠a ƒë·∫•t.
                                        </p>
                                    </div>
                                    
                                    {/* Sample Questions */}
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">C√¢u h·ªèi g·ª£i √Ω</p>
                                        <div className="grid gap-2">
                                            {[
                                                'Quy ƒë·ªãnh v·ªÅ chuy·ªÉn nh∆∞·ª£ng ƒë·∫•t ·ªü theo Lu·∫≠t ƒê·∫•t ƒêai 2024?',
                                                'C√°ch t√≠nh gi√° ƒë·∫•t theo b·∫£ng gi√° 2026 t·∫°i ƒê√† N·∫µng?',
                                                'Th·ªß t·ª•c t√°ch th·ª≠a ƒë·∫•t theo quy ƒë·ªãnh m·ªõi?',
                                                'ƒê·∫•t n√¥ng nghi·ªáp c√≥ ƒë∆∞·ª£c chuy·ªÉn sang ƒë·∫•t ·ªü kh√¥ng?'
                                            ].map((q, i) => (
                                                <button
                                                    key={i}
                                                    onClick={() => setAiQuery(q)}
                                                    className="text-left p-3 bg-white border border-slate-200 rounded-lg hover:border-purple-300 hover:bg-purple-50 transition-all text-sm"
                                                >
                                                    {q}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* AI Response */}
                                    {aiResponse && (
                                        <div className="bg-gradient-to-br from-blue-50 to-cyan-50 p-5 rounded-2xl border border-blue-100 animate-slide-up">
                                            <div className="flex items-center gap-2 mb-3">
                                                <Icons.Brain className="w-5 h-5 text-blue-600" />
                                                <span className="text-xs font-bold text-blue-600 uppercase">Tr·∫£ l·ªùi t·ª´ AI</span>
                                            </div>
                                            <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{aiResponse}</p>
                                        </div>
                                    )}
                                    
                                    {/* NotebookLM Integration Placeholder */}
                                    {!aiResponse && (
                                        <div className="text-center py-8 text-slate-400">
                                            <Icons.MessageSquare className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                            <p className="text-sm">Nh·∫≠p c√¢u h·ªèi ƒë·ªÉ b·∫Øt ƒë·∫ßu t∆∞ v·∫•n</p>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t border-slate-100 bg-slate-50">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={aiQuery}
                                            onChange={(e) => setAiQuery(e.target.value)}
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && aiQuery.trim()) {
                                                    handleAIQuery();
                                                }
                                            }}
                                            placeholder="H·ªèi v·ªÅ Lu·∫≠t ƒê·∫•t ƒêai, gi√° ƒë·∫•t..."
                                            className="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        />
                                        <button
                                            onClick={handleAIQuery}
                                            className="px-6 py-3 rounded-xl font-bold text-white transition-all active:scale-95"
                                            style={{background: 'linear-gradient(135deg, #8b5cf6, #6366f1)'}}
                                        >
                                            G·ª≠i
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Street View Modal */}
                    {showStreetView && (selectedListing || selected) && (() => {
                        const coords = selectedListing?.coordinates || selected?.coordinates;
                        return (
                            <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                                <div className="w-full max-w-4xl bg-white rounded-3xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                                    <div className="flex items-center justify-between px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-amber-50 to-orange-50">
                                        <div className="flex items-center gap-2">
                                            <Icons.Eye className="w-6 h-6 text-amber-600" />
                                            <h3 className="text-lg font-black text-slate-900">Street View - Xem th·ª±c t·∫ø</h3>
                                        </div>
                                        <button 
                                            onClick={() => setShowStreetView(false)} 
                                            className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"
                                        >
                                            <Icons.X />
                                        </button>
                                    </div>
                                    
                                    <div className="flex-1 relative bg-slate-100">
                                        <iframe
                                            width="100%"
                                            height="100%"
                                            style={{ border: 0, minHeight: '500px' }}
                                            loading="lazy"
                                            allowFullScreen
                                            referrerPolicy="no-referrer-when-downgrade"
                                            src={`https://www.google.com/maps/embed/v1/streetview?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&location=${coords[1]},${coords[0]}&heading=0&pitch=0&fov=90`}
                                        ></iframe>
                                    </div>
                                    
                                    <div className="p-4 bg-slate-50 border-t border-slate-100">
                                        <p className="text-sm text-slate-600 text-center">
                                            üìç T·ªça ƒë·ªô: {coords[1].toFixed(6)}, {coords[0].toFixed(6)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>