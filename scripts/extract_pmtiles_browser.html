<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PMTiles Data Extractor</title>
  <script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
  <script type="module">
    import { Protocol } from 'https://unpkg.com/pmtiles@4.0.0/dist/index.js';

    const PMTILES_URL = 'https://xemgiadat.com/tiles/danang_parcels_final.pmtiles';
    const SOURCE_LAYER = 'default';
    
    async function extractData() {
      console.log('Starting PMTiles data extraction...');
      
      // Set up PMTiles protocol
      const protocol = new Protocol();
      maplibregl.addProtocol('pmtiles', (params, callback) => {
        return protocol.tile(params, callback);
      });
      
      // Create a hidden map
      const container = document.createElement('div');
      container.style.width = '100px';
      container.style.height = '100px';
      container.style.position = 'absolute';
      container.style.top = '-1000px';
      document.body.appendChild(container);
      
      const map = new maplibregl.Map({
        container: container,
        style: {
          version: 8,
          sources: {
            'parcels': {
              type: 'vector',
              url: `pmtiles://${PMTILES_URL}`,
              minzoom: 10,
              maxzoom: 20
            }
          },
          layers: []
        },
        center: [108.2022, 16.0544],
        zoom: 15
      });
      
      return new Promise((resolve, reject) => {
        map.on('load', () => {
          console.log('Map loaded, extracting features...');
          
          // Wait for tiles to load
          setTimeout(() => {
            try {
              const features = map.querySourceFeatures('parcels', {
                sourceLayer: SOURCE_LAYER
              });
              
              console.log(`Found ${features.length} features`);
              
              const index = {};
              let processed = 0;
              
              for (const feature of features) {
                const props = feature.properties || {};
                
                // Extract parcel ID
                const soTo = String(props.SoHieuToBanDo || props['Số hiệu tờ bản đồ'] || props.so_to || '').trim();
                const soThua = String(props.SoThuTuThua || props['Số thửa'] || props.so_thua || '').trim();
                
                if (!soTo || !soThua) continue;
                
                const key = `${soTo}:${soThua}`;
                
                // Calculate centroid
                let centroid = [108.2022, 16.0544];
                if (feature.geometry && feature.geometry.type === 'Polygon') {
                  const coords = feature.geometry.coordinates[0];
                  if (coords && coords.length > 0) {
                    let sumLng = 0, sumLat = 0, count = 0;
                    for (const c of coords) {
                      sumLng += c[0];
                      sumLat += c[1];
                      count++;
                    }
                    if (count > 0) {
                      centroid = [
                        Math.round(sumLng / count * 1000000) / 1000000,
                        Math.round(sumLat / count * 1000000) / 1000000
                      ];
                    }
                  }
                }
                
                index[key] = centroid;
                processed++;
              }
              
              console.log(`Processed ${processed} parcels`);
              
              const result = {
                version: '2.0',
                generated: new Date().toISOString(),
                total_parcels: processed,
                index: index
              };
              
              resolve(result);
            } catch (err) {
              reject(err);
            }
          }, 5000); // Wait 5 seconds for tiles to load
        });
        
        map.on('error', (e) => {
          console.error('Map error:', e);
          reject(e);
        });
      });
    }
    
    // Run extraction and download result
    extractData().then(data => {
      console.log('Extraction complete!');
      console.log('Total parcels:', data.total_parcels);
      
      // Create download link
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'search_index.json';
      a.textContent = 'Download search_index.json';
      a.style.fontSize = '24px';
      a.style.padding = '20px';
      a.style.display = 'block';
      document.body.appendChild(a);
      
      // Also log to console for copy-paste
      console.log('JSON Output (first 100 chars):');
      console.log(JSON.stringify(data, null, 2).substring(0, 100) + '...');
    }).catch(err => {
      console.error('Extraction failed:', err);
      document.body.innerHTML = '<h1>Error: ' + err.message + '</h1>';
    });
  </script>
</head>
<body>
  <h1>Extracting data from PMTiles...</h1>
  <p>Check console for progress. Download link will appear when complete.</p>
</body>
</html>
